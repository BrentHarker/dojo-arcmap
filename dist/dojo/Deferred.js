//>>built
define(["./has","./_base/lang","./errors/CancelError","./promise/Promise","require"],function(v,w,r,t,p){var u=Object.freeze||function(){},m=function(b,a,c,d,e){for(e=0;e<b.length;e++)q(b[e],a,c,d)},q=function(b,a,c,d){d=b[a];var e=b.deferred;if(d)try{var f=d(c);0===a?"undefined"!==typeof f&&h(e,a,f):f&&"function"===typeof f.then?(b.cancel=f.cancel,f.then(n(e,1),n(e,2),n(e,0))):h(e,1,f)}catch(g){h(e,2,g)}else h(e,a,c)},n=function(b,a){return function(c){h(b,a,c)}},h=function(b,a,c){if(!b.isCanceled())switch(a){case 0:b.progress(c);
break;case 1:b.resolve(c);break;case 2:b.reject(c)}},l=function(b){var a=this.promise=new t,c=this,d,e,f=!1,g=[];this.isResolved=a.isResolved=function(){return 1===d};this.isRejected=a.isRejected=function(){return 2===d};this.isFulfilled=a.isFulfilled=function(){return!!d};this.isCanceled=a.isCanceled=function(){return f};this.progress=function(e,b){if(d){if(!0===b)throw Error("This deferred has already been fulfilled.");return a}m(g,0,e,null,c);return a};this.resolve=function(b,f){if(d){if(!0===
f)throw Error("This deferred has already been fulfilled.");return a}m(g,d=1,e=b,null,c);g=null;return a};var h=this.reject=function(b,f){if(d){if(!0===f)throw Error("This deferred has already been fulfilled.");return a}m(g,d=2,e=b,void 0,c);g=null;return a};this.then=a.then=function(b,c,f){var k=[f,b,c];k.cancel=a.cancel;k.deferred=new l(function(a){return k.cancel&&k.cancel(a)});d&&!g?q(k,d,e,void 0):g.push(k);return k.deferred.promise};this.cancel=a.cancel=function(a,c){if(!d){b&&(c=b(a),a="undefined"===
typeof c?a:c);f=!0;if(!d)return"undefined"===typeof a&&(a=new r),h(a),a;if(2===d&&e===a)return a}else if(!0===c)throw Error("This deferred has already been fulfilled.");};u(a)};l.prototype.toString=function(){return"[object Deferred]"};p&&p(l);return l});