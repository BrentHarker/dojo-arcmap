//>>built
define("../Widget ../../core/Accessor ../../core/Error ../../core/HandleRegistry ../../core/lang ../../core/urlUtils ../../core/promiseUtils ../../core/watchUtils ../../request ../../tasks/support/StatisticDefinition ../../tasks/support/Query ../../tasks/QueryTask ../../renderers/support/arcadeUtils dojo/_base/lang dojo/promise/all dojo/i18n!dojo/cldr/nls/number dojox/html/entities".split(" "),function(F,G,z,H,h,I,u,A,B,J,C,K,x,q,y,D,L){var M=/\'/g,N=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,E=
/^\s*expression\//i,O=/(\{([^\{\r\n]+)\})/g,r={attachments:"attachments",fields:"fields",media:"media",text:"text"},v={"short-date":"(datePattern: 'M/d/y', selector: 'date')","short-date-le":"(datePattern: 'd/M/y', selector: 'date')","long-month-day-year":"(datePattern: 'MMMM d, y', selector: 'date')","day-short-month-year":"(datePattern: 'd MMM y', selector: 'date')","long-date":"(datePattern: 'EEEE, MMMM d, y', selector: 'date')","short-date-short-time":"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')",
"short-date-le-short-time":"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-short-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')","short-date-le-short-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')","short-date-long-time":"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-le-long-time":"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')",
"short-date-long-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')","short-date-le-long-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')","long-month-year":"(datePattern: 'MMMM y', selector: 'date')","short-month-year":"(datePattern: 'MMM y', selector: 'date')",year:"(datePattern: 'y', selector: 'date')"};return G.createSubclass({declaredClass:"esri.widgets.Popup.PopupRendererViewModel",properties:{content:{readOnly:!0},contentEnabled:!0,
contentTypes:{readOnly:!0},formattedAttributes:{readOnly:!0},graphic:{},title:{readOnly:!0},waitingForContent:{readOnly:!0}},constructor:function(){this._handles=new H},initialize:function(){this._handles.add([A.init(this,"graphic",function(b){this._updateGraphic(b,this.contentEnabled)}.bind(this)),A.init(this,"contentEnabled",function(b){this._updateGraphic(this.graphic,b)}.bind(this))])},destroy:function(){this._handles.destroy();this._handles=null;this._clearRelatedInfo();this._cancelPromises();
this.graphic=null;this._set("title",null);this._set("content",null);this._set("waitingForContent",null)},content:null,contentEnabled:!0,contentTypes:r,formattedAttributes:null,graphic:null,title:"",waitingForContent:!1,_handles:null,_contentPromise:null,_contentElementPromises:null,_relatedRecordsPromise:null,_relatedRecordsQueryPromises:[],_relatedRecordsLayerPromises:[],_relatedLayersInfo:null,_relatedInfo:null,_dateFormats:v,_addValuesToHref:function(b,a,c,e){return a=this._trimString(a),h.substitute((a?
0!==a.indexOf("${"):1)?e:c,b)},_cancelPromises:function(){this._contentElementPromises&&(this._contentElementPromises.forEach(function(b){b.cancel()},this),this._contentElementPromises=null);this._contentPromise&&(this._contentPromise.cancel(),this._contentPromise=null);this._relatedRecordsQueryPromises.forEach(function(b){b.cancel()});this._relatedRecordsQueryPromises.length=0;this._relatedRecordsLayerPromises.length&&(this._relatedRecordsLayerPromises.forEach(function(b){b.cancel()}),this._relatedRecordsLayerPromises.length=
0);this._relatedRecordsPromise&&(this._relatedRecordsPromise.cancel(),this._relatedRecordsPromise=null)},_clearRelatedInfo:function(){this._relatedInfo=this._relatedLayersInfo=null},_compileContent:function(b,a){var c=b.content;if(c&&(c.nodeName||c&&c&&"function"==typeof c.postMixInProperties&&"function"==typeof c.buildRendering&&"function"==typeof c.postCreate&&"function"==typeof c.startup||c&&c.isInstanceOf&&c.isInstanceOf(F)))return c;if("string"==typeof c)return this._compileText(b,{type:r.text,
text:c}).text;if(Array.isArray(c))return c.map(function(c,d){d=(d=a&&a[d])&&d.value;switch(c.type){case r.attachments:return this._proxyAttachments(c,d);case r.fields:return this._compileFields(b,c);case r.media:return this._compileMedia(b,c);case r.text:return this._compileText(b,c)}},this);if(c)try{throw new z(this.declaredClass+"::invalid content type.");}catch(e){console.warn(e.stack)}},_compileFields:function(b,a){a=q.clone(a);var c=(b=b.template)&&b.expressionInfos;b=b&&q.clone(b.fieldInfos);
var e=[];return(a.fieldInfos||b).forEach(function(b){var a=b.fieldName.toLowerCase();if(b.hasOwnProperty("visible")?b.visible:1)a=this._isExpressionField(a)?this._getExpressionInfo(c,a):null,b.label=a?a.title:b.label,e.push(b)},this),a.fieldInfos=e,a},_compileMedia:function(b,a){var c,e;a=q.clone(a);var d=a.mediaInfos,f=b.attributes,g=b.layer,k=this.formattedAttributes.global,n=b.substOptions;return d&&(c=[],d.forEach(function(a){e=0;var d=a.value;switch(a.type){case "image":var l=d.sourceURL,l=l&&
this._trimString(h.substitute(f,this._fixTokens(l,g)));e=!!l;break;case "pie-chart":case "line-chart":case "column-chart":case "bar-chart":var p,l=d.normalizeField;d.fields=d.fields.map(function(a){return p=this._getLayerFieldInfo(g,a),p?p.name:a},this);l&&(p=this._getLayerFieldInfo(g,l),d.normalizeField=p?p.name:l);e=d.fields.some(function(a){return h.isDefined(f[a])||-1!==a.indexOf("relationships/")&&this._relatedInfo},this);break;default:return}if(e){a=q.clone(a);var d=a.value,l=a.title?this._processFieldsInLinks(this._fixTokens(a.title,
g),f):"",m=a.caption?this._processFieldsInLinks(this._fixTokens(a.caption,g),f):"";if(a.title=l?this._trimString(h.substitute(k,l,n)):"",a.caption=m?this._trimString(h.substitute(k,m,n)):"","image"===a.type)d.sourceURL=h.substitute(f,this._fixTokens(d.sourceURL,g)),d.linkURL&&(d.linkURL=this._trimString(h.substitute(f,this._fixTokens(d.linkURL,g))));else{var t,w=(l=b.template)&&l.fieldInfos;d.fields.forEach(function(a,b){if(-1!==a.indexOf("relationships/"))a=this._getRelatedChartInfos(g,w,a,d,f,n),
Array.isArray(a)?d.fields=a:d.fields[b]=a;else{var c=f[a],c=void 0===c?null:c;t=f[d.normalizeField]||0;c&&t&&(c/=t);var e=w&&this._getFieldInfo(w,a);d.fields[b]={y:c,tooltip:(e&&e.label||a)+":"+this._formatValue(c,{fieldInfos:w,fieldName:a,layer:g,substOptions:n,preventPlacesFormatting:!!t})}}},this)}c.push(a)}},this)),a.mediaInfos=c,a},_compileText:function(b,a){if((a=q.clone(a))&&a.text){var c=b.attributes,e=this.formattedAttributes.global,d=b.substOptions;b=this._processFieldsInLinks(this._fixTokens(a.text,
b.layer),c);a.text=this._trimString(h.substitute(e,b,d))}return a},_compileTitle:function(b){var a="",c=b.title,e=b.layer,d=b.attributes,f=b.substOptions,g=this.formattedAttributes.global;c&&("function"==typeof c&&(c=c.call(null,{graphic:b.graphic})),"string"==typeof c)&&-1===c.indexOf("{relationships/")&&(b=this._processFieldsInLinks(this._fixTokens(c,e),d),a=this._trimString(h.substitute(g,b,f)));return a},_getExpressionInfo:function(b,a){if(this._isExpressionField(a)){a=a.replace(E,"");a=a.toLowerCase();
var c;return b.some(function(b){return b.name.toLowerCase()===a&&(c=b),!!c}),c}},_createGraphicInfo:function(b,a){var c=b.getEffectivePopupTemplate(),e=c&&c.title,d=c&&c.content,f=b.layer,g=f&&f._getDateOpts&&f._getDateOpts().properties,k=q.clone(b.attributes)||{};return{graphic:b,template:c,title:e,content:d,contentEnabled:a,layer:f,attributes:k,properties:g,substOptions:{dateFormat:{properties:g,formatter:"DateFormat"+v["short-date-short-time"]}}}},_fixTokens:function(b,a){return b.replace(O,function(b,
e,d){return(b=this._getLayerFieldInfo(a,d))?"{"+b.name+"}":e}.bind(this))},_encodeAttributes:function(b){var a=q.clone(b)||{};return Object.keys(a).forEach(function(b){var c=a[b];"string"==typeof c&&(c=encodeURIComponent(c).replace(M,"\x26apos;"),a[b]=c)}),a},_formatAttributesToFieldInfos:function(b,a,c,e,d){b.forEach(function(f){var g=f.fieldName,k=this._getLayerFieldInfo(a,g);k&&(g=f.fieldName=k.name);if(d[g]=this._formatValue(d[g],{fieldInfos:b,fieldName:g,layer:a,substOptions:c}),e&&f.format&&
f.format.dateFormat)f=e.indexOf(g),-1<f&&e.splice(f,1)},this)},_formatAttributes:function(b,a,c,e,d,f,g,k){var n=q.clone(d);if(g&&g.forEach(function(a){var b="expression/"+a.name;a=k[a.name];a=x.executeFunction(a&&a.compiledFunc,x.createExecContext(f));"string"==typeof a&&(a=L.encode(a));n[b]=a}),this._relatedInfo&&Object.keys(this._relatedInfo).forEach(function(a){var b=this._relatedInfo[a];a=this._relatedLayersInfo[a];b&&(b.relatedFeatures.forEach(this._relatedFeaturesAttributes.bind(this,a,d,n)),
b.relatedStatsFeatures.forEach(this._relatedStatsAttributes.bind(this,a,d,n)))},this),b&&this._formatAttributesToFieldInfos(b,a,c,e,n),a){var m=a.typeIdField;Object.keys(d).forEach(function(b){if(-1===b.indexOf("relationships/")){var c=d[b];if(h.isDefined(c)){var e=this._getDomainName(a,f,b,c);h.isDefined(e)?n[b]=e:b===m&&(c=this._getTypeName(a,f,c),h.isDefined(c)&&(n[b]=c))}}},this)}return n},_formatValue:function(b,a){var c=a.fieldInfos,e=a.fieldName,d=a.substOptions,c=c&&this._getFieldInfo(c,e),
f=q.clone(c),c=a.preventPlacesFormatting;(a=this._getLayerFieldInfo(a.layer,e))&&"date"===a.type&&(a=f.format||{},a.dateFormat=a.dateFormat||"short-date-short-time",f.format=a);a=f&&f.format;e="number"==typeof b&&d.dateFormat.properties&&-1===d.dateFormat.properties.indexOf(e)&&(!a||!a.dateFormat);if(!h.isDefined(b)||!f||!h.isDefined(a))return e?this._forceLTR(b):b;var g="",k=[],f=a.hasOwnProperty("places")||a.hasOwnProperty("digitSeparator"),n=a.hasOwnProperty("digitSeparator")?a.digitSeparator:
!0;if(f)g="NumberFormat",h.isDefined(a.places)&&(!c||0<a.places)&&(k.push("places: "+Number(a.places)),g+="("+k.join(",")+")");else{if(!a.dateFormat)return e?this._forceLTR(b):b;g="DateFormat"+v[a.dateFormat]||v["short-date-short-time"]}b=h.substitute({myKey:b},"{myKey:"+g+"}",d)||"";return f&&!n&&D.group&&(b=b.replace(new RegExp("\\"+D.group,"g"),"")),e?this._forceLTR(b):b},_forceLTR:function(b){return"\x26lrm;"+b},_getDomainName:function(b,a,c,e){return(b=b.getDomain&&b.getDomain(c,{feature:a}))&&
b.codedValues?b.getName(e):null},_getFieldInfo:function(b,a){var c;a=a.toLowerCase();for(var e=0;e<b.length;e++){var d=b[e];if(d.fieldName&&d.fieldName.toLowerCase()===a){c=d;break}}return c},_getLayerFieldInfo:function(b,a){return a&&b&&b.getField?b.getField(a):null},_getTypeName:function(b,a){return(b=b.getType&&b.getType(a))&&b.name},_processFieldsInLinks:function(b,a){var c=this._encodeAttributes(a);return b&&(b=b.replace(N,function(b,d){return this._addValuesToHref(b,d,a,c)}.bind(this))),b},
_proxyAttachments:function(b,a){b=q.clone(b);a&&!(a instanceof z)&&a.attachmentInfos&&a.attachmentInfos.length&&(a=a.attachmentInfos.map(function(a){return a.url=I.addProxy(a.url),a},this),b.attachmentInfos=a);return b},_queryAttachments:function(b){var a=b.layer;if(!a)return u.resolve();"scene"===a.type&&a.companionFeatureLayer&&(a=a.companionFeatureLayer);var c=b.attributes;b=a&&a.objectIdField;c=c&&b&&c[b];return b&&a.get("capabilities.data.supportsAttachment")&&c?this._queryAttachmentInfos(a,
c):void 0},_queryAttachmentInfos:function(b,a){var c=b.url+"/"+b.layerId+"/"+a+"/attachments",e=b.token||"";return B(c,{query:{f:"json",token:e},callbackParamName:"callback"}).then(function(b){b=b.data;return b.attachmentInfos.forEach(function(b){b.url=c+"/"+b.id;e&&(b.url+="?token\x3d"+e);b.objectId=a}),b})},_queryContentElements:function(b){var a=b.content;if(!Array.isArray(a))return u.resolve();var c=[],e={};return a.forEach(function(a,f){a.type===r.attachments&&(a=this._queryAttachments(b))&&
(e[f]=a,c.push(a))},this),this._contentElementPromises=c,0===c.length?u.resolve():u.eachAlways(e).always(function(a){return this._contentElementPromises=null,a}.bind(this))},_trimString:function(b){return(b||"").trim()},_getContent:function(b){var a=b.template,a=a&&a.content;return"function"==typeof a&&(a=a.call(null,{graphic:b.graphic})),a&&"function"==typeof a.then?a:u.resolve(a)},_updateContent:function(b){if(!b.contentEnabled)return u.resolve();var a=this._getContent(b).then(function(a){return b.content=
a,this._queryContentElements(b)}.bind(this)).then(function(a){this._set("content",this._compileContent(b,a))}.bind(this)).otherwise(function(a){}.bind(this)).then(function(){this._contentPromise=null}.bind(this));return this._contentPromise=a,a},_isExpressionField:function(b){return E.test(b)},_compileExpressions:function(b){if(b){var a={};return b.forEach(function(b){a[b.name]={compiledFunc:x.createFunction(b.expression)}}),a}},_createFormattedAttributes:function(b){var a=b.graphic,c=b.attributes,
e=b.layer,d=b.template,f=d&&d.fieldInfos,g=d&&d.expressionInfos,k=this._compileExpressions(g),n=b.substOptions,m=b.properties,h={global:this._formatAttributes(f,e,n,m,c,a,g,k),content:[]};b=d&&d.content;return Array.isArray(b)&&b.forEach(function(b,d){b.type===r.fields&&b.fieldInfos&&(h.content[d]=this._formatAttributes(b.fieldInfos,e,n,m,c,a,g,k))},this),h},_queryGraphicInfo:function(b,a){var c=this._createGraphicInfo(b,a);return this._checkForRelatedRecords(c).then(function(){return this._set("formattedAttributes",
this._createFormattedAttributes(c)),this._set("title",this._compileTitle(c)),this._updateContent(c)}.bind(this))},_updateGraphic:function(b,a){this._handles&&(this._clearRelatedInfo(),this._cancelPromises(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null),this._set("waitingForContent",!1),b)&&(this._set("waitingForContent",!0),this._relatedRecordsPromise=this._queryGraphicInfo(b,a).always(function(){this._relatedRecordsPromise=null;this._relatedRecordsLayerPromises.length=
0;this._relatedRecordsQueryPromises.length=0;this._set("waitingForContent",!1)}.bind(this)))},_getAllFieldInfos:function(b){var a=[],c=b.template,e=c&&c.fieldInfos;b=b.contentEnabled;if(e&&(a=a.concat(e)),b)c=c&&c.content,Array.isArray(c)&&c.forEach(function(b){a=a.concat(b&&b.fieldInfos)},this);return a},_checkForRelatedRecords:function(b){var a=this._getAllFieldInfos(b).filter(function(a){return a&&a.fieldName&&-1!==a.fieldName.indexOf("relationships/")},this);return b.layer&&a&&0<a.length?this._getRelatedRecords({graphic:b.graphic,
fieldsInfo:a}):u.resolve()},_relatedFeaturesAttributes:function(b,a,c,e){Object.keys(e.attributes).forEach(function(d){if("esriRelCardinalityOneToOne"===b.relation.cardinality){var f=this._toRelatedFieldName([b.relation.id,d]);a[f]=c[f]=e.attributes[d]}},this)},_relatedStatsAttributes:function(b,a,c,e){Object.keys(e.attributes).forEach(function(d){var f=this._toRelatedFieldName([b.relation.id,d]);a[f]=c[f]=e.attributes[d]},this)},_getRelatedChartInfos:function(b,a,c,e,d,f){var g,k,n,m,h,l,p;return g=
[],p=this._fromRelatedFieldName(c),h=p[0],k=this._relatedInfo[h],l=this._relatedLayersInfo[h],k&&k.relatedFeatures.forEach(function(k){var h,l=k.attributes;Object.keys(l).forEach(function(k){k===p[1]&&((h={},m=l[k],e.normalizeField&&(n=-1!==e.normalizeField.indexOf("relationships/")?l[this._fromRelatedFieldName(e.normalizeField)[1]]:d[e.normalizeField]),m&&n&&(m/=n),e.tooltipField)?-1!==e.tooltipField.indexOf("relationships/")?(k=this._fromRelatedFieldName(e.tooltipField)[1],k=l[k],h.tooltip=k+": "+
this._formatValue(m,{fieldInfos:a,fieldName:k,layer:b,substOptions:f,preventPlacesFormatting:!!n})):((k=this._getLayerFieldInfo(b,c))&&(c=k.name),h.tooltip=c+": "+this._formatValue(m,{fieldInfos:a,fieldName:e.tooltipField,layer:b,substOptions:f,preventPlacesFormatting:!!n})):h.tooltip=m,h.y=m,g.push(h))},this)},this),"esriRelCardinalityOneToMany"===l.relation.cardinality||"esriRelCardinalityManyToMany"===l.relation.cardinality?g:g[0]},_getRelatedRecords:function(b){var a=b.graphic;return this._relatedLayersInfo?
this._queryRelatedLayers(a).then(function(a){return this._setRelatedRecords(a),a}.bind(this)):this._getRelatedLayersInfo(b).then(function(b){return Object.keys(b).forEach(function(a){b[a]&&(this._relatedLayersInfo[a].relatedLayerInfo=b[a].data)},this),this._queryRelatedLayers(a).then(function(a){return this._setRelatedRecords(a),a}.bind(this))}.bind(this))},_getRelatedLayersInfo:function(b){var a,c=b.fieldsInfo,e={};return a=b.graphic.layer,this._relatedLayersInfo||(this._relatedLayersInfo={}),c.forEach(function(b){var c,
d,e,h,m;if(c=this._fromRelatedFieldName(b.fieldName),d=c[0],e=c[1],d)this._relatedLayersInfo[d]||((c=a&&a.relationships)&&c.some(function(a){return a.id==d?(m=a,!0):void 0}),m&&(this._relatedLayersInfo[d]={relation:m,relatedFields:[],outStatistics:[]})),this._relatedLayersInfo[d]&&(this._relatedLayersInfo[d].relatedFields.push(e),b.statisticType&&(h=new J({statisticType:b.statisticType,onStatisticField:e,outStatisticFieldName:e}),this._relatedLayersInfo[d].outStatistics.push(h)))},this),Object.keys(this._relatedLayersInfo).forEach(function(b){var c,
d;this._relatedLayersInfo[b]&&(c=this._relatedLayersInfo[b].relation,d=a.url+"/"+c.relatedTableId,this._relatedLayersInfo[b].relatedLayerUrl=d,e[b]=B(d,{query:{f:"json"},callbackParamName:"callback"}))},this),Object.keys(e).forEach(function(a){this._relatedRecordsLayerPromises.push(e[a])},this),y(e)},_queryRelatedLayers:function(b){var a={};return Object.keys(this._relatedLayersInfo).forEach(function(c){a[c]=this._queryRelatedLayer({graphic:b,relatedInfo:this._relatedLayersInfo[c]})},this),y(a)},
_queryRelatedLayer:function(b){var a,c,e,d,f,g,k,h,m,q,l,p,r,t;return a=b.graphic,c=a.layer,e=c.layerId,p=b.relatedInfo,d=p.relatedLayerInfo,r=p.relatedLayerUrl,t=p.relation,d&&d.relationships&&d.relationships.some(function(a){return a.relatedTableId===parseInt(e,10)?(f=a,!0):void 0}),f&&(d.fields.some(function(a){if(a.name===f.keyField)return g=-1!==["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"].indexOf(a.type)?"number":"string",!0}),q="string"===
g?f.keyField+"\x3d'"+a.attributes[t.keyField]+"'":f.keyField+"\x3d"+a.attributes[t.keyField],k=new C({where:q,outFields:p.relatedFields}),p.outStatistics&&0<p.outStatistics.length&&d.supportsStatistics&&(l=new C({where:k.where,outFields:k.outFields,outStatistics:p.outStatistics})),h=new K({url:r}),m=[h.execute(k)],l&&m.push(h.execute(l))),this._relatedRecordsQueryPromises=this._relatedRecordsQueryPromises.concat(m),y(m)},_setRelatedRecords:function(b){this._relatedInfo=[];Object.keys(b).forEach(function(a){if(b[a]){var c=
b[a];this._relatedInfo[a]={relatedFeatures:c[0].features};h.isDefined(c[1])&&(this._relatedInfo[a].relatedStatsFeatures=c[1].features)}},this)},_fromRelatedFieldName:function(b){return-1!==b.indexOf("relationships/")?b.split("/").slice(1):[]},_toRelatedFieldName:function(b){return b&&0<b.length?"relationships/"+b[0]+"/"+b[1]:""}})});