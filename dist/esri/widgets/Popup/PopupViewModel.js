//>>built
define("../../core/Accessor ../../core/Collection ../../core/Error ../../core/Evented ../../core/HandleRegistry ../../core/promiseUtils ../../core/watchUtils ../../geometry/support/webMercatorUtils ../../geometry/Point ../../support/Action dojo/fx/easing dojo/_base/lang".split(" "),function(n,p,h,q,r,k,f,t,u,v,l,w){function x(a,b){return b.allLayerViews.find(function(b){return b.layer===a})}var m={id:"zoom-to"};return n.createSubclass([q],{declaredClass:"esri.widgets.Popup.PopupViewModel",properties:{actions:{type:p.ofType(v)},
animationOptions:{},content:{},featureCount:{readOnly:!0},features:{},location:{type:u},pendingPromisesCount:{readOnly:!0},promises:{},selectedFeature:{readOnly:!0},selectedFeatureIndex:{},state:{dependsOn:["view.ready"],readOnly:!0},title:{},updateLocationEnabled:{},view:{},visible:{},waitingForResult:{dependsOn:["pendingPromisesCount","featureCount"],readOnly:!0},zoomFactor:{},zoomScale:{readOnly:!0}},_handles:null,constructor:function(){this._handles=new r},getDefaults:function(a){return w.mixin(this.inherited(arguments),
{actions:[m],animationOptions:{duration:300,easing:l.quadInOut},promises:[]})},initialize:function(){this._handles.add([f.init(this,"view.scale",this._scaleWatcher),f.whenFalse(this,"visible",this._visibleWatcher)])},destroy:function(){this._handles.destroy();this.view=this._handles=null},actions:[m],animationOptions:{duration:300,easing:l.quadInOut},content:null,featureCount:0,features:null,_featuresSetter:function(a){this._set("features",a);this._updateFeatureCount(a);this.pendingPromisesCount||
(this.selectedFeatureIndex=-1,a.length&&(this.selectedFeatureIndex=0))},highlightEnabled:!0,_highlightEnabledSetter:function(a){this._set("highlightEnabled",a);this._highlightFeature(this.selectedFeature,this.view)},location:null,_locationSetter:function(a){var b=this.get("view.spatialReference.isWebMercator");a&&a.get("spatialReference.isWGS84")&&b&&(a=t.geographicToWebMercator(a));this._set("location",a)},pendingPromisesCount:0,waitingForResult:!1,_waitingForResultGetter:function(){return 0<this.pendingPromisesCount&&
0===this.featureCount},promises:[],_promisesSetter:function(a){var b=this._get("promises");b&&b.forEach(function(a){a.cancel()});this.features=[];this._set("pendingPromisesCount",0);this._set("promises",a);a&&a.length&&(this._set("pendingPromisesCount",a.length),a=a.slice(0),a.forEach(function(a){a.always(function(b){a.isCanceled()||(this._set("pendingPromisesCount",this.pendingPromisesCount-1),this._updateFeatures(a,b))}.bind(this))},this))},selectedFeature:null,selectedFeatureIndex:-1,_selectedFeatureIndexSetter:function(a){(isNaN(a)||
-1>a)&&(a=-1);var b=null,c=this.features;c&&c.length&&(a=(a+c.length)%c.length,b=c[a]);this._set("selectedFeature",b);this._set("selectedFeatureIndex",a);this._selectedFeatureChange(b,this.updateLocationEnabled)},state:"disabled",_stateGetter:function(){return this.get("view.ready")?"ready":"disabled"},title:null,updateLocationEnabled:!1,_updateLocationEnabledSetter:function(a){this._selectedFeatureChange(this.selectedFeature,a);this._set("updateLocationEnabled",a)},view:null,visible:!1,zoomFactor:4,
_zoomFactorSetter:function(a){var b=this.view;b&&null!=b.scale&&this._setZoomScale(b.scale,a);this._set("zoomFactor",a)},zoomScale:0,centerAtLocation:function(){return this.location&&this.view?this.view.goTo({target:this.location,scale:this.view.scale},this.animationOptions):k.reject(new h(this.declaredClass+"::Cannot center at location without a location and view."))},clear:function(){this.set({promises:[],features:[],content:null,title:null,location:null})},triggerAction:function(a){(a=this.actions.getItemAt(a))&&
this.emit("trigger-action",{action:a})},next:function(){return this.selectedFeatureIndex+=1,this},previous:function(){return--this.selectedFeatureIndex,this},zoomToLocation:function(){var a=this.view,b=this.location,c=this.zoomScale;if(!b||!a)return k.reject(new h(this.declaredClass+"::Cannot zoom to location without a location and view."));var d,e=this.selectedFeature,g=e&&e.geometry,f=e&&"3d"===a.type;return g||f?(d={target:e},g&&"point"===g.type&&this._isScreenSize(e)&&(d.scale=c,this.location=
g)):d={target:b,scale:c},a.goTo(d,this.animationOptions)},_isScreenSize:function(a){if("3d"!==this.view.type||"esri.Graphic"!==a.declaredClass)return!0;var b=!0,c=this.view.getViewForGraphic(a);return c&&c.whenGraphicBounds&&c.whenGraphicBounds(a).then(function(a){b=!a||a[0]===a[3]&&a[1]===a[4]&&a[2]===a[5]}),b},_getSelectedFeatureActions:function(){this._originalActions&&(this.actions=this._originalActions,this._originalActions=null);var a=this.actions.filter(function(a){return!a.temporary},this),
b=a,c=this.selectedFeature.getEffectivePopupTemplate();if(c&&c.actions){for(var d=c.actions,e=0;e<d.length;e++)d.getItemAt(e).temporary=!0;c.overwriteActions?(this._originalActions=a,b=d):b=a.concat(d)}this.actions=b},_scaleWatcher:function(a){null!=a&&this._setZoomScale(a,this.zoomFactor)},_getPointFromGeometry:function(a){switch(a&&a.type){case "point":return a;case "extent":return a.center;case "polygon":return a.centroid;case "multipoint":case "polyline":return a.extent.center;default:return null}},
_visibleWatcher:function(a){this._handles.remove("highlight")},_highlightFeature:function(a,b){if(this._handles.remove("highlight"),a&&b&&this.highlightEnabled){var c=a.layer,d=b.type;c&&"3d"===d&&(b=x(c,b))&&"function"==typeof b.highlight&&(c=c.objectIdField,d=a.attributes,a=b.highlight(d&&d[c]||a),this._handles.add(a,"highlight"))}},_selectedFeatureChange:function(a,b){this._highlightFeature(a,this.view);a&&(b&&(this.location=this._getPointFromGeometry(this.selectedFeature.geometry)),this._getSelectedFeatureActions())},
_updateFeatureCount:function(a){var b=0;a&&a.length&&(b=a.length);this._set("featureCount",b)},_setZoomScale:function(a,b){this._set("zoomScale",a/b)},_updateFeatures:function(a,b){a&&this.promises&&!(!this._validatePromise(a)||b instanceof h||b instanceof Error)&&b&&b.length&&(a={},this.features&&this.features.length?(b=b.filter(function(a){return-1===this.features.indexOf(a)},this),a.features=this.features.concat(b)):(a.features=b,a.selectedFeatureIndex=0),this.set(a))},_validatePromise:function(a){return-1<
this.promises.indexOf(a)}})});