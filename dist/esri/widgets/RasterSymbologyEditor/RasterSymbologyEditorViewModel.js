//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/accessorSupport/decorators ../../core/Accessor dojo/_base/lang ../../layers/support/RasterFunction ../../core/colorUtils ../../core/promiseUtils dojo/i18n!./nls/RasterSymbologyEditor".split(" "),function(g,A,v,q,r,w,x,m,u,y,z){g=e=function(g){function d(){var a=null!==g&&g.apply(this,arguments)||this;return a.renderParameters={},a.stretchTypes=[{name:"none",filterType:0},{name:"minMax",
filterType:5},{name:"percentClip",filterType:6},{name:"standardDeviation",filterType:3}],a._cachedKeyProperties={},a._defaultRenderParameters={minPercent:2,maxPercent:2,discreteNColors:256,uniqueValuesColorRampId:"uniqueValueColorRamp_default",uniqueValueColorRampType:"multipart",colorRamp:"blackToWhite_predefined",numberOfStandardDeviations:2,gamma:1.1,dra:!0,uniqueValueField:"Value",selectedBand:0},a}return v(d,g),d.prototype.getSymbologyTypes=function(){var a=[e.SymbologyTypes.none,e.SymbologyTypes.stretch],
b=this.layer,c=b.bandCount,f=b.hasRasterAttributeTable,b=b.pixelType;return 3<=c&&a.push(e.SymbologyTypes.rgb),f&&1===c&&a.push(e.SymbologyTypes.uniqueValue),1===c&&b&&"u8"===b.toLowerCase()&&a.push(e.SymbologyTypes.discrete),a},d.prototype.isStretchColorRampApplicable=function(a){return a!==this.getStretchFilterType(e.StretchTypeNames.none)||this.layer.pixelType&&"u8"===this.layer.pixelType.toLowerCase()},d.prototype.getStretchFilterType=function(a){var b=0;return this.stretchTypes.some(function(c){return c.name===
a?(b=c.filterType,!0):void 0}),b},d.prototype.getDefaultRenderParameters=function(){var a={},b=this.layer;if(this.layer){var c,f,l=this._getRenderingRuleArguments("stretch")||{},d=this._getRenderingRuleArguments("colormap")||{},h={},g=this.layer.pixelType&&"u8"!==this.layer.pixelType.toLowerCase()?e.StretchTypeNames.minMax:e.StretchTypeNames.none;return this.stretchTypes.some(function(a){return a.name===g?(f=a.filterType,!0):void 0}),a.symbologyType=this._getDefaultSymbologyType(),a.selectedBand=
this._defaultRenderParameters.selectedBand,a.stretchType=l.stretchType||f,a.minPercent=l.MinPercent||this._defaultRenderParameters.minPercent,a.maxPercent=l.MaxPercent||this._defaultRenderParameters.maxPercent,a.numberOfStandardDeviations=l.NumberOfStandardDeviations||this._defaultRenderParameters.numberOfStandardDeviations,a.gamma=l.Gamma||this._defaultRenderParameters.gamma,a.dra=l.DRA||this._defaultRenderParameters.dra,a.colorRamp=d.colorRamp||this._defaultRenderParameters.colorRamp,b.bandIds&&
(a.bandIds=b.bandIds),b.hasRasterAttributeTable&&b.rasterAttributeTable&&b.rasterAttributeTable.features&&b.rasterAttributeTable.features.length&&b.rasterAttributeTable.features[0].attributes.Red&&b.rasterAttributeTable.features[0].attributes.Green&&b.rasterAttributeTable.features[0].attributes.Blue&&(h.id=this._defaultRenderParameters.uniqueValuesColorRampId,h.type=this._defaultRenderParameters.uniqueValueColorRampType,h.colorRamps=[],b.rasterAttributeTable.features.forEach(function(a){c=a.attributes;
h.colorRamps.push({fromColor:[c.Red,c.Green,c.Blue],toColor:[c.Red,c.Green,c.Blue]})}),a.uniqueValuesColorRamp=h,a.uniqueValuesField=b.rasterAttributeTable.features[0].attributes.Value?this._defaultRenderParameters.uniqueValueField:null),b.bandCount&&1===b.bandCount&&b.pixelType&&"u8"===b.pixelType.toLowerCase()&&(a.discreteNColors=this._defaultRenderParameters.discreteNColors,a.discreteColorRamp=this._defaultRenderParameters.colorRamp),a}},d.prototype.getUniqueValueFields=function(){return this.layer.hasRasterAttributeTable&&
this.layer.rasterAttributeTable&&this.layer.rasterAttributeTable.fields&&this.layer.rasterAttributeTable.fields.length?this.layer.rasterAttributeTable.fields.filter(function(a){return"esriFieldTypeOID"!==a.type?!0:void 0}):void 0},d.prototype.getBandData=function(){var a=this;if(this.layer){var b,c,f=this.layer.bandCount,l=this.layer.id;return!this._cachedKeyProperties[l]&&1<f?this.layer.fetchKeyProperties().then(function(f){return a._cachedKeyProperties[l]=f,b=a._createBandLists(),c=a._getBandCombinationPresets(),
{presets:c,lists:b}}):(b=this._createBandLists(),c=this._getBandCombinationPresets(),y.resolve({lists:b,presets:c}))}},d.prototype.getUniqueValueGridData=function(a,b){var c=this;if(this.layer.hasRasterAttributeTable&&this.layer.rasterAttributeTable&&a&&b){for(var f=this.layer.rasterAttributeTable.features,l=a.colorRamps?a.colorRamps.length:1,d=[],h=[],f=this._sortFeatures(f,b),e,g,p,t,m,k=b=0,k=0;l>k;k++)d[k]={},d[k].start=b,d[k].end=b+1/l,b=d[k].end;return f.forEach(function(b,l){t=(l+.5)/f.length;
d.forEach(function(f,l){t>=f.start&&t<f.end&&(m=(t-f.start)/(f.end-f.start),1<d.length?(e=c._getColorRGB(a.colorRamps[l].fromColor),g=c._getColorRGB(a.colorRamps[l].toColor)):(e=c._getColorRGB(a.fromColor),g=c._getColorRGB(a.toColor)),p=c._interpolateLab(e,g,m),h.push({esriRasterSymbologyEditorUniqueValueSymbol:c._correctRgbLimits(p),esriRasterSymbologyEditorUniqueValueValue:b.value,pixelValues:b.pixelValues,id:l+1}))})}),h}},d.prototype.updateRendering=function(a){a.symbologyType&&(a.symbologyType===
e.SymbologyTypes.none?this._clearRendering():a.symbologyType===e.SymbologyTypes.stretch?this._applyStretchSingleBand(a):a.symbologyType===e.SymbologyTypes.rgb?this._applyStretchRgb(a):(a.symbologyType===e.SymbologyTypes.uniqueValue||a.symbologyType===e.SymbologyTypes.discrete)&&this._applyColormap(a))},d.prototype._sortFeatures=function(a,b){if(a&&b){a=x.clone(a);var c=[];return a.sort(function(a,c){return"string"==typeof a.attributes[b]?a.attributes[b]<c.attributes[b]?-1:1:a.attributes[b]-c.attributes[b]}),
a.forEach(function(f,d){0<d&&f.attributes[b]===a[d-1].attributes[b]?c[c.length-1].pixelValues.push(f.attributes.Value):c.push({value:f.attributes[b],pixelValues:[f.attributes.Value]})}),c}},d.prototype._getDefaultSymbologyType=function(){if(this.layer&&this.layer.renderingRule&&this.layer.renderingRule.functionName){var a=this.layer.renderingRule,b=a.functionName,a=a.functionArguments;return b.toLowerCase()===e.RenderingRuleTypeNames.extractband||b.toLowerCase()===e.RenderingRuleTypeNames.stretch&&
this.layer.bandCount&&1===this.layer.bandCount||b.toLowerCase()===e.RenderingRuleTypeNames.colormap&&a&&a.colorRamp&&this.layer.bandCount&&1===this.layer.bandCount?e.SymbologyTypes.stretch:3<=this.layer.bandCount&&b.toLowerCase()===e.RenderingRuleTypeNames.stretch?e.SymbologyTypes.rgb:e.SymbologyTypes.none}return e.SymbologyTypes.none},d.prototype._getRenderingRuleArguments=function(a){if(this.layer&&this.layer.renderingRule&&a){var b=this.layer.renderingRule;return b.functionName&&b.functionName.toLowerCase()===
a?b.functionArguments:b.functionArguments&&b.functionArguments.Raster&&b.functionArguments.Raster.functionName&&b.functionArguments.Raster.functionName===a?b.functionArguments.Raster.functionArguments:null}},d.prototype._getBandCombinationPresets=function(){var a=this._cachedKeyProperties[this.layer.id];if(a){var b;return e.bandCombinationPresets.forEach(function(c){return c.bandDefinitionKeyword===a.BandDefinitionKeyword?(b=c.presets,!0):void 0}),b?b:void 0}},d.prototype._validateProps=function(a){return null===
a.stretchType||void 0===a.stretchType||6===a.stretchType&&(isNaN(a.minPercent)||isNaN(a.maxPercent))||3===a.stretchType&&isNaN(a.numberOfStandardDeviations)?!1:((!a.noData||isNaN(a.noData))&&(a.noData=0),this.renderParameters=a,!0)},d.prototype._clearRendering=function(){this.layer.bandIds=null;this.layer.noData=null;this.layer.renderingRule=null},d.prototype._applyStretchSingleBand=function(a){if(this._validateProps(a)){this.layer.noData=a.noData;this.layer.bandIds=null;var b=this._getStretchRasterFunctionArguments(a,
1);if(1<this.layer.bandCount){var c={BandIDs:[a.selectedBand]},f=new m;f.functionArguments=c;f.functionName="ExtractBand";b.Raster=f}c=new m;(c.functionName="Stretch",c.functionArguments=b,a.colorRampName&&"none"!==a.colorRampName)?(b=new m,b.functionName="Colormap",b.functionArguments={colorRamp:a.colorRampName,Raster:c},this.layer.renderingRule=b):this.layer.renderingRule=c}},d.prototype._applyStretchRgb=function(a){if(this._validateProps(a)){this.layer.noData=a.noData;this.layer.bandIds=a.bandIds;
a=this._getStretchRasterFunctionArguments(a,3);var b=new m;b.functionName="Stretch";b.functionArguments=a;this.layer.renderingRule=b}},d.prototype._getStretchRasterFunctionArguments=function(a,b){var c={DRA:a.dra,StretchType:a.stretchType,useGamma:!0};return 0!==a.stretchType&&(c.MinPercent=a.minPercent,c.MaxPercent=a.maxPercent,1===b?c.Gamma=[a.gamma]:3===b&&(c.Gamma=[a.gamma,a.gamma,a.gamma]),c.NumberOfStandardDeviations=a.numberOfStandardDeviations),c},d.prototype._getDiscreteColormap=function(a,
b){var c=this;if(a&&b){var f,d,e,h,g,n;n=a.colorRamps?a.colorRamps.length:1;for(var p=[],m=[],r=[],k=0,q=0,k=0;n>k;k++)p[k]={},p[k].start=q,p[k].end=q+1/n,q=p[k].end;for(k=0;b>k;k++)h=(k+.5)/b,p.forEach(function(b,l){h>=b.start&&h<b.end&&(g=(h-b.start)/(b.end-b.start),1<p.length?(f=c._getColorRGB(a.colorRamps[l].fromColor),d=c._getColorRGB(a.colorRamps[l].toColor)):(f=c._getColorRGB(a.fromColor),d=c._getColorRGB(a.toColor)),e=c._interpolateLab(f,d,g),r.push(e))});for(k=0;256>k;k++)n=r[k%b],m.push([k,
n.r,n.g,n.b]);return m}},d.prototype._getColorRGB=function(a){return{r:a[0],g:a[1],b:a[2]}},d.prototype._applyColormap=function(a){var b=new m;b.functionName="Colormap";b.functionArguments={};a.symbologyType===e.SymbologyTypes.uniqueValue?b.functionArguments.Colormap=this._getUniqueValuesColormap(a.uniqueValuesSymbolData):a.symbologyType===e.SymbologyTypes.discrete&&(b.functionArguments.Colormap=this._getDiscreteColormap(a.discreteColorRamp,a.discreteNColors));b.variableName="Raster";this.layer.noData=
a.noData;this.layer.renderingRule=b},d.prototype._getUniqueValuesColormap=function(a){var b=[];return a.forEach(function(a){a.pixelValues.forEach(function(c){b.push([c,a.esriRasterSymbologyEditorUniqueValueSymbol.r,a.esriRasterSymbologyEditorUniqueValueSymbol.g,a.esriRasterSymbologyEditorUniqueValueSymbol.b])})}),b},d.prototype._createBandLists=function(){var a=this;if(this.layer){var b,c=this.layer.id,f=this.layer.bandCount,d=this._cachedKeyProperties[c],e=this.layer.bandIds||[0,1,2],h=[],g=["red",
"green","blue"];return d&&d.BandProperties&&0<d.BandProperties.length&&(b=d.BandProperties),e.forEach(function(c,d){b&&b[0].hasOwnProperty("BandName")?h.push(a._getBandIdList(f,b,a._getBandIndex(b,g[d]))):h.push(a._getBandIdList(f,b,c))}),this._cachedKeyProperties[c]=d,h}},d.prototype._getBandIndex=function(a,b){if(!this.layer||!a)return 0;var c;for(c=0;c<a.length;c++)if(a[c]&&a[c].hasOwnProperty("BandName")&&a[c].BandName.toLowerCase()===b)return c;return 0},d.prototype._getBandIdList=function(a,
b,c){if(this.layer){var d=[],e={},g=!1;b&&a===b.length&&(g=!0);var h;for(h=0;a>h;h++){var m=h.toString(),n=h.toString(),m=g&&b[h]&&b[h].BandName?b[h].BandName:z.bandPrefix+"_"+(h+1),e={};c===h&&(e.selected=!0);e.name=m;e.index=n;d.push(e)}return d}},d.prototype._interpolateLab=function(a,b,c){a=u.toLAB(a);b=u.toLAB(b);return u.toRGB({l:a.l*(1-c)+c*b.l,a:a.a*(1-c)+c*b.a,b:a.b*(1-c)+c*b.b})},d.prototype._correctRgbLimits=function(a){var b=[a.r,a.g,a.b];return b.forEach(function(a,d){0>b[d]?b[d]=0:255<
b[d]&&(b[d]=255);b[d]=Math.floor(b[d])}),{r:b[0],g:b[1],b:b[2]}},d}(r.declared(w));g.bandCombinationPresets=[{bandDefinitionKeyword:"LandsatTM",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]},{LandWater:[7,5,4]},{Vegetation:[5,4,3]}]},{bandDefinitionKeyword:"Landsat 8",presets:[{NaturalColor:[4,3,2]},{ColorInfrared:[5,4,3]},{Landuse:[5,4,2]},{LandWater:[7,6,5]},{Vegetation:[6,5,4]},{ShallowBathymetric:[3,2,1]}]},{bandDefinitionKeyword:"IKONOS",presets:[{NaturalColor:[3,2,
1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"QuickBird",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"Pleiades",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"GeoEye",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"OrbView",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"LandsatMSS",
presets:[{ColorInfrared:[4,3,2]}]},{bandDefinitionKeyword:"SPOT6",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"FORMOSTAT",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"SPOT1",presets:[{ColorInfrared:[1,2,3]},{Vegetation:[2,3,4]}]},{bandDefinitionKeyword:"WorldView",presets:[{NaturalColor:[5,3,2]},{ColorInfrared:[7,5,3]},{Landuse:[7,5,2]},{LandWater:[8,7,6]},{Vegetation:[7,6,5]},{ShallowBathymetric:[3,
2,1]}]},{bandDefinitionKeyword:"RapidEye",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[5,3,2]},{Landuse:[5,3,1]},{Vegetation:[5,4,3]}]},{bandDefinitionKeyword:"DMCii",presets:[{ColorInfrared:[1,2,3]}]}];g.StretchTypeNames={none:"none",minMax:"minMax",percentClip:"percentClip",standardDeviation:"standardDeviation"};g.RenderingRuleTypeNames={extractband:"extractband",colormap:"colormap",stretch:"stretch"};g.SymbologyTypes={none:"none",stretch:"stretch",rgb:"rgb",uniqueValue:"uniqueValue",discrete:"discrete"};
q([r.property()],g.prototype,"layer",void 0);q([r.property()],g.prototype,"renderParameters",void 0);g=e=q([r.subclass("esri.widgets.RasterSymbologyEditor.RasterSymbologyEditorViewModel")],g);var e;return g});