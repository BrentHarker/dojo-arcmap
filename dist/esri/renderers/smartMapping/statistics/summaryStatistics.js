//>>built
define("require exports dojo/_base/lang ../../../tasks/support/StatisticDefinition ./classBreaks ../../../core/promiseUtils ./support/utils ../support/utils".split(" "),function(D,E,n,t,u,f,d,k){function v(a){if(!(a&&a.layer&&(a.field||a.valueExpression||a.sqlExpression)))return f.reject(d.createError("summary-statistics:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var b=n.mixin({},a);return b.normalizationType=d.getNormalizationType(b),
b.layer=k.createLayerAdapter(b.layer),b.layer?b.layer.load().then(function(){var a=b.layer,e=b.field,p=b.normalizationType,h="function"==typeof e,q=b.valueExpression||b.sqlExpression,g=e?a.getField(e):null,e=g?g.type===l:!1,m=k.getFieldsList({field:b.field,normalizationField:b.normalizationField,valueExpression:b.valueExpression});if(m=d.verifyBasicFieldValidity(a,m,"summary-statistics:invalid-parameters"))return f.reject(m);if(g){if(g=d.verifyFieldType(a,g,"summary-statistics:invalid-parameters",
w))return f.reject(g);if(e&&p)return f.reject(d.createError("summary-statistics:invalid-parameters","Normalization is not allowed for date fields"))}else if(q&&p)return f.reject(d.createError("summary-statistics:invalid-parameters","Normalization is not allowed when 'valueExpression' or 'sqlExpression' is specified"));return a.hasLocalSource||b.features||h?f.reject(d.createError("summary-statistics:not-implemented","Client-side calculation is not implemented yet")):a.supportsSQLExpression||!e&&!q?
b:f.reject(d.createError("summary-statistics:not-supported","Layer does not support standardized SQL expression for queries"))}):f.reject(d.createError("summary-statistics:invalid-parameters","'layer' must be one of these types: "+x))}function y(a){var b=a.normalizationType,c=a.normalizationField;return u({layer:a.layer,field:a.field,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:b,normalizationField:"field"===b?c:void 0,minValue:a.minValue,maxValue:a.maxValue}).then(function(a){var b,
h,c;if(a.classBreakInfos.some(function(a){return a.hasAvg&&(b=a),!!b}),b)c=b.maxValue-b.minValue,h=b.minValue+c/2,c*=4;return{min:a.minValue,max:a.maxValue,avg:h,stddev:c}})}function z(a){var b=a.layer,c=a.field,e=a.sqlExpression||c,c=e?d.getRangeExpr(e,a.minValue,a.maxValue):null;a={sqlFormat:a.sqlExpression?"standard":null,where:d.mergeWhereClauses(a.sqlWhere,c),outStatistics:r.map(function(a){var b=new t;return b.statisticType="variance"===a?"var":a,b.onStatisticField=e,b.outStatisticFieldName=
a+A,b})};return b.queryStatistics(a).then(function(b){b=(b=b&&b.features)&&b[0]&&b[0].attributes;var a={},c;for(c in b)a[c.replace(B,"").toLowerCase()]=b[c];return a.min===a.max&&null!=a.min&&null==a.stddev&&(a.stddev=a.variance=0),a})}function C(a,b){var c,e=a.field,f=a.layer;return f.supportsSQLExpression&&b&&(c=n.mixin({},a),delete c.field,c.sqlExpression=d.msSinceUnixEpochSQL(f,e)),z(c||a).then(function(a){return b&&("min max avg stddev sum variance".split(" ").forEach(function(b){null!=a[b]&&
(a[b]=Math.ceil(a[b]))}),a.min===a.max&&null!=a.min&&(a.avg=a.min,a.stddev=a.variance=0)),a})}var l="date",w=[].concat(["integer","small-integer","single","double"]).concat(l),A="_value",B=/_value$/i,r="min max avg stddev count sum variance".split(" "),x=k.supportedLayerTypes.join(", ");return function(a){return v(a).then(function(a){var b=a.field?a.layer.getField(a.field):null,b=b?b.type===l:!1;return a.normalizationType?y(a):C(a,b)}).then(function(a){for(var b in a)-1<r.indexOf(b)&&(d.isValidNumber(a[b])||
(a[b]=null));return a})}});