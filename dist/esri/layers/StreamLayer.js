//>>built
define("require dojo/_base/lang dojo/Deferred ../core/sniff ../core/Collection ../Graphic ../geometry/SpatialReference ../geometry/Extent ./FeatureLayer".split(" "),function(k,d,h,f,l,m,g,n,p){return p.createSubclass({declaredClass:"esri.layers.StreamLayer",viewModulePaths:{"2d":"../views/2d/layers/StreamLayerView2D","3d":"../views/3d/layers/StreamLayerView3D"},constructor:function(a,b){"WebSocket"in window||(this.loadError=Error("WebSocket is not supported in this browser"),console.log("WebSocket is not supported in this browser. StreamLayer will not have real-time connection with the stream service."))},
normalizeCtorArgs:function(a,b){return"string"==typeof a?d.mixin({},{url:a},b):a&&a.layerDefinition?d.mixin({},{collectionLayer:a},b):(a&&a.filter&&(this._set("filter",this._makeFilter({where:a.filter.where||null,geometry:a.filter.geometry||null})),delete a.filter,delete a.geometryDefinition,delete a.definitionExpression),a)},getDefaults:function(a){return d.mixin(this.inherited(arguments)||{},{purgeOptions:{displayCount:2E3},outFields:["*"]})},properties:{definitionExpression:{value:null,get:function(){return console.warn("StreamLayer.definitionExpression is deprecated. Access the filter.where property"),
this.filter.where},set:function(a){console.warn("StreamLayer.definitionExpression is deprecated. Use the updateFilter method to change the attribute filter");a=this._makeFilter({where:a});this._set("filter",a)}},geometryDefinition:{value:null,get:function(){return console.warn("StreamLayer.geometryDefinition is deprecated. Access the filter.geometry property"),this.filter.geometry},set:function(a){console.warn("StreamLayer.geometryDefinition is deprecated. Use the updateFilter method to change the spatial filter");
a=this._makeFilter({geometry:a});this._set("filter",a)}},filter:{value:{geometry:null,where:null},readOnly:!0},maxReconnectAttempts:10,maximumTrackPoints:1,operationalLayerType:"ArcGISStreamLayer",purgeOptions:{value:null,set:function(a){var b=this._get("purgeOptions"),c={},e=!1;if(a&&"object"==typeof a&&b!==a)return a.hasOwnProperty("displayCount")&&0<a.displayCount&&(c.displayCount=a.displayCount,e=!0),a.hasOwnProperty("age")&&0<=a.age&&(c.age=a.age,e=!0),e?this._set("purgeOptions",c):void 0}},
socketDirection:"subscribe",spatialReference:{value:null,type:g,json:{read:{source:["spatialReference"],reader:function(a){return a&&g.fromJSON(a)}}}},type:{value:"stream",json:{read:!1}}},createGraphicsSource:function(){var a=new h;return k(["./graphics/sources/StreamLayerSource"],d.hitch(this,function(b){var c=new b({layer:this});c.then(d.hitch(this,function(){this.emit("graphics-source-create",{graphicsSource:c});a.resolve(c)}),function(b){a.reject(b)})})),a.promise},createGraphicsController:function(a){var b=
new h,c=a.layerView,e=c.view.map,f=l.ofType(m),e=e.view===c.view?this.graphics:new f,g=d.mixin(a.options||{},{layer:this,layerView:c,graphics:e});return k(["./graphics/controllers/StreamController"],d.hitch(this,function(a){var c=new a(g);c.then(d.hitch(this,function(){this.emit("graphics-controller-create",{graphicsController:c});b.resolve(c)}),function(a){b.reject(a)})})),b.promise},loadFromPortal:function(a){return a=d.mixin(a,{supportedTypes:["Stream Service"]}),this.inherited(arguments,[a])},
updateFilter:function(a){var b=new h;try{var c=this._makeFilter(a);this._set("filter",c);b.resolve({filter:this.filter})}catch(e){b.reject(e)}return b.promise},_initLayerProperties:function(a){this.source=a;var b=this.source.relatedFeaturesInfo;b&&(this.objectIdField=b.joinField,this.source.relatedFeaturesInfo.outFields=this.outFields?this.outFields.splice(0):null);a=a.layerDefinition;if(this.read(a,{origin:"service",url:this.parsedUrl}),b&&b.outFields&&"*"!==b.outFields[0]){var c=b.outFields.map(function(a){return a.toLowerCase()});
(this.requiredFields||[]).forEach(function(a){-1===c.indexOf(a.toLowerCase())&&b.outFields.push(a)})}a._ssl&&(this.url=this.url.replace(this.reHttp,"https:"));this._verifyFields();this._addSymbolUrlTokens();this.useQueryTimestamp=f("ie")||f("safari")},_makeFilter:function(a){if(a){var b,c=a.hasOwnProperty("where")?a.where:this.filter.where;if(a.hasOwnProperty("geometry")){if(b=a.geometry,b&&!b.hasOwnProperty("xmin"))throw console.log("geometry is not an extent: ",b),Error("Cannot set filter. Only Extent is supported for the geometry filter");
b&&!b.declaredClass&&(b=new n(b))}else b=this.filter.geometry;a={where:c,geometry:b}}else a={geometry:null,where:null};return a},_readObjectIdField:function(a){if(a.objectIdField)return a.objectIdField;if(a.fields){a=a.fields;var b=a.find(function(a){return"esriFieldTypeOID"===a.type});if(!b){var b=1,c=[];if(a.forEach(function(a){"objectid"===a.name.split("_")[0]&&c.push(a.name)}),c.length)for(;-1!==c.indexOf("objectid_"+b);)b+=1;b="objectid_"+b}return b}},_verifyFields:function(){var a=this.parsedUrl&&
this.parsedUrl.path||"undefined";this.objectIdField||console.log("StreamLayer: 'objectIdField' property is not defined (url: "+a+")")}})});