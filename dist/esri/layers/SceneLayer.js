//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/accessorSupport/decorators ./Layer ./FeatureLayer ./support/Field ./support/fieldUtils ./support/LabelClass ../symbols/support/ElevationInfo ./support/labelingInfo ./mixins/SceneService ./support/commonProperties ../PopupTemplate ../request ../core/requireUtils ../core/promiseUtils ../core/urlUtils ../core/Error ../core/Logger ../core/accessorSupport/PropertyOrigin ../core/accessorSupport/utils ../renderers/support/jsonUtils ../renderers/support/styleUtils ../portal/PortalItem ../tasks/support/Query dojo/_base/lang dojo/promise/all".split(" "),
function(x,c,y,f,e,z,q,A,n,B,C,r,D,E,t,p,F,h,G,k,H,l,I,J,K,L,M,N,u){function v(c,d,a){return c&&(c=J.read(c,d,a)||void 0,c||m.error("Failed to create renderer",{rendererDefinition:c,layer:this,context:a})),c}var O=["3DObject","Point"],m=H.getLogger("esri.layers.SceneLayer");c=function(c){function d(a,b){a=c.call(this)||this;return a.featureReduction=null,a.operationalLayerType="ArcGISSceneServiceLayer",a.type="scene",a.fields=[],a.definitionExpression=null,a.elevationInfo=null,a.labelsVisible=!1,
a.labelingInfo=null,a.legendEnabled=!0,a.cachedDrawingInfo={color:!1},a.popupEnabled=!0,a.popupTemplate=null,a.objectIdField=null,a.objectIdFilter=null,a._fieldUsageInfo={},a.screenSizePerspectiveEnabled=!0,a}return y(d,c),d.prototype.normalizeCtorArgs=function(a,b){return"string"==typeof a?N.mixin({},{url:a},b):a},d.prototype.getField=function(a){return n.getField(a,this.fields)},Object.defineProperty(d.prototype,"geometryType",{get:function(){return P[this.profile]||"mesh"},enumerable:!0,configurable:!0}),
d.prototype.readLabelsVisible=function(a,b){return b.showLabels},d.prototype.writeLabelsVisible=function(a,b){b.showLabels=!!a},d.prototype.readLegendEnabled=function(a,b){return null!=b.showLegend?b.showLegend:!0},d.prototype.writeLegendEnabled=function(a,b){b.showLegend=!!a},Object.defineProperty(d.prototype,"renderer",{set:function(a){n.fixRendererFields(a,this.fields);this._set("renderer",a)},enumerable:!0,configurable:!0}),d.prototype.readCachedDrawingInfo=function(a,b){return(null==a||"object"!=
typeof a)&&(a={}),null==a.color&&(a.color=!1),a},d.prototype.readPopupEnabled=function(a,b){return null!=b.disablePopup?!b.disablePopup:void 0},d.prototype.writePopupEnabled=function(a,b){a||(b.disablePopup=!0)},d.prototype.readPopupTemplate=function(a,b){return b.popupInfo?t.fromJSON(b.popupInfo):void 0},d.prototype.writePopupTemplate=function(a,b){a&&(b.popupInfo=a.toJSON())},d.prototype.readObjectIdField=function(a,b){return!a&&b.fields&&b.fields.some(function(b){return"esriFieldTypeOID"===b.type&&
(a=b.name),!!a}),a||void 0},d.prototype.readProfile=function(a,b){a=b.store.profile;return null!=a&&w[a]?w[a]:(m.error("Unknown or missing profile",{profile:a,layer:this}),"mesh-pyramids")},d.prototype.readNormalReferenceFrame=function(a,b){return b.store.normalReferenceFrame},d.prototype.load=function(){var a=this,b=this.loadFromPortal({supportedTypes:["Scene Service"]}).always(function(){return a._fetchService()}).then(function(){return u([a._verifyRootNodeAndUpdateExtent(),a._setCompanionFeatureLayer()])}).then(function(){return a._applyCompanionOverrides()}).then(function(){return a._populateFieldUsageInfo()}).then(function(){return K.loadStyleRenderer(a,
{origin:"service"})}).then(function(){return n.fixRendererFields(a.renderer,a.fields)});return this.addResolvingPromise(b),this},d.prototype.createLayerView=function(a){var b,g=this;return b=null==this.profile||"mesh-pyramids"===this.profile?"../views/3d/layers/SceneLayerView3D":"../views/3d/layers/SceneLayerGraphicsView3D",F.when(x,b).then(function(b){return new b({view:a,layer:g})})},d.prototype.createQuery=function(){var a=new M;return"mesh"!==this.geometryType&&(a.returnGeometry=!0,a.returnZ=
!0),a.where=this.definitionExpression||"1\x3d1",a.sqlFormat="standard",a},d.prototype.queryExtent=function(a){var b=this;return this._getCompanionLayerForQuery().then(function(g){return g.queryExtent(a||b.createQuery())})},d.prototype.queryFeatureCount=function(a){var b=this;return this._getCompanionLayerForQuery().then(function(g){return g.queryFeatureCount(a||b.createQuery())})},d.prototype.queryFeatures=function(a){var b=this;return this._getCompanionLayerForQuery().then(function(g){return g.queryFeatures(a||
b.createQuery())}).then(function(a){if(a&&a.features)for(var c=0,g=a.features;c<g.length;c++)g[c].layer=b;return a})},d.prototype.queryObjectIds=function(a){var b=this;return this._getCompanionLayerForQuery().then(function(c){return c.queryObjectIds(a||b.createQuery())})},d.prototype.getFieldUsageInfo=function(a){return this._fieldUsageInfo[a]||{supportsLabelingInfo:!1,supportsRenderer:!1,supportsPopupTemplate:!1,supportsLayerQuery:!1}},d.prototype._getCompanionLayerForQuery=function(){var a=this;
if(!this.loaded)return this.load().then(function(){return a._getCompanionLayerForQuery()});var b=this.companionFeatureLayer;return null!=b?h.resolve(b):h.reject(new k("scenelayer:query-not-available","SceneLayer queries are not available without companion feature layer"))},d.prototype.hasCachedStatistics=function(a){return null!=this.statisticsInfo&&this.statisticsInfo.some(function(b){return b.name===a})},d.prototype.queryCachedStatistics=function(a){if(!this.hasCachedStatistics(a))return h.reject(new k("scenelayer:no-cached-statistics",
"Cached statistics for this attribute are not available"));for(var b=0,c=this.statisticsInfo;b<c.length;b++){var d=c[b];if(d.name===a)return a=G.join(this.parsedUrl.path,d.href),p(a,{query:{f:"json"},responseType:"json"}).then(function(a){return a.data.stats})}},d.prototype.graphicChanged=function(a){this.emit("graphic-update",a)},d.prototype._validateLayer=function(a){if(a.layerType&&-1===O.indexOf(a.layerType))throw new k("scenelayer:layer-type-not-supported","SceneLayer does not support this layer type",
{layerType:a.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor))throw new k("layer:service-version-not-supported","Service version is not supported.",{serviceVersion:this.version.versionString,supportedVersions:"1.x"});if(1<this.version.major)throw new k("layer:service-version-too-new","Service version is too new.",{serviceVersion:this.version.versionString,supportedVersions:"1.x"});a=this.normalReferenceFrame;var b=this.spatialReference,c=!1,d=!1;if(null==a)d=c=!0;else switch(b=
b&&b.isGeographic,a){case "east-north-up":case "earth-centered":c=!0;d=b;break;case "vertex-reference-frame":c=!0;d=!b;break;default:c=!1}if(!c)throw new k("scenelayer:unsupported-normal-reference-frame","Normal reference frame is invalid.");if(!d)throw new k("scenelayer:incompatible-normal-reference-frame","Normal reference frame is incompatible with layer spatial reference.");},d.prototype._populateFieldUsageInfo=function(){if(this._fieldUsageInfo={},this.fields)for(var a=function(a){var c=!(!b.attributeStorageInfo||
!b.attributeStorageInfo.some(function(b){return b.name===a.name})),d=!!(b.companionFeatureLayer&&b.companionFeatureLayer.fields&&b.companionFeatureLayer.fields.some(function(b){return b&&a.name===b.name}));b._fieldUsageInfo[a.name]={supportsLabelingInfo:c,supportsRenderer:c,supportsPopupTemplate:c||d,supportsLayerQuery:d}},b=this,c=0,d=this.fields;c<d.length;c++)a(d[c])},d.prototype._applyCompanionOverrides=function(){if(this.companionFeatureLayer){if(this.companionFeatureLayer.fields)for(var a=0,
b=this.companionFeatureLayer.fields;a<b.length;a++){var c=b[a];this.getField(c.name)||this.fields.push(c.clone())}a=["popupTemplate","popupEnabled"];b=I.getProperties(this);for(c=0;c<a.length;c++){var d=a[c];this._buddyIsMoreImportant(d)&&(b.setDefaultOrigin(this.companionFeatureLayer.originOf(d)),b.set(d,this.companionFeatureLayer[d]),b.setDefaultOrigin("user"))}}},d.prototype._setCompanionFeatureLayer=function(){var a=this;return this._fetchCompanionFeatureLayer().then(function(b){a.companionFeatureLayer=
b})},d.prototype._fetchCompanionFeatureLayer=function(){var a,b=this;return-1===["mesh-pyramids","points"].indexOf(this.profile)?h.resolve(null):(a=this.portalItem&&this.portalItem.isResolved()?this._fetchCompanionFeatureLayerFromRelatedItems(this.portalItem):this._fetchCompanionFeatureLayerFromUrl(),a.then(function(a){return a.load()}).otherwise(function(a){return null==b.attributeStorageInfo?m.warn("Companion FeatureLayer could not be loaded and no binary attributes found. Popups will not work for this SceneLayer: "+
b.title):m.info("Companion FeatureLayer could not be loaded. Falling back to binary attributes for Popups on this SceneLayer: "+b.title),null}))},d.prototype._fetchCompanionFeatureLayerFromRelatedItems=function(a){var b=this;return a.fetchRelatedItems({relationshipType:"Service2Data",direction:"forward"}).then(function(a){return(a=a.filter(function(a){return"Feature Service"===a.type})[0])?b._fetchCompanionFeatureLayerFromPortalItem(new L({id:a.id,portal:a.portal})):h.reject()}).otherwise(function(){return b._fetchCompanionFeatureLayerFromUrl()})},
d.prototype._fetchCompanionFeatureLayerFromPortalItem=function(a){var b=this;return a.load().then(function(a){return b._findMatchingCompanionSublayerUrl(a.url)}).then(function(b){return h.resolve(new q({url:b,portalItem:a}))})},d.prototype._fetchCompanionFeatureLayerFromUrl=function(){return this._findMatchingCompanionSublayerUrl().then(function(a){return h.resolve(new q({url:a}))})},d.prototype._findMatchingCompanionSublayerUrl=function(a){var b=this.parsedUrl.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i);
if(!b)return h.reject();null==a&&(a=b[1]+"/FeatureServer");var c=a.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1");a={query:{f:"json"},responseType:"json"};var d=b[1]+"/SceneServer",e=parseInt(b[2],10),b=p(this._addUrlToken(d),a).otherwise(function(a){return{layers:null}});a=p(this._addUrlToken(c),a);return u([a,b]).then(function(a){var b=a[0];a=a[1];a=a.data&&a.data.layers;b=b.data&&b.data.layers;if(!Array.isArray(b))throw Error("expected layers array");if(Array.isArray(a))for(var d=0;d<Math.min(a.length,
b.length);d++){if(a[d].id===e)return c+"/"+b[d].id}else if(e<b.length)return c+"/"+b[e].id;throw Error("could not find matching companion sublayer");})},d.prototype._buddyIsMoreImportant=function(a){if(!this.companionFeatureLayer)return!1;var b=l.nameToId(this.originOf(a));a=l.nameToId(this.companionFeatureLayer.originOf(a));return null!=a&&a<=l.OriginId.SERVICE?null==b||b<l.OriginId.SERVICE:null!=a&&a<=l.OriginId.PORTAL_ITEM?null==b||b<l.OriginId.PORTAL_ITEM:!1},d}(e.declared(z,D));f([e.shared("esri.layers.SceneLayer")],
c.prototype,"declaredClass",void 0);f([e.property({json:{origins:{webScene:{read:{source:"layerDefinition.featureReduction"},write:{target:"layerDefinition.featureReduction"}}}}})],c.prototype,"featureReduction",void 0);f([e.property()],c.prototype,"companionFeatureLayer",void 0);f([e.property()],c.prototype,"operationalLayerType",void 0);f([e.property({json:{read:!1},readOnly:!0,value:"scene"})],c.prototype,"type",void 0);f([e.property({type:[A]})],c.prototype,"fields",void 0);f([e.property({readOnly:!0})],
c.prototype,"attributeStorageInfo",void 0);f([e.property({readOnly:!0})],c.prototype,"statisticsInfo",void 0);f([e.property({json:{origins:{service:{read:!1,write:!1}},read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}})],c.prototype,"definitionExpression",void 0);f([e.property({type:C,json:{origins:{service:{read:{source:"elevationInfo"},write:{target:"elevationInfo",enabled:!1}}},read:{source:"layerDefinition.elevationInfo"},write:{target:"layerDefinition.elevationInfo"}}})],
c.prototype,"elevationInfo",void 0);f([e.property({type:String,dependsOn:["profile"]})],c.prototype,"geometryType",null);f([e.property({type:Boolean})],c.prototype,"labelsVisible",void 0);f([e.reader("labelsVisible",["showLabels"])],c.prototype,"readLabelsVisible",null);f([e.writer("labelsVisible")],c.prototype,"writeLabelsVisible",null);f([e.property({type:[B],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:r.reader},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",
reader:r.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],c.prototype,"labelingInfo",void 0);f([e.property({type:Boolean})],c.prototype,"legendEnabled",void 0);f([e.reader("legendEnabled",["showLegend"])],c.prototype,"readLegendEnabled",null);f([e.writer("legendEnabled")],c.prototype,"writeLegendEnabled",null);f([e.property({json:{origins:{service:{read:{source:"drawingInfo.renderer",reader:v},write:{target:"drawingInfo.renderer",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.renderer",
reader:v},write:{target:"layerDefinition.drawingInfo.renderer"}},value:null})],c.prototype,"renderer",null);f([e.property({json:{read:!1}})],c.prototype,"cachedDrawingInfo",void 0);f([e.reader("service","cachedDrawingInfo")],c.prototype,"readCachedDrawingInfo",null);f([e.property({type:Boolean})],c.prototype,"popupEnabled",void 0);f([e.reader("popupEnabled",["disablePopup"])],c.prototype,"readPopupEnabled",null);f([e.writer("popupEnabled")],c.prototype,"writePopupEnabled",null);f([e.property({type:t})],
c.prototype,"popupTemplate",void 0);f([e.reader("popupTemplate",["popupInfo"])],c.prototype,"readPopupTemplate",null);f([e.writer("popupTemplate")],c.prototype,"writePopupTemplate",null);f([e.property({type:String,json:{read:!1}})],c.prototype,"objectIdField",void 0);f([e.reader("service","objectIdField",["objectIdField","fields"])],c.prototype,"readObjectIdField",null);f([e.property()],c.prototype,"objectIdFilter",void 0);f([e.property({type:String,json:{read:!1}})],c.prototype,"profile",void 0);
f([e.reader("service","profile",["store.profile"])],c.prototype,"readProfile",null);f([e.property({readOnly:!0,type:String,json:{read:!1}})],c.prototype,"normalReferenceFrame",void 0);f([e.reader("service","normalReferenceFrame",["store.normalReferenceFrame"])],c.prototype,"readNormalReferenceFrame",null);f([e.property(E.screenSizePerspectiveEnabled)],c.prototype,"screenSizePerspectiveEnabled",void 0);c=f([e.subclass()],c);var w={"mesh-pyramids":"mesh-pyramids",meshpyramids:"mesh-pyramids","features-meshes":"mesh-pyramids",
points:"points","features-points":"points",lines:"lines","features-lines":"lines",polygons:"polygons","features-polygons":"polygons"},P={"mesh-pyramids":"mesh",points:"point",lines:"polyline",polygons:"polygon"};return c});