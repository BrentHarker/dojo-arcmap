//>>built
define("../core/kebabDictionary ../core/urlUtils ../geometry/Polygon dojo/_base/lang dojo/dom-construct dojox/gfx/canvas ./Geoprocessor ./support/PrintTemplate ./support/printTaskUtils ./Task".split(" "),function(w,B,C,m,D,x,E,F,q,G){function r(a){return!(!a||!a.path)}var y={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},z=w({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),H=w({MAP_ONLY:"map-only","A3 Landscape":"a3-landscape","A3 Portrait":"a3-portrait","A4 Landscape":"a4-landscape",
"A4 Portrait":"a4-portrait","Letter ANSI A Landscape":"letter-ansi-a-landscape","Letter ANSI A Portrait":"letter-ansi-a-portrait","Tabloid ANSI B Landscape":"tabloid-ansi-b-landscape","Tabloid ANSI B Portrait":"tabloid-ansi-b-portrait"});return G.createSubclass({declaredClass:"esri.tasks.PrintTask",constructor:function(){this._handleExecuteResponse=this._handleExecuteResponse.bind(this)},_vtlExtent:null,_legendLayers:[],_legendLayerNameMap:{},properties:{_geoprocessor:{dependsOn:["url","updateDelay"],
get:function(){return new E(this.url,{updateDelay:this.updateDelay})}},mode:{value:"sync"},url:{value:null,type:String},updateDelay:{value:1E3,type:Number}},execute:function(a,c){a=this._setPrintParams(a);return this._geoprocessor["async"===this.mode?"submitJob":"execute"](a,c).then(this._handleExecuteResponse)},_createOperationalLayers:function(a,c){var g,b,e,h=[],l=a.map.allLayers.items;for(g=0;g<l.length;g++)if(b=l[g],b.loaded&&b.visible)switch(e={id:b.id,title:this._legendLayerNameMap[b.id]||
b.title,opacity:b.opacity,minScale:b.minScale||0,maxScale:b.maxScale||0,url:b.url&&B.normalize(b.url),token:b.token},b.declaredClass){case "esri.layers.ImageryLayer":var d={bandIds:b.bandIds,compressionQuality:b.compressionQuality,format:b.format,interpolation:b.interpolation};b.mosaicRule&&(d.mosaicRule=b.mosaicRule.toJSON());b.renderingRule&&(d.renderingRule=b.renderingRule.toJSON());h.push(m.mixin(e,d));this._legendLayers&&this._legendLayers.push({id:b.id});break;case "esri.layers.OpenStreetMapLayer":m.mixin(e,
{type:"OpenStreetMap"});h.push(e);break;case "esri.layers.GraphicsLayer":m.mixin(e,this._createFeatureCollectionJSON(b));h.push(e);this._legendLayers&&this._legendLayers.push({id:b.id});break;case "esri.layers.VectorTileLayer":e.type="image";e.url&&delete e.url;var k=c.exportOptions&&c.exportOptions.dpi||96,t=c.exportOptions&&c.exportOptions.width%2===a.width%2,f=c.exportOptions&&c.exportOptions.height%2===a.height%2,p={format:"png",pixelRatio:k/96,rotation:0},d=this._vtlExtent||a.extent.clone();
"MAP_ONLY"!==c.layout||!c.preserveScale||c.outScale&&c.outScale!==a.scale||96!==k||t&&f||(p.area={x:0,y:0,width:a.width,height:a.height},t||(p.area.width+=1),f||(p.area.height+=1),this._vtlExtent)||(k=a.toMap({x:p.area.width,y:p.area.height}),d.ymin=k.y,d.xmax=k.x,this._vtlExtent=d);e.extent=d.clone()._normalize(!0).toJSON();d=a.whenLayerView(b);d.isResolved()&&d.then(function(b){b=b.takeScreenshot(p,a);b.isResolved()?b.then(function(a){"data:image/png;base64,"===a.dataURL.substr(0,22)&&(e.imageData=
a.dataURL.substr(22))}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise");e.imageData&&h.push(e)});break;case "esri.layers.MapImageLayer":var n={id:b.id,subLayerIds:[]},u=[],q=a.scale,v=function(a){var b=0===q,c=0===a.minScale||q<=a.minScale,d=0===a.maxScale||q>=a.maxScale;a.visible&&(b||c&&d)&&(a.sublayers?a.sublayers.forEach(v):(b=a.toExportImageJSON().drawingInfo,c=a.toJSON(),c.layerDefinition.drawingInfo=b,u.unshift(c),n.subLayerIds.push(a.id)))};b.sublayers&&
b.sublayers.forEach(v);m.mixin(e,{layers:u});h.push(e);this._legendLayers.push(n);break;case "esri.layers.WMSLayer":u=[];v=function(a){a.visible&&(a.sublayers?a.sublayers.forEach(v):a.name&&u.unshift(a.name))};b.sublayers&&b.sublayers.forEach(v);m.mixin(e,{type:"wms",transparentBackground:b.imageTransparency,visibleLayers:u,version:b.version});h.push(e);break;case "esri.layers.WMTSLayer":d=b.activeLayer;m.mixin(e,{type:"wmts",layer:d.id,style:d.styleId,format:d.imageFormat,tileMatrixSet:d.tileMatrixSetId});
h.push(e);break;case "esri.layers.WebTileLayer":d=b.urlTemplate.replace(/\$\{/g,"{");m.mixin(e,{type:"WebTiledLayer",urlTemplate:d,credits:b.copyright});b.subDomains&&0<b.subDomains.length&&(e.subDomains=b.subDomains);h.push(e);break;case "esri.layers.FeatureLayer":case "esri.layers.CSVLayer":case "esri.layers.StreamLayer":var A;a.whenLayerView(b).then(function(a){return a.queryGraphics&&a.queryGraphics()||a.featuresView.graphics}).then(function(a){A=a.map(function(a){return a.geometry.hasZ=!1,a})});
m.mixin(e,this._createFeatureCollectionJSON(b,A));h.push(e);this._legendLayers&&this._legendLayers.push({id:b.id});break;case "esri.layers.MapNotesLayer":var r=[];b.featureCollections.map(function(a){var b=a.source.toArray();a=this._createFeatureCollectionJSON(a,b).featureCollection;r=r.concat(a.layers)}.bind(this));m.mixin(e,{featureCollection:{layers:r}});h.push(e);break;default:h.push(e)}return h},_createFeatureCollectionJSON:function(a,c){var g=q.createPolygonLayer(),b=q.createPolylineLayer(),
e=q.createPointLayer(),h=q.createMultipointLayer(),l=q.createPointLayer();if(l.layerDefinition.name="textLayer",delete l.layerDefinition.drawingInfo,"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass?g.layerDefinition.name=b.layerDefinition.name=e.layerDefinition.name=h.layerDefinition.name=this._legendLayerNameMap[a.id]||a.get("arcgisProps.title")||a.title:"esri.layers.GraphicsLayer"===a.declaredClass&&(c=a.graphics.items),a.renderer&&!m.isFunction(a.get("renderer.field"))){var d=
a.renderer.toJSON();g.layerDefinition.drawingInfo.renderer=d;b.layerDefinition.drawingInfo.renderer=d;e.layerDefinition.drawingInfo.renderer=d;h.layerDefinition.drawingInfo.renderer=d}else delete g.layerDefinition.drawingInfo,delete b.layerDefinition.drawingInfo,delete e.layerDefinition.drawingInfo,delete h.layerDefinition.drawingInfo;var k=a.fields,d=a.renderer,t=[];d&&!m.isFunction(a.get("renderer.field"))&&("classBreaks"===d.type?(k||(k=[{name:d.field,type:"esriFieldTypeDouble"}],d.normalizationField&&
k.push({name:d.normalizationField,type:"esriFieldTypeDouble"})),d.field&&t.push(d.field),d.normalizationField&&t.push(d.normalizationField)):"uniqueValue"===d.type&&(k||(k=[{name:d.field,type:"esriFieldTypeString"}],d.field2&&k.push({name:d.field2,type:"esriFieldTypeString"}),d.field3&&k.push({name:d.field3,type:"esriFieldTypeString"})),d.field&&t.push(d.field),d.field2&&t.push(d.field2),d.field3&&t.push(d.field3)));k&&(g.layerDefinition.fields=k,b.layerDefinition.fields=k,e.layerDefinition.fields=
k,h.layerDefinition.fields=k);for(var f,k=c&&c.length,p=0;k>p;p++){var n=c[p]||c.getItemAt(p);if(!1!==n.visible&&n.geometry&&(f=n.toJSON(),f.hasOwnProperty("popupTemplate")&&delete f.popupTemplate,f.geometry&&f.geometry.z&&delete f.geometry.z,!f.symbol||!f.symbol.outline||"esriCLS"!==f.symbol.outline.type)){if(f.symbol&&f.symbol.outline&&f.symbol.outline.color&&f.symbol.outline.color[3]&&(f.symbol.outline.color[3]=255),a.renderer&&!f.symbol&&(m.isFunction(a.renderer.field)||a.renderer.compiledFunc||
a.renderer.hasVisualVariables())){var d=a.renderer,u=d.getSymbol(n);if(!u)continue;f.symbol=u.toJSON();d.hasVisualVariables()&&q.applyVisualVariables(f.symbol,{renderer:d,graphic:n,symbol:u})}if(f.symbol&&(f.symbol.angle||delete f.symbol.angle,f.symbol.path?f.symbol=this._convertSvgToPictureMarkerSymbolJson(f.symbol):f.symbol.text&&delete f.attributes),a.renderer&&"simple"===a.renderer.type)delete f.attributes;else if(t.length){var r={};t.forEach(function(a){f.attributes&&f.attributes.hasOwnProperty(a)&&
(r[a]=f.attributes[a])});f.attributes=r}"polygon"===n.geometry.type?g.featureSet.features.push(f):"polyline"===n.geometry.type?b.featureSet.features.push(f):"point"===n.geometry.type?f.symbol&&f.symbol.text?l.featureSet.features.push(f):e.featureSet.features.push(f):"multipoint"===n.geometry.type?h.featureSet.features.push(f):"extent"===n.geometry.type&&(f.geometry=C.fromExtent(n.geometry).toJSON(),g.featureSet.features.push(f))}}a=[g,b,h,e,l].filter(function(a){return 0<a.featureSet.features.length});
return a.forEach(function(a){a.featureSet.features.every(function(a){return a.symbol})&&(a.featureSet.features.forEach(function(a){delete a.attributes}),delete a.layerDefinition.drawingInfo);a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(a.layerDefinition.drawingInfo.renderer)},this),{featureCollection:{layers:a}}},_convertSvgToPictureMarkerSymbolJson:function(a){this._canvasParent||(this._canvasParent=D.create("div"),this._canvasSurface=x.createSurface(this._canvasParent,
200,200));var c=this._canvasSurface.createObject(x.Path,a.path).setFill(a.color).setStroke(a.outline);"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var g=this._canvasSurface.rawNode.getContext("2d"),c=c.getBoundingBox(),b=Math.ceil(c.width+c.x),e=Math.ceil(c.height+c.y),h=g.getImageData(c.x,c.y,b,e);g.canvas.width=b;g.canvas.height=e;g.putImageData(h,0,0);return{type:"esriPMS",imageData:g.canvas.toDataURL("image/png").substr(22),angle:-a.angle,contentType:"image/png",height:a.size?
a.size:e-c.y,width:a.size?a.size:b-c.x,xoffset:a.xoffset,yoffset:a.yoffset}},_convertSvgRenderer:function(a){var c=a.type;if("simple"===c&&r(a.symbol))return void(a.symbol=this._convertSvgToPictureMarkerSymbolJson(a.symbol));if("uniqueValue"===c||"classBreaks"===c)c=a["uniqueValue"===c?"uniqueValueInfos":"classBreakInfos"],r(a.defaultSymbol)&&(a.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(a.defaultSymbol)),c&&c.forEach(function(a){r(a)&&(a.symbol=this._convertSvgToPictureMarkerSymbolJson(a.symbol))},
this)},_getPrintDefinition:function(a,c){var g=a.view,b=g.map,e=g.spatialReference,h={operationalLayers:this._createOperationalLayers(g,c)};a=this._vtlExtent||a.extent||g.extent;return e&&e.isWrappable&&(a=a.clone()._normalize(!0),e=a.spatialReference),h.mapOptions={extent:a&&a.toJSON(),spatialReference:e&&e.toJSON(),showAttribution:c.attributionVisible},this._vtlExtent=null,g.rotation&&(h.mapOptions.rotation=-g.rotation),c.preserveScale&&(h.mapOptions.scale=c.outScale||g.scale),b.timeExtent&&(h.mapOptions.time=
[b.timeExtent.startTime.getTime(),b.timeExtent.endTime.getTime()]),h},_handleExecuteResponse:function(a){return"sync"===this.mode?a.results&&a.results[0]&&a.results[0].value:this._geoprocessor.getResultData(a.jobId,"Output_File").then(function(a){return a.value})},_setPrintParams:function(a){var c=a.template||new F;null==c.showLabels&&(c.showLabels=!0);var g,b=c.exportOptions;if(b){g={dpi:b.dpi};var e=H.toJSON(c.layout);if("map_only"===e.toLowerCase()||""===e)g.outputSize=[b.width,b.height]}var h;
if(b=c.layoutOptions){var l,d;"Miles"===b.scalebarUnit||"Kilometers"===b.scalebarUnit?(l="Kilometers",d="Miles"):("Meters"===b.scalebarUnit||"Feet"===b.scalebarUnit)&&(l="Meters",d="Feet");h={titleText:b.titleText,authorText:b.authorText,copyrightText:b.copyrightText,customTextElements:b.customTextElements,scaleBarOptions:{metricUnit:z.toJSON(l),metricLabel:y[l],nonMetricUnit:z.toJSON(d),nonMetricLabel:y[d]}}}l=null;b&&b.legendLayers&&(l=b.legendLayers.map(function(a){this._legendLayerNameMap[a.layerId]=
a.title;var b={id:a.layerId};return a.subLayerIds&&(b.subLayerIds=a.subLayerIds),b},this));b=this._getPrintDefinition(a,c);a.outSpatialReference&&(b.mapOptions.spatialReference=a.outSpatialReference.toJSON());m.mixin(b,{exportOptions:g,layoutOptions:h});m.mixin(b.layoutOptions,{legendOptions:{operationalLayers:null!=l?l:this._legendLayers}});c={Web_Map_as_JSON:JSON.stringify(b),Format:c.format,Layout_Template:e};return a.extraParameters&&m.mixin(c,a.extraParameters),c}})});