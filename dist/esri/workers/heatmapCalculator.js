//>>built
!function(g,u){function v(a){var c=a.data,f=c.action;a=c.msgId;f&&a&&("initialize"==f?(t=new g.HeatmapCalculator(c),postMessage({msgId:a})):"calculate"==f&&(c=t.calculateImageData(c),postMessage({msgId:a,imageData:c},c)))}if("function"==typeof define&&define.amd?define([],u):g.HeatmapCalculator=u(),g.importScripts&&"function"==typeof g.importScripts){var t;g.addEventListener("message",v,!1)}}(this,function(){function g(a){a=a||{};this.radius=a.blurRadius||10;this.maxVal=a.maxPixelIntensity;this.minVal=
a.minPixelIntensity;this.field=a.field;this.fieldOffset=a.fieldOffset;this.width=a.width;this.height=a.height;this.gradient=a.gradient;this.stats=null}function u(a,c){for(var f=Array(a),b=0;a>b;b++)for(var d=f[b]=Array(c),h=0;c>h;h++)d[h]=0;return f}function v(a,c){return a-c}var t=window.ArrayBuffer?!0:!1;return g.prototype.calculateImageData=function(a){var c=this.radius=a.blurRadius||this.blurRadius;this.maxVal=null!=a.maxPixelIntensity?a.maxPixelIntensity:this.maxPixelIntensity;this.minVal=null!=
a.minPixelIntensity?a.minPixelIntensity:this.minPixelIntensity;var f=this.field="field"in a?a.field:this.field,b=this.fieldOffset="fieldOffset"in a?a.fieldOffset:this.fieldOffset,d=a.screenPoints,h=a.gradient;if(h)this.gradient=h;else{if(!this.gradient)return!1;h=this.gradient}var e=a.features,k=a.mapinfo;d||(e&&k?d=this.screenPoints=this._calculateScreenPoints(e,k):!k&&this.screenPoints&&(e=!0,a.width&&a.width!=this.width&&(e=!1,this.width=a.width),a.height&&a.height!=this.height&&(e=!1,this.height=
a.height),e?d=this.screenPoints:this.screenPoints=null));if(!d)return!1;e=k.width||a.width||this.width;a=k.height||a.height||this.height;c=this._calculateIntensityMatrix(d,e,a,c,f,b);this._lastMatrix=c.matrix;this._maxIntVal=c.max;return this._createImageData(e,a,this._lastMatrix,h)},g.prototype._calculateScreenPoints=function(a,c){var f=c.resolution,b=c.width,d=c.height;c=c.extent;var h=[];if(!c)return!1;f||(f=d?Math.abs(c[3]-c[1])/d:Math.abs(c[2]-c[0])/b);b=0;for(d=a.length;d>b;b++){var e=a[b];
h[b]={x:Math.round((e.geometry.x-c[0])/f),y:Math.round((c[3]-e.geometry.y)/f),attributes:e.attributes}}return h},g.prototype._calculateIntensityMatrix=function(a,c,f,b,d,h){var e,k=u(f,c),p=Math.round(4.5*b),l=b*b,m=[],g=2*p+1,n=-1,q=1,x=-(1/0);h=h||0;for(d=function(a){return"function"==typeof a?a:a?"abs"==h?function(b){return-1*+b.attributes[a]}:function(b){return+b.attributes[a]+h}:function(){return 1}}(d);++n<g;)m[n]=Math.exp(-Math.pow(n-p,2)/(2*l))/Math.sqrt(2*Math.PI)*(b/2);for(n=0;n<a.length;n++){var r=
a[n];b=r.x-p;for(var l=r.y-p,g=b,t=l,q=+d(r),v=Math.min(r.y+p,f-1),r=Math.min(r.x+p,c-1);v>=l;){for(var y=m[l-t];r>=b;)-1<b&&-1<l&&(e=k[l][b]+=y*m[b-g]*q,e>x&&(x=e)),b++;l++;b=g}}return{matrix:k,max:x}},g.prototype._createImageData=function(a,c,f,b){if(!t)return this._createPixelData(a,c,f,b);var d=new Uint32Array(a*c);b=b.buffer?new Uint32Array(b.buffer):new Uint32Array((new Uint8Array(b)).buffer);for(var h=this.minVal,e=b.length/(this.maxVal-h),k=0;c>k;k++)for(var g=f[k],l=0;a>l;l++){var m=Math.floor((g[l]-
h)*e);d[k*a+l]=0>m?b[0]:m<b.length?b[m]:b[b.length-1]}return d},g.prototype._createPixelData=function(a,c,f,b){for(var d=Array(a*c*4),h=this.minVal,e=b.length/4/(this.maxVal-h),k=3,g=0;c>g;g++)for(var l=f[g],m=0;a>m;m++){var w=4*(g*a+m)+3,n=4*Math.floor((l[m]-h)*e)+3;3>n?n=3:n>b.length-1&&(n=b.length-1);for(k=4;k--;)d[w-k]=b[n-k]}return d},g.calculateStats=function(a,c){if(!a)return!1;for(var f,b,d,h,e,k=a.length,g=0,l=0,m=0,w=0,n=1/0,q=-(1/0);k--;)for(d=a[k],f=d.length;f--;)e=d[f],c&&!c(e)||(h||
(h=e),b=e-h,w+=e,g+=b,l+=b*b,n>e&&(n=e),e>q&&(q=e),m++);return 0<m?{mean:w/m,stdDev:Math.sqrt((l-g*g/m)/m),min:n,max:q,mid:(q-n)/2}:{mean:0,stdDev:0,min:0,max:0,mid:0}},g.getBinnedValues=function(a){function c(a,b,c){for(var d=[];b>a;a+=c)d.push(a);return d}a=a||{};var f=a.stats,b=a.min,d=a.max,h=a.bins,e=a.count,g=a.size;a=a.values;if(!a)return!1;if(f&&null!=f.max&&null!=f.min&&(b=f.min,d=f.max),!h)if(g){if(null==b&&(b=0),null==d){if(null==e)return!1;d=b+e*g}h=c(b,d,g)}else if(e){if(f&&null!=f.min&&
null!=f.max?(b=f.min,d=f.max):null!=d&&0<d&&null==b&&(b=0),null==b||null==d)return!1;h=c(b,d,(d-b)/e)}for(var e=h.length,p,l=u(e,0),m=a.length;m--;)for(b=a[m],f=b.length;f--;){d=b[f];for(g=1;e>g&&(p=h[g],!(p>d));g++);l[g-1].push(d)}return l.map(function(a){return a.sort(v)})},g.getHistogramData=function(a){a=a||{};var c=a.binnedData,f=a.stats,b=a.byStdDev,d=a.matrix;a=a.binOptions||{};if(!(c||d&&(a.values=d,b&&(f||(f=g.calculateStats(d)),a.size=f.stdDev),a.stats=f,c=g.getBinnedValues(a),c)))return!1;
var h,e;if(a.bins)d=a.bins;else for(d=[],b=0;b<c.length;b++)e=c[b],d.push(e[0]);a=[];for(b=0;b<d.length-1;b++)e=d[b],a[b]={range:[e,d[b+1]],count:e.length};return f?h=f.max:(e=c[b],h=e[e.length-1]),e=d[b],a[b]={range:[e,h],count:e.length},a},g});