//>>built
define("require exports ./core/tsSupport/declareExtendsHelper ./core/tsSupport/decorateHelper ./Basemap ./Map ./Viewpoint ./core/Error ./core/JSONSupport ./core/Loadable ./core/promiseUtils ./core/requireUtils ./core/Logger ./geometry/SpatialReference ./geometry/support/webMercatorUtils ./portal/Portal ./portal/PortalItem ./portal/support/geometryServiceUtils ./tasks/support/ProjectParameters ./webmap/InitialViewProperties ./core/accessorSupport/decorators dojo/_base/lang".split(" "),function(p,c,
q,f,r,t,u,g,v,w,k,x,y,z,A,n,B,C,D,l,e,E){var F=y.getLogger("esri.WebMap");c=m=function(c){function d(a){a=c.call(this)||this;return a.applicationProperties=null,a.authoringApp=null,a.authoringAppVersion=null,a.bookmarks=null,a.initialViewProperties=null,a.portalItem=null,a.presentation=null,a.sourceVersion=null,a.tables=null,a.widgets=null,a}return q(d,c),d.prototype.initialize=function(){if(this.otherwise(function(a){F.error("#load()","Failed to load web map",a)}),this.resourceInfo){var a=void 0;
try{a=this._validateJSON(this.resourceInfo)}catch(b){return void this.addResolvingPromise(k.reject(b))}this.read(a)}},d.prototype.readBasemap=function(a,b,h){if(!b.baseMap||!Array.isArray(b.baseMap.baseMapLayers)||!b.baseMap.baseMapLayers.length)return null;a=b.baseMap;b=new r;return b.resourceInfo=a,b.read(a,{origin:"web-map",portal:h&&h.portal}),b},d.prototype.readInitialViewProperties=function(a,b){a={};return b.spatialReference&&(a.spatialReference=z.fromJSON(b.spatialReference)),new l(a)},d.prototype.readSourceVersion=
function(a,b){a=b.version.split(".");b=a[1];return{major:parseInt(a[0],10),minor:parseInt(b,10)}},d.prototype.load=function(){return this.addResolvingPromise(this._loadFromSource()),this},d.prototype.toJSON=function(){throw new g("internal:not-yet-implemented","WebMap.toJSON is not yet implemented");},d.fromJSON=function(a){if(!a)return null;if(a.declaredClass)throw Error("JSON object is already hydrated");return new m({resourceInfo:a})},d.prototype._loadFromSource=function(){return this.resourceInfo?
this._loadFromJSON(this.resourceInfo,{origin:"web-map"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):k.resolve(null)},d.prototype._loadFromItem=function(a){var b=this;return a.load().otherwise(function(a){throw new g("webmap:load-portal-item","Failed to load portal item",{error:a});}).then(function(){if("Web Map"!==a.type)throw new g("webmap:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Map'",{type:a.type});}).then(function(){return a.fetchData()}).then(function(h){return b.resourceInfo=
h,b._readAndLoadFromJSON(h,{origin:"web-map",portal:a.portal||n.getDefault()})}).then(function(){return b._getInitialExtent()}).then(function(a){if(a){var c=b.initialViewProperties?b.initialViewProperties.clone():new l;c.viewpoint=new u;c.viewpoint.targetGeometry=a;b.initialViewProperties=c}})},d.prototype._readAndLoadFromJSON=function(a,b){a=this._validateJSON(a);return this.read(a,b),this._loadFromJSON(a,b)},d.prototype._validateJSON=function(a){a=this._sanitizeJSON(a);var b=this._validateVersion(a.version);
return a.version=b.major+"."+b.minor,a},d.prototype._sanitizeJSON=function(a){return{authoringApp:a.authoringApp||"",authoringAppVersion:a.authoringAppVersion||"",applicationProperties:a.applicationProperties,baseMap:a.baseMap,bookmarks:a.bookmarks,operationalLayers:a.operationalLayers,presentation:a.presentation,spatialReference:a.spatialReference,tables:a.tables,version:a.version||"0.0",widgets:a.widgets}},d.prototype._validateVersion=function(a){var b=a.split("."),c=b[0],b=b[1],d=/^\s*\d+\s*$/;
if(!d.test(c))throw new g("webmap:invalid-version","Expected major version to be a number, but got '"+a+"'",{version:a});if(!d.test(b))throw new g("webmap:invalid-version","Expected minor version to be a number, but got '"+a+"'",{version:a});c=parseInt(c,10);b=parseInt(b,10);if(2!==c)throw new g("webmap:unsupported-version","Required major version is '2', but got '"+c+"'",{version:a});return{major:c,minor:b}},d.prototype._loadFromJSON=function(a,b){var c=this,d={context:E.mixin({},b,{layerContainerType:"operational-layers"})};
return this.portalItem&&(d.context.portal=this.portalItem.portal||n.getDefault()),x.when(p,"./portal/support/layersCreator").then(function(b){var e=[],f=a.operationalLayers;return f&&f.length&&e.push.apply(e,b.populateOperationalLayers(c.layers,f,d)),k.eachAlways(e).then(function(){})})},d.prototype._getInitialExtent=function(){var a=null,b=this.initialViewProperties&&this.initialViewProperties.spatialReference,c=this.portalItem&&this.portalItem.extent;if(b&&c)if(b.isWGS84)a=c.clone();else{if(!b.isWebMercator)return C.create(this.portalItem).then(function(a){var d=
new D;return d.geometries=[c],d.outSR=b,a.project(d)}).then(function(a){return a[0]}).otherwise(function(a){return console.log("Error projecting item's extent:",a),null});a=A.geographicToWebMercator(c)}return k.resolve(a)},d}(e.declared(t,w,v));f([e.property()],c.prototype,"applicationProperties",void 0);f([e.property()],c.prototype,"authoringApp",void 0);f([e.property()],c.prototype,"authoringAppVersion",void 0);f([e.reader("basemap",["baseMap"])],c.prototype,"readBasemap",null);f([e.property()],
c.prototype,"bookmarks",void 0);f([e.property({type:l})],c.prototype,"initialViewProperties",void 0);f([e.reader("initialViewProperties",["spatialReference"])],c.prototype,"readInitialViewProperties",null);f([e.property({type:B})],c.prototype,"portalItem",void 0);f([e.property()],c.prototype,"presentation",void 0);f([e.property()],c.prototype,"resourceInfo",void 0);f([e.property({readOnly:!0})],c.prototype,"sourceVersion",void 0);f([e.reader("sourceVersion",["version"])],c.prototype,"readSourceVersion",
null);f([e.property()],c.prototype,"tables",void 0);f([e.property()],c.prototype,"widgets",void 0);c=m=f([e.subclass("esri.WebMap")],c);var m;return c});