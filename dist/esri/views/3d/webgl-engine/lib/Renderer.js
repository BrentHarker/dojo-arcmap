//>>built
define("require exports ./IntervalUtilities ./ModelDirtyTypesTs ./Float32ArrayList ./InstanceBufferData ../lighting/SceneLighting ../materials/internal/SimpleGLMaterial ./LinearDepthTextureHelper ./NormalTextureHelper ./HighlightTextureHelper ./RenderPass ./RenderSlot ./RenderContext ./ExternalRendererContainer ./StencilRenderingHelper ./Util ./gl-matrix ./ComponentUtils ../../../webgl/Texture ../../../webgl/VertexArrayObject ../../../webgl/BufferObject ../../../webgl/Util ./FxaaRenderPass ./SmaaRenderPass ../../../webgl/enums ./DefaultVertexAttributeLocations ../../../webgl/Profiling".split(" "),
function(T,oa,U,pa,V,ca,da,W,ea,fa,ga,A,p,ha,ia,ja,G,Q,N,X,O,R,F,ka,la,qa,S,ma){var D=G.assert,Y=G.objectEmpty,K=G.getFirstObjectValue,P=G.setMatrixTranslation3;T=Q.vec2d;var Z=Q.vec4d,C=Q.mat4d,aa=G.VertexAttrConstants,M=C.identity();G=function(){function e(a,b,d,c,f){this._lighting=new da.SceneLighting;this._mat2dataMerged={};this._mat2dataInstanced={};this._renderOrder=[];this._externalRenderers=new ia;this._renderContext=new ha;this._framesRendered=0;this._isRendering=!1;this._highlights=[];this._pixelRatio=
1;this._threshold=1535;this._needsRender=!0;this._fallbackDepthStencilTexture=null;this._stats=new na;this.ssaoEnabled=!1;this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1};this._programRep=a;this._materialRep=b;this._textureRep=d;this._orderedRendering=f;this._rctx=c;b=c.gl;this._fxaaPass=new ka(c);this._smaaPass=new la(c);this._selectionMaterial=new W(a,Z.createFrom(.1,.2,.9,.4),b.EQUAL);this._selectionMaterialLines=new W(a,Z.createFrom(.1,.2,.9,.4),b.EQUAL,b.LINES);this._renderContext.lightingData=
this._lighting.getOld();c.setDepthTestEnabled(!0);c.setFaceCullingEnabled(!0);c.setBlendingEnabled(!1);c.setBlendFunctionSeparate(770,771,1,771);this._bindParameters={view:null,proj:null,viewInvTransp:null,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,instanceParameters:null,depthFBO:null,normalFBO:null,extensions:{angleInstancedArrays:c.extensions.angleInstancedArrays}};this._linearDepthTextureHelper=new ea(c);
this._normalTextureHelper=new fa(c);this._highlightTextureHelper=new ga(c);this._stencilRenderingHelper=new ja(c);this._initializeFramebufferTexture()}return e.prototype._initializeFramebufferTexture=function(){var a=this._rctx.gl,a=this._rctx.contextAttributes.alpha?a.RGBA:a.RGB,b=new X(this._rctx,{target:3553,pixelFormat:a,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:a,texture:b}},e.prototype.dispose=function(){for(var a in this._mat2dataMerged){this._releaseMaterials(a);
var b=this._mat2dataMerged[a],d;for(d in b.origin2data)b.origin2data[d].vao.dispose(!0)}this._mat2dataMerged=null;for(a in this._mat2dataInstanced)for(d in this._releaseMaterials(a),b=this._mat2dataInstanced[a],b.origin2data)b.origin2data[d].vao.dispose(!0);this._mat2dataInstanced=null;this._framebuffer.texture.dispose();this._framebuffer.texture=null;this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable();this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable();
this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1);this._stencilRenderingHelper.getEnableState()&&this._stencilRenderingHelper.setEnableState(!1);this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null)},e.prototype.setLighting=function(a){this._lighting.set(a)},e.prototype.setPixelRatio=function(a){this._pixelRatio=a;this._needsRender=!0},e.prototype.getPixelRatio=function(){return this._pixelRatio},
e.prototype.addExternalRenderer=function(a,b){return this._externalRenderers.addRenderer(a,b),!0},e.prototype.removeExternalRenderer=function(a){return this._externalRenderers.removeRenderer(a),!0},e.prototype.getExternalRenderers=function(){return this._externalRenderers},e.prototype.resetNeedsRender=function(){this._needsRender=!1;this._externalRenderers.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()},e.prototype.getCombinedStats=
function(){this._stats.VBOallocatedSize=0;this._stats.VBOoptimalSize=0;this._stats.VBOusedSize=0;for(var a in this._mat2dataInstanced){var b=this._mat2dataInstanced[a],d;for(d in b.origin2data){var c=b.origin2data[d];this._stats.VBOallocatedSize+=c.buffer.getArray().length;this._stats.VBOusedSize+=c.buffer.getSize();this._stats.VBOoptimalSize+=c.optimalCount}}for(a in this._mat2dataMerged)for(d in b=this._mat2dataMerged[a],b.origin2data)c=b.origin2data[d],this._stats.VBOallocatedSize+=c.buffer.getArray().length,
this._stats.VBOusedSize+=c.buffer.getSize(),this._stats.VBOoptimalSize+=c.optimalCount;return this._stats.VBOallocatedSize*=.00390625,this._stats.VBOusedSize*=.00390625,this._stats.VBOoptimalSize*=.00390625,this._stats},e.prototype._addHighlight=function(a){var b=this._getInstance(a,!0)||this._getInstance(a,!1);return null===b?void console.error("No instance found for RenderGeometry {name: '"+a.name+"', uniqueName: '"+a.uniqueName+"'}"):(this._highlights.push(b),this._orderedRendering&&this._sortHighlightsByRenderOrder(),
this._needsRender=!0,void(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)))},e.prototype._removeHighlight=function(a){var b=this._highlights.length;this._highlights=this._highlights.filter(function(b){return b.uniqueName!==a.uniqueName});b!==this._highlights.length&&(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights),this._needsRender=!0)},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return 0<this._highlights.length},enumerable:!0,
configurable:!0}),e.prototype._renderHUDVisibility=function(a){var b=this;a.offscreenRenderingHelper.renderHUDVisibility(function(){b._renderInternalSlot(p.OCCLUSION_PIXELS,a)})},e.prototype.renderGeometrySlots=function(a){this._externalRenderers.render(p.INTERNAL_MATERIAL,a);this._renderInternalSlot(p.STENCIL_MATERIAL,a);this._externalRenderers.render(p.OPAQUE_TERRAIN,a);this._renderInternalSlot(p.OPAQUE_MATERIAL,a);this._externalRenderers.render(p.OPAQUE_EXTERNAL,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);
this._renderInternalSlot(p.TRANSPARENT_MATERIAL,a);this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(a),this._renderInternalSlot(p.LINE_CALLOUTS,this._renderContext));this._externalRenderers.render(p.TRANSPARENT_EXTERNAL,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);this._externalRenderers.render(p.TRANSPARENT_TERRAIN,a)},e.prototype._renderHighlights=function(a,b,d){var c=!!d&&d.getEnableState()&&(this.hasHighlights||this._externalRenderers.needsHighlight());if(this._highlightTextureHelper.setEnableState(c),
c){c=null;d.profilingCallback&&(c=ma.startMeasurement(this._renderContext.rctx));this._highlightTextureHelper.setupFBOs(a);this._highlightTextureHelper.prepareHighlightPass();this.renderGeometryPass(A.MATERIAL_HIGHLIGHT,a,null,null);this._rctx.clear(this._rctx.gl.DEPTH_BUFFER_BIT);this._renderInternalSlot(p.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL1,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL2,this._renderContext);this._highlightTextureHelper.finish(b);
var f=this._highlightTextureHelper.getHighlightFBO();d.render(a,b,f);null!==c&&d.profilingCallback&&c.stop(function(a){d.profilingCallback&&d.profilingCallback(a)})}},e.prototype._renderUnordered=function(a,b,d,c,f,l){var g=this._rctx;switch(this._isRendering=!0,this._stats.reset(),this._updateGlobalUniforms(a.projectionMatrix),this._renderContext.pass=A.MATERIAL,this._renderContext.camera=a,this._renderContext.shadowMap=b,this._renderContext.ssaoHelper=d,this._renderContext.offscreenRenderingHelper=
f,this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO(),this._renderContext.options=this.renderOptions,this._renderContext.rctx=this._rctx,this._renderContext.lightingData=this._lighting.getOld(),f.setEnableState(!0),f.initializeFrame(a),this._externalRenderers.render(p.BACKGROUND,
this._renderContext),this.renderGeometrySlots(this._renderContext),this._externalRenderers.render(p.POSTPROCESSING_ATMOSPHERE,this._renderContext),this.renderOptions.earlyOcclusionPixelDraw||(this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(p.LINE_CALLOUTS,this._renderContext)),this.renderOptions.antialiasing){case "none":b=a.viewport;b=C.ortho(b[0],b[2],b[1],b[3],-1,1);f.drawQuad(b);this._fxaaPass.disable();this._smaaPass.disable();break;case "fxaa":this._smaaPass.disable();
this._fxaaPass.render({colorTexture:f.getColorTexture()},null);break;case "smaa":this._fxaaPass.disable(),this._smaaPass.render({colorTexture:f.getColorTexture()},null)}g.bindFramebuffer(null);this._renderContext.framebufferTex=f.getColorTexture();this._renderInternalSlot(p.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL1,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL2,this._renderContext);this._renderHighlights(a,c,l);this._framesRendered++;this._isRendering=
!1},e.prototype._renderGeometryPassOrderedHighlight=function(a){this._renderInternalHighlights(this._highlights)},e.prototype._renderGeometryPassOrderedMaterial=function(a){for(var b=null,d=0;d<this._renderOrder.length;d++){var c=this._renderOrder[d][1];if(c.instanced){var f=c.instanced||c.merged,l=f[a.pass];!l||l.isVisible&&!l.isVisible()||(this._renderInternalInstanced(f,l,this._bindParameters,1/0),b=null)}c.merged&&(f=c.merged,!(l=f[a.pass])||l.isVisible&&!l.isVisible()||(c=l.getProgram(),c!==
b&&(c.setUniformMatrix4fv("model",M),c.hasUniform("modelNormal")&&c.setUniformMatrix4fv("modelNormal",M)),b=c,this._renderInternalMerged(f,l,this._bindParameters,1/0)))}},e.prototype._renderGeometryPassOrdered=function(a){var b=a.camera;this._bindParameters.view=b.viewMatrix;this._bindParameters.proj=b.projectionMatrix;this._bindParameters.viewInvTransp=b.viewInverseTransposeMatrix;H[0]=b.near;H[1]=b.far;this._bindParameters.nearFar=H;this._bindParameters.lightingData=this._lighting.getOld();this._bindParameters.viewport=
b.fullViewport;this._bindParameters.framebufferTex=this._framebuffer.texture;this._bindParameters.pixelRatio=this._pixelRatio;this._bindParameters.instanceParameters=void 0;this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();this._bindParameters.normalFBO=this._normalTextureHelper.getNormalFBO();a.isHighlightPass?this._renderGeometryPassOrderedHighlight(a):this._renderGeometryPassOrderedMaterial(a)},e.prototype._renderOrdered=function(a,b){this._stats.reset();this.renderGeometryPass(a,
b);this._framesRendered++},e.prototype.render=function(a,b,d,c,f,l){this._orderedRendering?this._renderOrdered(A.MATERIAL,a):this._renderUnordered(a,b,d,c,l,f)},e.prototype.renderAuxiliaryBuffers=function(a,b,d,c,f){f=this.ssaoEnabled;this._linearDepthTextureHelper.setEnableState(f);f&&(this._linearDepthTextureHelper.setupFBOs(a),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(A.MATERIAL_DEPTH,a,b,d),this._linearDepthTextureHelper.finish(c));this._normalTextureHelper.setEnableState(this.ssaoEnabled);
this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(a),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(A.MATERIAL_NORMAL,a,b,d),this._normalTextureHelper.finish(c));this.ssaoEnabled&&d.computeSSAO(a,c,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO());d.bindAll(this._programRep)},e.prototype.renderGeometryPass=function(a,b,d,c){this._isRendering=!0;this._updateGlobalUniforms(b.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=
b;this._renderContext.shadowMap=d;this._renderContext.ssaoHelper=c;this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO();this._renderContext.normals=this._normalTextureHelper.getNormalFBO();this._renderContext.rctx=this._rctx;this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext);this._isRendering=!1},e.prototype._renderGeometryPassUnordered=function(a){this.renderGeometrySlots(a)},e.prototype._renderInternalHighlights=
function(a,b){void 0===b&&(b=null);for(var d=0;d<a.length;++d){var c=a[d],f=c.matData[A.MATERIAL_HIGHLIGHT];!f||null!==b&&!f.beginSlot(b)||f.isVisible&&!f.isVisible()||this._renderInternalHighlight(c,this._bindParameters,A.MATERIAL_HIGHLIGHT)}},e.prototype._renderInternalSlotMaterial=function(a,b){for(var d in this._mat2dataInstanced){var c=this._mat2dataInstanced[d],f=c[b.pass];f&&f.beginSlot(a)&&(!f.isVisible||f.isVisible())&&this._renderInternalInstanced(c,f,this._bindParameters,a)}for(var c=this._programRep.getProgramsUsingUniform("model"),
f=this._programRep.getProgramsUsingUniform("modelNormal"),l=0;l<c.length;l++){var g=c[l];g.setUniformMatrix4fv("model",M);-1<f.indexOf(g)&&g.setUniformMatrix4fv("modelNormal",M)}for(d in this._mat2dataMerged)c=this._mat2dataMerged[d],(f=c[b.pass])&&f.beginSlot(a)&&(!f.isVisible||f.isVisible())&&this._renderInternalMerged(c,f,this._bindParameters,a);a===p.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish()},e.prototype._renderInternalSlotHighlights=function(a,b){this._renderInternalHighlights(this._highlights,
a)},e.prototype._renderInternalSlot=function(a,b){this._bindParameters.view=b.camera.viewMatrix;this._bindParameters.proj=b.camera.projectionMatrix;this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;this._bindParameters.poiDistance=b.camera.distance;H[0]=b.camera.near;H[1]=b.camera.far;var d=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=H;this._bindParameters.lightingData=
this._lighting.getOld();this._bindParameters.viewport=b.camera.fullViewport;this._bindParameters.framebufferTex=d?d.getColorTexture():null;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=!!b.shadowMap&&b.shadowMap.getEnableState();this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.getEnableState();this._bindParameters.pixelRatio=this._pixelRatio;this._bindParameters.instanceParameters=void 0;this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();
this._bindParameters.hudVisibilityTexture=d?d.getHUDVisibilityTexture():null;b.isHighlightPass?this._renderInternalSlotHighlights(a,b):this._renderInternalSlotMaterial(a,b)},e.prototype._renderInternalInstanced=function(a,b,d,c){var f=this._rctx,l=f.gl,g=!1,e=b.getDrawMode(f),h=this._bindParameters.extensions.angleInstancedArrays,k;for(k in a.origin2data){var w=a.origin2data[k];d.origin=w.origin;c===p.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());
var u=!1;if(b.instanced)for(var m in w.perGeometryDataInfo){var n=w.perGeometryDataInfo[m];g||(b.bind(f,d),g=!0);f.bindVAO(n.vao);var y=b.getProgram();F.assertCompatibleVertexAttributeLocations(n.vao,y);u||(b.bindView(f,d),u=!0);var y=n.to-n.from,v=n.refCount;e===l.TRIANGLES&&(this._stats.trianglesRendered+=v*y/3);h.drawArraysInstancedANGLE(e,n.from,y,v);this._stats.drawCallsAngleInstanced++;this._stats.instancesDrawnAngle+=v}else{var n=w.instances,t;for(t in n)y=n[t],(v=y.displayedIndexRange)&&0===
v.length||(g||(b.bind(f,d),g=!0),u||(f.bindVAO(w.vao),b.bindView(f,d),u=!0),b.bindInstance(f,y),this._stats.drawCallsInstanced++,e===l.TRIANGLES&&(this._stats.trianglesRendered+=(y.to-y.from)/3),v?this._drawArraysFaceRange(v,y.from,e):f.drawArrays(e,y.from,y.to-y.from))}}f.bindVAO(null);g&&b.release(f,d)},e.prototype._renderInternalHighlight=function(a,b,d){var c=this._rctx,f=c.gl;d=a.matData[d];var l=d.getDrawMode(c),g=a.instance,e=g.highlightedIndexRange,h=this._renderContext.offscreenRenderingHelper,
h=(h?h.getDepthTexture():null)||this._getFallbackDepthTexture(),k=d.getProgram(),w=this._bindParameters.extensions.angleInstancedArrays;if(b.origin=a.originData.origin,d.instanced&&"instanced"===a.type){var u=a.instancedVAO;d.bind(c,b);c.bindVAO(u);F.assertCompatibleVertexAttributeLocations(u,k);d.bindView(c,b);for(a=0;a<e.length;a++){var m=e[a],u=m.range?m.range[0]+g.from:g.from,m=m.range?m.range[1]-m.range[0]+1:g.to-g.from;c.bindTexture(h,5);k.setUniform1i("depthTex",5);k.setUniform4f("highlightViewportPixelSz",
0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);w.drawArraysInstancedANGLE(l,u,m,1);l===f.TRIANGLES&&(this._stats.trianglesRendered+=1*m/3);this._stats.drawCallsHighlight++}}else if("merged"===a.type||"instanced"===a.type&&!d.instanced)for(u=a.originData.vao,d.bind(c,b),c.bindVAO(u),d.bindView(c,b),"instanced"===a.type?d.bindInstance(c,g):k.setUniformMatrix4fv("model",M),a=0;a<e.length;a++)m=e[a],u=m.range?m.range[0]+g.from:g.from,m=m.range?m.range[1]-m.range[0]+1:g.to-
g.from,c.bindTexture(h,5),d.getProgram().setUniform1i("depthTex",5),k.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),c.drawArrays(l,u,m),l===f.TRIANGLES&&(this._stats.trianglesRendered+=m/3),this._stats.drawCallsHighlight++;else console.error("_renderInternalHighlight: incompatible istance type");c.bindVAO(null);d.release(c,b)},e.prototype._drawArraysFaceRange=function(a,b,d){for(var c=this._rctx,f=0;f<a.length;f++){var l=a[f];c.drawArrays(d,
l[0]+b,l[1]-l[0]+1)}this._stats.drawCallsFragmented+=a.length-1},e.prototype._renderInternalMerged=function(a,b,d,c){var f=this._rctx,l=f.gl,g=!1,e;for(e in a.origin2data){var h=a.origin2data[e];if(d.origin=h.origin,c===p.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass()),!h.displayedIndexRange||0!==h.displayedIndexRange.length){g||(b.bind(f,d),g=!0);var k=b.getProgram();f.bindVAO(h.vao);F.assertCompatibleVertexAttributeLocations(h.vao,
k);b.bindView(f,d);this._stats.drawCallsMerged++;k=b.getDrawMode(f);k===l.TRIANGLES&&(this._stats.trianglesRendered+=h.vao.vertexBuffers.geometry.size/3);h.displayedIndexRange?this._drawArraysFaceRange(h.displayedIndexRange,0,k):f.drawArrays(k,0,F.vertexCount(h.vao,"geometry"))}}g&&b.release(f,d)},e.prototype._updateGlobalUniforms=function(a){for(var b=this._programRep.getProgramsUsingUniform("proj"),d=0;d<b.length;d++)b[d].setUniformMatrix4fv("proj",a);if(this._lighting){b=this._programRep.getProgramsUsingUniform("lightingMainDirection");
for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d]);b=this._programRep.getProgramsUsingUniform("lightDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d])}},e.prototype.print=function(){Object.keys(this._mat2dataMerged);Object.keys(this._mat2dataInstanced);var a=0,b;for(b in this._mat2dataMerged){var d=this._mat2dataMerged[b],c;for(c in d.origin2data)a+=Object.keys(d.origin2data[c].instances).length}a=0;for(b in this._mat2dataInstanced)for(c in d=this._mat2dataInstanced[b],d.origin2data)a+=
Object.keys(d.origin2data[c].instances).length},e.prototype.isEmpty=function(){for(var a in this._mat2dataInstanced){var b=this._mat2dataInstanced[a],d;for(d in b.origin2data)if(!Y(b.origin2data[d].instances))return!1}for(a in this._mat2dataMerged)for(d in b=this._mat2dataMerged[a],b.origin2data)if(!Y(b.origin2data[d].instances))return!1;return!0},e.prototype.modify=function(a,b,d,c){this._isRendering&&console.warn("Renderer.modify called while rendering");var f=[],l=[];this._mergedOrInstanced(a,
f,l);a=[];var g=[];this._mergedOrInstanced(b,a,g);var e={};d&&this._performUpdates(d,e);d=[];this._modifyMerged(f,a,d,e);this._modifyInstanced(l,g,d);this._updateMergedFaceranges(e);this._releaseMaterials(d);f=this._highlights.length;b&&0<b.length&&0<f&&(this._highlights=this._highlights.filter(function(a){return!b.some(function(b){return b.uniqueName===a.uniqueName})}),f!==this._highlights.length&&this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights));this._updateHighlightVAOs();
this._modifyMaterials(c);this._needsRender=!0},e.prototype._isInstanced=function(a){var b=!1,d=K(a.data.faces.indices).length;return b=b||!1===a.material.canBeMerged,b=b||a.material.instanced,b=b||a.material.isBackdrop,a.singleUse?b:b=b||d>this._threshold},e.prototype._mergedOrInstanced=function(a,b,d){for(var c=0;c<a.length;++c)1>K(a[c].data.faces.indices).length||(this._isInstanced(a[c])?d.push(a[c]):b.push(a[c]))},e.prototype._performUpdates=function(a,b){for(var d=0;d<a.length;d++){var c=a[d],
f=c.renderGeometry,l=this._isInstanced(f),c=c.updateType;if(2&c&&this._updateFaceranges(f,l,b),32&c){var g=this._getInstance(f,l);g&&this._updateHighlightFaceranges(f,g.instance)}4&c||!l&&16&c?this._updateVertexAttributes(f,l):l&&16&c?this._updateInstanceTransformation(f,l):8&c&&this._updateColorAttributes(f)}},e.prototype._updateFaceranges=function(a,b,d){var c=a.material.getId(),f=a.origin.id,l=(b?this._mat2dataInstanced:this._mat2dataMerged)[c].origin2data[f],g=l.instances[a.uniqueName];g&&(g.displayedIndexRange=
N.generateVisibleIndexRanges(a.instanceParameters.componentVisibilities,a.componentOffsets),b||(d[this._modifiedMergedFacerangesKey(c,f)]=l),this._updateHighlightFaceranges(a,g))},e.prototype._updateHighlightFaceranges=function(a,b){if(b){var d=b.highlightedIndexRange,c;c=N.generateHighlightedIndexRanges(a.instanceParameters.componentVisibilities,a.instanceParameters.componentHighlights,a.componentOffsets);(b.highlightedIndexRange=c)&&!d?this._addHighlight(a):!c&&d&&this._removeHighlight(a)}},e.prototype._updateMergedFaceranges=
function(a){for(var b in a){var d=a[b];d.displayedIndexRange=[];var c=d.instances,f=!0,l;for(l in c){var g=c[l];g.displayedIndexRange?(d.displayedIndexRange.push.apply(d.displayedIndexRange,U.offsetIntervals(g.displayedIndexRange,g.from)),f=!1):d.displayedIndexRange.push([g.from,g.to-1])}f?d.displayedIndexRange=null:d.displayedIndexRange=U.mergeIntervals(d.displayedIndexRange)}},e.prototype._updateVertexAttributes=function(a,b){var d,c,f=a.material,l=f.getId(),l=(b?this._mat2dataInstanced:this._mat2dataMerged)[l].origin2data[a.origin.id],
g=l.instances[a.uniqueName];b||(d=a.origin.vec3,P(I,-d[0],-d[1],-d[2]),C.multiply(I,a.transformation,J),C.inverse(J,L),C.transpose(L),d=J,c=L);b=F.getStride(f.getVertexBufferLayout());var e=b/4;D(g.from+f.getOutputAmount(K(a.data.faces.indices).length)/e===g.to,"material VBO layout has changed");f.fillInterleaved(a.data,d,c,a.instanceParameters,l.buffer.getArray(),g.from*e);l.vao.vertexBuffers.geometry.setSubData(l.buffer.getArray(),g.from*b,g.from*b,g.to*b)},e.prototype._updateInstanceTransformation=
function(a,b){var d=a.origin.vec3,c=(b?this._mat2dataInstanced:this._mat2dataMerged)[a.material.getId()].origin2data[a.origin.id];b=c.instances[a.uniqueName];P(I,-d[0],-d[1],-d[2]);C.multiply(I,a.transformation,b.transformation);C.inverse(b.transformation,b.transformationNormal);C.transpose(b.transformationNormal,b.transformationNormal);d=c.perGeometryDataInfo[a.data.id];if(c=d.instanceBufferData)a=c.getSlot(a.idx),c.fill(a,0,b.transformation),c.fill(a,16,b.transformationNormal),a=4*c.getOffset(a),
b=F.getStride(d.vao.layout.instance),d.vao.vertexBuffers.instance.setSubData(c.getArray(),a,a,a+b)},e.prototype._updateColorAttributes=function(a){var b=a.material,d=b.getId(),c=a.origin.id,d=(this._isInstanced(a)?this._mat2dataInstanced:this._mat2dataMerged)[d].origin2data[c],c=d.instances[a.uniqueName],f=(l={},l[aa.COLOR]=!0,l[aa.SYMBOLCOLOR]=!0,l),l=F.getStride(b.getVertexBufferLayout())/4;D(c.from+b.getOutputAmount(K(a.data.faces.indices).length)/l===c.to,"material VBO layout has changed");b.fillInterleaved(a.data,
void 0,void 0,a.instanceParameters,d.buffer.getArray(),c.from*l,f);d.vao.vertexBuffers.geometry.setSubData(d.buffer.getArray(),c.from*l*4,c.from*l*4,c.to*l*4);var l},e.prototype._modifyMerged=function(a,b,d,c){var f=this._rctx;a=this._compMat2delta(a,b,!1);for(var l in a){b=a[l];for(var g in b){var e=b[g],h=e.optimalCount,k=e.material,w=k.getVertexBufferLayout(),u=F.getStride(w)/4,m=this._mat2dataMerged[l];if(null==m){D(0<h);var n=k.getRenderPriority(),m={origin2data:{}};m[A.MATERIAL]=this._materialRep.aquire(k);
m[A.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(k);m[A.MATERIAL_NORMAL]=this._materialRep.aquireNormal(k);m[A.MATERIAL_DEPTH]=this._materialRep.aquireDepth(k);m[A.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(k);this._mat2dataMerged[l]=m;this._orderedRendering&&this._insertIntoRenderOrder(m,n,"merged")}n=m.origin2data[g];if(null==n&&(D(0<h),n={instances:{},vao:new O(f,S.Default3D,{geometry:w},{geometry:R.createVertex(f,35044)}),buffer:new V(h),optimalCount:0,origin:e.origin},
m.origin2data[g]=n),0<h){var w=n.buffer.getSize(),y=n.buffer.getArray(),m=h<e.sparseCount/2,v=n.buffer.resize(m?h:e.sparseCount),t=e.toRemove;if(m||v){for(var w=0,x=n.buffer.getArray(),m=0;m<t.length;++m)v=n.instances[t[m].uniqueName],n.optimalCount-=(v.to-v.from)*u,delete n.instances[t[m].uniqueName];var m={},z;for(z in n.instances)v=n.instances[z],D(null==m[v.from]),m[v.from]=v;for(var q in m){var v=m[q],r=v.from*u,B=v.to*u;x.set(y.subarray(r,B),w);v.from=w/u;w+=B-r;v.to=w/u}D(w===n.optimalCount)}else for(m=
0;m<t.length;++m)v=t[m].uniqueName,D(void 0!==n.instances[v]),r=n.instances[v].from*u,B=n.instances[v].to*u,n.buffer.erase(r,B),delete n.instances[v],n.optimalCount-=B-r;P(I,-e.origin[0],-e.origin[1],-e.origin[2]);y=e.toAdd;e=!1;for(m=0;m<y.length;++m)t=y[m],r=t.data,C.multiply(I,t.transformation,J),C.inverse(J,L),C.transpose(L),v=w,k.fillInterleaved(r,J,L,t.instanceParameters,n.buffer.getArray(),w),r=k.getOutputAmount(K(r.faces.indices).length),x=v+r,D(null==n.instances[t.uniqueName]),B=N.generateVisibleIndexRanges(t.instanceParameters.componentVisibilities,
t.componentOffsets),v=new ba(t.name,v/u,x/u,B,void 0,void 0,t.idx),n.instances[t.uniqueName]=v,this._updateHighlightFaceranges(t,v),B&&(e=!0),n.optimalCount+=r,w+=r;D(n.optimalCount===h);h=new Float32Array(n.buffer.getArray().buffer,0,n.buffer.getSize());n.vao.vertexBuffers.geometry.setData(h);(e||n.displayedIndexRange)&&(c[this._modifiedMergedFacerangesKey(l,g)]=n)}else D(0===h),n.vao.dispose(!0),n.vao=null,delete m.origin2data[g],0===Object.keys(m.origin2data).length&&(d.push(l),delete this._mat2dataMerged[l],
this._orderedRendering&&this._removeFromRenderOrder(m,"merged"))}}},e.prototype._modifyInstanced=function(a,b,d){a=this._compMat2delta(a,b,!0);b=this._rctx;for(var c in a){var f=a[c],e;for(e in f){var g=f[e];if(0!==g.optimalCount){var E=g.material,h=this._mat2dataInstanced[c];if(null==h){var k=E.getRenderPriority(),h={origin2data:{}};h[A.MATERIAL]=this._materialRep.aquire(E);h[A.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(E);h[A.MATERIAL_NORMAL]=this._materialRep.aquireNormal(E);
h[A.MATERIAL_DEPTH]=this._materialRep.aquireDepth(E);h[A.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(E);this._mat2dataInstanced[c]=h;this._orderedRendering&&this._insertIntoRenderOrder(h,k,"instanced")}var w=E.getVertexBufferLayout(),u=h[A.MATERIAL].instanced?E.getInstanceBufferLayout():void 0,m=u&&F.findAttribute(u,"instanceColor"),n=u&&F.findAttribute(u,"instanceFeatureAttribute"),y=F.getStride(w)/4,k=h.origin2data[e];null==k&&(k={instances:{},vao:new O(b,S.Default3D,{geometry:w},{geometry:R.createVertex(b,
35044)}),buffer:new V(g.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:g.origin},h.origin2data[e]=k);var h=k.buffer.getSize(),v=k.buffer.getArray(),t=g.optimalCount<g.sparseCount/2,x=k.buffer.resize(t?g.optimalCount:g.sparseCount),z;for(z in g.perGeometryDelta){var q=k.perGeometryDataInfo[z];if(q&&q.instanceBufferData){var r=g.perGeometryDelta[z].removeCount;0<r&&q.instanceBufferData.prepareFree(r)}}var B=g.toRemove;if(t||x){for(t=0;t<B.length;++t){x=B[t];delete k.instances[x.uniqueName];
z=x.data.id;var p=q=k.perGeometryDataInfo[z];0===--p.refCount&&null==g.dataId2refCount[z]?(k.optimalCount-=(p.to-p.from)*y,delete k.perGeometryDataInfo[z]):q.instanceBufferData&&q.instanceBufferData.free(x.idx)}var h=0,t=k.buffer.getArray(),x={},G;for(G in k.perGeometryDataInfo)p=k.perGeometryDataInfo[G],D(null==x[p.from]),x[p.from]=p;for(var H in x)p=x[H],r=p.from*y,q=p.to*y,t.set(v.subarray(r,q),h),p.from=h/y,h+=q-r,p.to=h/y;for(var J in k.instances)r=k.instances[J],r.from=k.perGeometryDataInfo[r.dataId].from,
r.to=k.perGeometryDataInfo[r.dataId].to}else for(t=0;t<B.length;++t)x=B[t],delete k.instances[x.uniqueName],z=x.data.id,q=k.perGeometryDataInfo[z],0===--q.refCount&&null==g.dataId2refCount[z]?(r=q.from*y,q=q.to*y,k.buffer.erase(r,q),k.optimalCount-=q-r,delete k.perGeometryDataInfo[z]):q.instanceBufferData&&q.instanceBufferData.free(x.idx);P(I,-g.origin[0],-g.origin[1],-g.origin[2]);for(z in g.perGeometryDelta)(q=k.perGeometryDataInfo[z])&&q.instanceBufferData&&(t=g.perGeometryDelta[z].addCount,0<
t&&q.instanceBufferData.prepareAllocate(t));v=g.toAdd;for(t=0;t<v.length;++t){x=v[t];r=x.data;z=r.id;q=k.perGeometryDataInfo[z];if(null==q){E.fillInterleaved(r,void 0,void 0,void 0,k.buffer.getArray(),h);B=E.getOutputAmount(K(r.faces.indices).length);r=h/y;h+=B;q=h/y;if(k.optimalCount+=B,q={refCount:1,from:r,to:q,vao:null,instanceBufferData:null},u)r=F.getStride(u)/4,q.vao=new O(b,S.Default3D,{geometry:w,instance:u},{geometry:k.vao.vertexBuffers.geometry,instance:R.createVertex(b,35044)}),q.instanceBufferData=
new ca(r,g.perGeometryDelta[z].addCount);k.perGeometryDataInfo[z]=q}else++q.refCount;D(q.from*y<=k.buffer.getSize()&&q.to*y<=k.buffer.getSize());r=C.create();C.multiply(I,x.transformation,r);B=N.generateVisibleIndexRanges(x.instanceParameters.componentVisibilities,x.componentOffsets);r=new ba(x.name,q.from,q.to,B,r,x.instanceParameters,x.idx,z);k.instances[x.uniqueName]=r;this._updateHighlightFaceranges(x,r);if(q=q.instanceBufferData)B=q.allocate(x.idx),q.fill(B,0,r.transformation),q.fill(B,16,r.transformationNormal),
m&&q.fill(B,m.offset/4,x.instanceParameters.color),n&&q.fill(B,n.offset/4,x.instanceParameters.featureAttribute)}D(k.optimalCount===g.optimalCount);E=new Float32Array(k.buffer.getArray().buffer,0,k.buffer.getSize());k.vao.vertexBuffers.geometry.setData(E);for(z in k.perGeometryDataInfo)if(w=k.perGeometryDataInfo[z],w.vao&&(E=w.vao.vertexBuffers.instance))u=g.perGeometryDelta[z],0<u.addCount+u.removeCount&&(w=w.instanceBufferData.compact(),E.setData(w))}else g=this._mat2dataInstanced[c],g.origin2data[e].vao.dispose(!0),
delete g.origin2data[e],0===Object.keys(g.origin2data).length&&(d.push(c),delete this._mat2dataInstanced[c],this._orderedRendering&&this._removeFromRenderOrder(g,"instanced"))}}},e.prototype._compMat2delta=function(a,b,d){var c={};return this._updateMat2delta(a,!0,d,c),this._updateMat2delta(b,!1,d,c),c},e.prototype._updateMat2delta=function(a,b,d,c){for(var f=0;f<a.length;++f){var e=a[f],g=e.origin,p=e.material,h=p.getId(),k=d?this._mat2dataInstanced[h]:this._mat2dataMerged[h],k=k&&k.origin2data[g.id],
w=c[h];null==w&&(w={},c[h]=w);h=w[g.id];if(null==h){if(h={optimalCount:null==k?0:k.optimalCount,sparseCount:null==k?0:k.buffer.getSize(),material:p,toAdd:[],toRemove:[],perGeometryDelta:null,origin:g.vec3},d){var u={};if(void 0!==k)for(var m in k.perGeometryDataInfo)u[m]=k.perGeometryDataInfo[m].refCount;h.dataId2refCount=u;h.perGeometryDelta={}}w[g.id]=h}g=p.getOutputAmount(K(e.data.faces.indices).length);d?(p=e.data.id,(k=h.perGeometryDelta[p])||(k={addCount:0,removeCount:0},h.perGeometryDelta[p]=
k),b?(k.addCount++,null==h.dataId2refCount[p]&&(h.dataId2refCount[p]=0),1===++h.dataId2refCount[p]&&(h.optimalCount+=g,h.sparseCount+=g),h.toAdd.push(e)):(k.removeCount++,0===--h.dataId2refCount[p]&&(delete h.dataId2refCount[p],h.optimalCount-=g),h.toRemove.push(e))):b?(h.optimalCount+=g,h.sparseCount+=g,h.toAdd.push(e)):(h.optimalCount-=g,h.toRemove.push(e))}},e.prototype._modifiedMergedFacerangesKey=function(a,b){return a+"_"+b},e.prototype._insertIntoRenderOrder=function(a,b,d){for(var c=a[A.MATERIAL].getMaterialId(),
f=this._renderOrder.length,e=0;f>e&&this._renderOrder[e][0]>=b;){var g=this._renderOrder[e][1];if(g.id===c)return D(!g[d],"matData for type already exists"),void(g[d]=a);e++}c={id:c,instanced:null,merged:null};c[d]=a;this._renderOrder.splice(e,0,[b,c])},e.prototype._removeFromRenderOrder=function(a,b){var d=a[A.MATERIAL].getMaterialId();for(a=0;this._renderOrder[a][1].id!==d;)a++;d=this._renderOrder[a][1];d[b]=null;d.instanced||d.merged||this._renderOrder.splice(a,1)},e.prototype._sortHighlightsByRenderOrder=
function(){this._highlights.sort(function(a,b){a=a.matData[A.MATERIAL].getRenderPriority();b=b.matData[A.MATERIAL].getRenderPriority();return a>b?-1:b>a?1:0})},e.prototype._updateRenderOrder=function(a,b){for(var d=b.length,c=0;d>c&&b[c][1].id!==a;)c++;if(d>c){a=b[c][1];a=(a.merged||a.instanced)[A.MATERIAL].getRenderPriority();var f=b[c][0];if(a!==b[c][0])for(b[c][0]=a,f=a>f?-1:1,c+=f;-1<c&&d>c&&f*b[c][0]>f*a;){var e=b[c];b[c]=b[c-f];b[c-f]=e;c+=f}}},e.prototype._modifyMaterials=function(a){for(var b in a)this._materialRep.updateMaterialParameters(b)},
e.prototype.modifyRenderOrder=function(a){if(this._orderedRendering){for(var b in a)this._updateRenderOrder(b,this._renderOrder);this._sortHighlightsByRenderOrder();this._needsRender=!0}},e.prototype._releaseMaterials=function(a){if(Array.isArray(a))for(var b=0;b<a.length;b++)this._materialRep.release(a[b]),this._materialRep.releaseDepthShadowMap(a[b]),this._materialRep.releaseNormal(a[b]),this._materialRep.releaseDepth(a[b]),this._materialRep.releaseHighlight(a[b]);else this._materialRep.release(a),
this._materialRep.releaseDepthShadowMap(a),this._materialRep.releaseNormal(a),this._materialRep.releaseDepth(a),this._materialRep.releaseHighlight(a)},e.prototype._getInstance=function(a,b){var d=a.material.getId(),d=(b?this._mat2dataInstanced:this._mat2dataMerged)[d];if(!d)return null;var c=d.origin2data[a.origin.id];if(!c)return null;var e=c.instances[a.uniqueName];return e?{uniqueName:a.uniqueName,instance:e,matData:d,originData:c,type:b?"instanced":"merged",instancedVAO:null,instancedVAOBaseInstance:null}:
null},e.prototype._createBaseInstanceVAO=function(a){var b=this._rctx,d=a.instance;if("instanced"===a.type&&a.originData.perGeometryDataInfo){var c=a.originData.perGeometryDataInfo[d.dataId],e=c.instanceBufferData;e&&(c=c.vao,d=e.getSlot(d.idx),a.instancedVAOBaseInstance!==d&&(e=F.setBaseInstanceOffset(c.layout,d),a.instancedVAO=new O(b,c.locations,e,c.vertexBuffers,c.indexBuffer),a.instancedVAOBaseInstance=d))}},e.prototype._updateHighlightVAOs=function(){for(var a=0;a<this._highlights.length;++a)this._createBaseInstanceVAO(this._highlights[a])},
e.prototype._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new X(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255]))),this._fallbackDepthStencilTexture},e}();var na=function(){function e(){this.reset()}return e.prototype.reset=function(){this.VBOusedSize=this.VBOoptimalSize=this.VBOallocatedSize=this.instancesDrawnAngle=this.drawCallsHighlight=this.drawCallsFragmented=
this.drawCallsMerged=this.drawCallsAngleInstanced=this.drawCallsInstanced=this.trianglesRendered=0},e}(),ba=function(){return function(e,a,b,d,c,f,l,g){this.name=e;this.from=a;this.to=b;this.displayedIndexRange=d;this.transformation=c;this.instanceParameters=f;this.idx=l;this.dataId=g;null!=c&&(this.transformationNormal=C.create(),C.set(c,this.transformationNormal),C.inverse(this.transformationNormal,this.transformationNormal),C.transpose(this.transformationNormal,this.transformationNormal))}}(),
H=T.create(),I=C.identity(),J=C.create(),L=C.create();return G});