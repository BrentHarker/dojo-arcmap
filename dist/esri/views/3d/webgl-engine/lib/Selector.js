//>>built
define("require exports dojo/has ./PerformanceTimer ./gl-matrix ./Object3D".split(" "),function(m,x,t,u,c,v){var q=c.vec3d.create(),r=c.vec3d.create(),n=t("dojo-debug-messages");m=function(){function a(h,b,w,a,g,f,d,e){void 0===e&&(e=!1);this.dir=c.vec3d.create();this.normalDir=null;this.minResult=new p;this.maxResult=new p;this.transform=c.mat4d.create();this._transformInverse=new k({value:this.transform},c.mat4d.inverse,c.mat4d.create);this._transformInverseTranspose=new k(this._transformInverse,
c.mat4d.transpose,c.mat4d.create);this._transformTranspose=new k({value:this.transform},c.mat4d.transpose,c.mat4d.create);this._transformInverseRotation=new k({value:this.transform},c.mat4d.toInverseMat3,c.mat3d.create);this.enableHUDSelection=!0;this.enableInvisibleTerrain=!1;this.enableBackfacesTerrain=!0;this.performanceInfo={queryDuration:0,numObjectsTested:0};this.viewingMode=h||"global";this.intersectObject=this.intersectObject.bind(this);n&&(this.timer=new u(1));this.init(b,w,a,g,f,d,e)}return a.prototype.init=
function(h,b,a,l,g,f,d){if(b&&a&&c.vec3d.subtract(a,b,this.dir),this.minResult.init(b,a),this.maxResult.init(b,a),this.numObjectsTested=0,this.point=l,this.camera=g,this.isSelection=d,this.layers=h,this.p0=b,this.p1=a,this.hudResults=[],null==f&&(f=1E-5),this.tolerance=f,this.layers){n&&this.timer.start();for(h=0;h<this.layers.length;++h)if(b=this.layers[h],a=b.getSpatialQueryAccelerator?b.getSpatialQueryAccelerator():void 0)a.forEachAlongRay(this.p0,this.dir,this.intersectObject);else for(b=b.getObjects(),
a=0;a<b.length;++a)this.intersectObject(b[a]);n&&(this.timer.stop(),this.performanceInfo.queryDuration=this.timer.getLast(),this.performanceInfo.numObjectsTested=this.numObjectsTested)}},Object.defineProperty(a.prototype,"transformInverse",{get:function(){return this._transformInverse.value},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"transformInverseTranspose",{get:function(){return this._transformInverseTranspose.value},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,
"transformInverseRotation",{get:function(){return this._transformInverseRotation.value},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"transformTranspose",{get:function(){return this._transformTranspose.value},enumerable:!0,configurable:!0}),a.prototype.getDirection=function(){return this.normalDir||(this.normalDir=c.vec3d.create(),c.vec3d.normalize(this.dir,this.normalDir)),this.normalDir},a.prototype.intersectObject=function(a){var b=this;this.numObjectsTested++;for(var h,l=
a.getId(),g=a.getGeometryRecords(),f=a.objectTransformation,d=0;d<g.length;d++){var e=g[d],k=e.geometry,m=e.materials,n=e.instanceParameters;h=k.getId();c.mat4d.set(f,this.transform);c.mat4d.multiply(this.transform,e.getShaderTransformation());this._transformInverse.invalidate();this._transformInverseTranspose.invalidate();this._transformTranspose.invalidate();this._transformInverseRotation.invalidate();c.mat4d.multiplyVec3(this.transformInverse,this.p0,q);c.mat4d.multiplyVec3(this.transformInverse,
this.p1,r);m[0].intersect(k,n,this.transform,this,q,r,function(c,e,f,d,g,k){0<=c&&(g?(g=new p,g.set(a,l,c,e,d,k,h,f),b.hudResults.push(g)):((null==b.minResult.priority||d>=b.minResult.priority)&&(null==b.minResult.dist||c<b.minResult.dist)&&b.minResult.set(a,l,c,e,d,null,h,f),(null==b.maxResult.priority||d>=b.maxResult.priority)&&(null==b.maxResult.dist||c>b.maxResult.dist)&&b.maxResult.set(a,l,c,e,d,null,h,f)))},e.customTransformation)}},a.prototype.getMinResult=function(){return this.minResult},
a.prototype.getMaxResult=function(){return this.maxResult},a.prototype.getHudResults=function(){return this.hudResults},a}();m.DEFAULT_TOLERANCE=1E-5;var p=function(){function a(a,b){this.normal=c.vec3d.create();this.init(a,b)}return a.prototype.getIntersectionPoint=function(a){return null==this.dist?!1:(c.vec3d.lerp(this.p0,this.p1,this.dist,a),!0)},a.prototype.set=function(a,b,k,l,g,f,d,e){this.dist=k;c.vec3d.set(l,this.normal);a?this.targetType=a instanceof v?"StageObject":"StagePoint":this.targetType=
"None";this.target=a;this.name=b;this.priority=g;this.center=f?c.vec3d.create(f):null;this.geometryId=d;this.triangleNr=e},a.prototype.setIntersector=function(a){this.intersector=a},a.prototype.init=function(a,b){this.dist=void 0;this.targetType="None";this.priority=this.name=this.target=void 0;this.triangleNr=this.geometryId=this.center=null;this.intersector="stage";this.p0=a;this.p1=b},a}(),k=function(){function a(a,b,c){this.original=a;this.update=b;this.dirty=!0;this.transform=c()}return a.prototype.invalidate=
function(){this.dirty=!0},Object.defineProperty(a.prototype,"value",{get:function(){return this.dirty&&(this.update(this.original.value,this.transform),this.dirty=!1),this.transform},enumerable:!0,configurable:!0}),a}();return m});