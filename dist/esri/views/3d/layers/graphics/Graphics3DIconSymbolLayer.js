//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/_base/lang dojo/when ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DDrapedGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./SignedDistanceFunctions ../support/FastSymbolUpdates ./graphicUtils ../../../../core/screenUtils ../../../../core/sniff ../../../../core/Logger ../../../../core/Error ../../../../symbols/support/symbolUtils ../../../../Color ../../../../geometry/Polygon ../../support/projectionUtils ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial ../../../../core/urlUtils".split(" "),
function(z,ga,H,A,I,q,J,K,L,l,r,x,M,t,N,O,P,Q,R,S,T,u,y,U,B,V,W,C,X){function Y(g){var b,a=v,c=a*m;switch("primitive:"===g.substring(0,10)&&(g=g.substring(10)),g){case w.PRIM_CIRCLE:b=r.computeSignedDistancefieldCicle(a,c);break;case w.PRIM_SQUARE:b=r.computeSignedDistancefieldSquare(a,c,!1);break;case w.PRIM_KITE:b=r.computeSignedDistancefieldSquare(a,c,!0);break;case w.PRIM_CROSS:b=r.computeSignedDistancefieldCrossAndX(a,c,!1);break;case w.PRIM_X:b=r.computeSignedDistancefieldCrossAndX(a,c,!0)}return new W(b,
"sdf_"+g,{mipmap:!1,wrapClamp:!0,width:v,height:v,components:4})}var Z=O.getLogger("esri.views.3d.graphics"),aa=u.vec3d;z=u.vec4d;var D=u.mat4d.identity(),E=[0,0,1],ba=[0,0,0,0],F=[0,0,0],ca=[1,1,1],G="center bottom top left right bottom-left bottom-right top-left top-right".split(" "),v=128,m=.5,da=[m/2,m/2,1-m/2,1-m/2],w={PRIM_CIRCLE:"circle",PRIM_SQUARE:"square",PRIM_CROSS:"cross",PRIM_X:"x",PRIM_KITE:"kite"};u=[v*m,v*m];q=function(g){function b(){var a=null!==g&&g.apply(this,arguments)||this;
return a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0},a}return H(b,g),b.prototype._prepareResources=function(){var a=this.symbol,c=Math.round(null!=a.size?t.pt2px(a.size):16);this._size=null;this._symbolTextureRatio=1;this._primitive=null;var f=this._getStageIdHint();if(!this._isPropertyDriven("size")){var d=M.validateSymbolLayerSize(c);if(d)return this._logWarning(d),void this.reject()}this._isPropertyDriven("size")&&64>c&&(c=64);var b=a.resource||{primitive:"circle",href:void 0},
d={anchorPos:this._getAnchorPos(a)},e=this.symbolContainer;if(this._hasVisibleVerticalOffset(e)){var e=e.verticalOffset,h=e.minWorldLength,p=e.maxWorldLength;d.verticalOffset={screenLength:t.pt2px(e.screenLength),minWorldLength:h||0,maxWorldLength:null!=p?p:1/0}}if(this._context.screenSizePerspectiveEnabled&&(d.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),b.href)this._outlineSize=this._getOutlineSize(a,null),d.color=this._getFillColor(a,null),d.outlineColor=this._getOutlineColor(a),
d.outlineSize=this._outlineSize,d.textureIsSignedDistanceField=!1,this._prepareImageResources(c,d,f);else{b=b.primitive||"circle";e="primitive:"+b;if(this._primitive=b,this._outlineSize=this._getOutlineSize(a,b),d.color=this._getFillColor(a,b),d.outlineColor=this._getOutlineColor(a),d.outlineSize=this._outlineSize,("cross"===b||"x"===b)&&0===d.outlineSize)return void this.reject();this.texture=this._context.sharedResources.textures.acquire(e,Y);this._textureURI=e;d.textureIsSignedDistanceField=!0;
d.distanceFieldBoundingBox=da;d.textureId=this.texture.getId();this._size=[c,c];this._symbolTextureRatio=1/m;this._createMaterialsAndAddToStage(d,this._context.stage,f);this.resolve()}},b.prototype._getOutlineSize=function(a,c){var f=0;return f=a.outline&&null!=a.outline.size?t.pt2px(a.outline.size):"cross"===c||"x"===c?1.5:0,Math.max(f,0)},b.prototype._getOutlineColor=function(a){var c=this._getLayerOpacity();if(a.outline&&null!=a.outline.color){var f=R.toUnitRGB(a.outline.color);return[f[0],f[1],
f[2],a.outline.color.a*c]}return[0,0,0,c]},b.prototype._getFillColor=function(a,c){return"cross"===c||"x"===c?ba:this._getMaterialOpacityAndColor()},b.prototype._getAnchorPos=function(a){return-1<G.indexOf(a.anchor)?a.anchor:"center"},b.prototype._prepareImageResources=function(a,c,f){var d=this,b=Q.getIconHref(this.symbolContainer,this.symbol);if(!N("esri-canvas-svg-support")&&X.isSVG(b))return Z.warn("#_prepareImageResources()","SVG symbols are not supported in IE11"),void this.reject(new P("SVG Not Supported",
"SVG symbols are not supported in IE11"));I(this._context.sharedResources.textures.acquire(b,null,a),function(b){if(!d.isRejected()){var e=b.params,p=e.width/e.height;a?1<p?d._size=[a,Math.round(a/p)]:d._size=[Math.round(a*p),a]:d._size=[e.width,e.height];c.textureId=b.getId();d._createMaterialsAndAddToStage(c,d._context.stage,f);d.resolve()}},function(){d.reject()});this._textureURI=b},b.prototype._createMaterialsAndAddToStage=function(a,c,f){this._fastUpdates=x.initFastSymbolUpdatesState(this._context.renderer,
this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions());this._fastUpdates.enabled&&A.mixin(a,this._fastUpdates.materialParameters);var d=A.mixin({},a);d.verticalOffset=null;d.screenSizePerspective=null;d.occlusionTest=!1;d.shaderPolygonOffset=0;this._drapedMaterial=new C(d,f+"_iconDraped");c.add(y.ModelContentType.MATERIAL,this._drapedMaterial);a.occlusionTest=!0;this._material=new C(a,f+"_icon");c.add(y.ModelContentType.MATERIAL,this._material)},b.prototype.destroy=function(){this.isFulfilled()||
this.reject();this._material&&(this._context.stage.remove(y.ModelContentType.MATERIAL,this._material.getId()),this._material=null);this._drapedMaterial&&(this._context.stage.remove(y.ModelContentType.MATERIAL,this._drapedMaterial.getId()),this._drapedMaterial=null);this._textureURI&&(this._context.sharedResources.textures.release(this._textureURI),this._textureURI=null)},b.prototype._getGeometry=function(a){a=a.geometry;return"extent"===a.type?l.placePointOnPolygon(S.fromExtent(a)):"polyline"===a.type?
l.placePointOnPolyline(a):"polygon"===a.type?l.placePointOnPolygon(a):"point"===a.type?a:(this._logWarning("unsupported geometry type for icon symbol: "+a.type),null)},b.prototype._getScaleFactor=function(a){if(this._isPropertyDriven("size")&&a.size){for(var c=0;3>c;c++){var f=a.size[c];f&&"symbolValue"!==f&&"proportional"!==f&&(a.size[c]=t.pt2px(f))}c=this._size[0]>this._size[1]?this._size[0]:this._size[1];if("symbolValue"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/c;if(isFinite(+a.size[2]))return+a.size[2]/
c}return 1},b.prototype.createGraphics3DGraphic=function(a,c){var f=this._getGeometry(a);if(null===f)return null;var d="graphic"+a.uid,b=this._getVertexOpacityAndColor(c),e=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(e=this._getScaleFactor(c));e*=this._symbolTextureRatio;c=[this._size[0]*e,this._size[1]*e];e=this.getGraphicElevationInfo(a);return"on-the-ground"===e.mode?this._createAsOverlay(a,f,b,c,e,d,a.uid):this._createAs3DShape(a,f,b,c,e,d,a.uid)},b.prototype.layerPropertyChanged=
function(a,c,b){if("opacity"===a)return c=this._getFillColor(this.symbol,this._primitive),this._drapedMaterial.setParameterValues({color:c}),this._material.setParameterValues({color:c}),c=this._getOutlineColor(this.symbol),this._drapedMaterial.setParameterValues({outlineColor:c}),this._material.setParameterValues({outlineColor:c}),!0;if("elevationInfo"===a){a=this._elevationInfo.mode;this._updateElevationInfo();var d=this._elevationInfo.mode;if("on-the-ground"===a&&"on-the-ground"===d)return!0;if(a!==
d&&("on-the-ground"===a||"on-the-ground"===d))return!1;a=l.needsElevationUpdates2D(d)||"absolute-height"===d;for(var f in c){var e=c[f];(d=b(e))&&!d.isDraped()&&(e=this.getGraphicElevationInfo(e.graphic),d.needsElevationUpdates=a,d.elevationInfo.set(e))}return!0}return!1},b.prototype.applyRendererDiff=function(a,c,b,d){for(var f in a.diff)switch(f){case "visualVariables":if(!x.updateFastSymbolUpdatesState(this._fastUpdates,c,this._fastVisualVariableConvertOptions()))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);
this._drapedMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},b.prototype.setDrawOrder=function(a,c,b){this._drapedMaterial&&(this._drapedMaterial.setRenderPriority(a),b[this._drapedMaterial.getId()]=!0)},b.prototype._defaultElevationInfoNoZ=function(){return ea},b.prototype._createAs3DShape=function(a,c,b,d,g,e,h){var f=this,n=this._getFastUpdateAttrValues(a);a=n?function(a){return x.evaluateModelTransform(f._fastUpdates.materialParameters,n,a)}:null;
b=B.createPointGeometry(E,null,b,d,fa,null,n);b=[new U(b,e)];e=l.createStageObjectForPoint.call(this,c,b,[[this._material]],null,null,g,e,this._context.layer.id,h,!0,a);if(null===e)return null;var k=new J(this,e.object,b,null,null,L.perObjectElevationAligner,g);return k.alignedTerrainElevation=e.terrainElevation,k.needsElevationUpdates=l.needsElevationUpdates2D(g.mode)||"absolute-height"===g.mode,k.getScreenSize=this._createScreenSizeGetter(d,a),k.calculateRelativeScreenBounds=function(a){return f._material.calculateRelativeScreenBounds(k.getScreenSize(),
1,a)},l.extendPointGraphicElevationInfo(k,c,this._context.elevationProvider),k},b.prototype._createAsOverlay=function(a,c,b,d,g,e,h){var f=this;this._drapedMaterial.setRenderPriority(this._symbolLayerOrder);h=aa.create();T.pointToVector(c,h,this._context.overlaySR);h[2]=this._getDrapedZ();if((c=this._context.clippingExtent)&&!l.pointInBox2D(h,c))return null;var n=this._getFastUpdateAttrValues(a);a=n?function(a){return x.evaluateModelTransform(f._fastUpdates.materialParameters,n,a)}:null;b=B.createPointGeometry(E,
h,b,d,null,null,n);c=new V(b);c.material=this._drapedMaterial;c.center=h;c.bsRadius=0;c.transformation=D;c.name=e;c.uniqueName=e+"#"+b.id;var k=new K(this,[c],null,null,null,g);return k.getScreenSize=this._createScreenSizeGetter(d,a),k.calculateRelativeScreenBounds=function(a){return f._drapedMaterial.calculateRelativeScreenBounds(k.getScreenSize(),1,a)},k},b.prototype._createScreenSizeGetter=function(a,c){var b=this._outlineSize+2;if(this._fastUpdates.enabled){var d=a[0]/this._symbolTextureRatio,
g=a[1]/this._symbolTextureRatio;return function(a){void 0===a&&(a=Array(2));var e=c(D);return a[0]=e[0]*d+b,a[1]=e[5]*g+b,a}}var e=a[0]/this._symbolTextureRatio+b,h=a[1]/this._symbolTextureRatio+b;return function(a){return void 0===a&&(a=Array(2)),a[0]=e,a[1]=h,a}},b.prototype._supportsShaderVisualVariables=function(){return!0},b.prototype._fastVisualVariableConvertOptions=function(){var a=this._size[0]>this._size[1]?this._size[0]:this._size[1],b=[a,a,a],f=t.px2pt(1),a=a*f;return{modelSize:b,symbolSize:[a,
a,a],unitInMeters:f,transformation:{anchor:F,scale:ca,rotation:F}}},b.prototype._hasVisibleVerticalOffset=function(a){return this.symbolContainer&&"point-symbol-3d"===this.symbolContainer.type&&this.symbolContainer.hasVisibleVerticalOffset()},b}(q);q.PRIMITIVE_SIZE=u;q.VALID_ANCHOR_STRINGS=G;var ea={mode:"relative-to-ground",offset:0},fa=z.createFrom(0,0,0,1);return q});