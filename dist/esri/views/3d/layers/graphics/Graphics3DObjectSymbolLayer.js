//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/_base/lang ../../../../Color ../../../../core/screenUtils ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./graphicUtils ../support/FastSymbolUpdates ./objectResourceUtils ../../lib/glMatrix ../../../../symbols/ObjectSymbol3DLayer ../../support/aaBoundingBox ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/materials/Material".split(" "),
function(f,p,I,y,z,A,n,B,J,q,r,u,C,D,K,t,m,L,g,M){var x=D.mat4d,E=D.vec3d,v=[1,1,1],w=[1,1,1,1],F=[0,0,0];f=[-.5,-.5,-.5,.5,.5,.5];p=[-.5,-.5,0,.5,.5,1];var G={sphere:f,cube:f,cylinder:p,cone:p,"inverted-cone":p,tetrahedron:[-.5,-.5,0,.5,.5,.5],diamond:f},H=[m.ModelContentType.MATERIAL,m.ModelContentType.TEXTURE,m.ModelContentType.GEOMETRY];n=function(f){function c(){return null!==f&&f.apply(this,arguments)||this}return I(c,f),c.prototype._prepareResources=function(){var a=this.symbol,d=this._getStageIdHint();
if(!this._isPropertyDriven("size")){var b=r.validateSymbolLayerSize(this.symbol);if(b)return this._logWarning(b),void this.reject()}a.resource&&a.resource.href?this._prepareModelResources(a.resource.href,d):this._preparePrimitiveResources(a.resource?a.resource.primitive:"sphere",d)},c.prototype._preparePrimitiveResources=function(a,d){var b=this.symbol;if("sphere"===a)this._geometryData=g.createPolySphereGeometry(.5,2,!0);else if("cube"===a)this._geometryData=g.createBoxGeometry(1);else if("cylinder"===
a)this._geometryData=g.createCylinderGeometry(1,.5,32,[0,0,1],[0,0,.5]);else{if("cone"===a)this._geometryData=g.createConeGeometry(1,.5,15,!1);else if("inverted-cone"===a)this._geometryData=g.createConeGeometry(1,.5,15,!0);else if("tetrahedron"===a)this._geometryData=g.createTetrahedronGeometry(1);else{if("diamond"!==a)return this._logWarning("Unknown object symbol primitive: "+a),void this.reject();this._geometryData=g.createDiamondGeometry(1)}g.cgToGIS(this._geometryData)}this._geometry=new L(this._geometryData,
d);this._context.stage.add(m.ModelContentType.GEOMETRY,this._geometry);this._resourceBoundingBox=G[a];this._resourceSize=t.size(this._resourceBoundingBox);this._symbolSize=r.computeSizeWithResourceSize(this._resourceSize,b);a=this._getMaterialOpacity();a={specular:[0,0,0],shininess:3,opacity:a,transparent:1>a||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:v,diffuse:v};var e=this.symbolContainer;if("point-symbol-3d"===e.type&&e.verticalOffset){var e=e.verticalOffset,k=e.minWorldLength,
c=e.maxWorldLength;a.verticalOffset={screenLength:A.pt2px(e.screenLength),minWorldLength:k||0,maxWorldLength:null!=c?c:1/0};a.castShadows=!1}(this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._isPropertyDriven("color"))?a.externalColor=w:(e=b.material?z.toUnitRGBA(b.material.color):w,a.externalColor=e);b.material&&b.material.colorMixMode&&(a.colorMixMode=b.material.colorMixMode);this._fastUpdates=u.initFastSymbolUpdatesState(this._context.renderer,
this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(y.mixin(a,this._fastUpdates.materialParameters),a.instanced.push("featureAttribute")):this._hasPerInstanceColor()&&a.instanced.push("color");this._material=new M(a,d+"_objectmat");this._context.stage.add(m.ModelContentType.MATERIAL,this._material);this.resolve()},c.prototype._prepareModelResources=function(a,d){var b=this,e=["transformation"];d={materialParamsMixin:{instanced:e},idHint:d,streamDataSupplier:this._context.streamDataSupplier};
this._fastUpdates=u.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(y.mixin(d.materialParamsMixin,this._fastUpdates.materialParameters),e.push("featureAttribute")):this._hasPerInstanceColor()&&e.push("color");e=this.symbolContainer;if("point-symbol-3d"===e.type&&e.verticalOffset){var e=e.verticalOffset,c=e.minWorldLength,h=e.maxWorldLength;d.materialParamsMixin.verticalOffset={screenLength:A.pt2px(e.screenLength),
minWorldLength:c||0,maxWorldLength:null!=h?h:1/0};d.materialParamsMixin.castShadows=!1}this._symbolLoaderPromise=C.fetch(a,d);this._symbolLoaderPromise.then(function(a){if(b._symbolLoaderPromise=null,!b.isRejected()){var d=b._context,e=a.stageResources,c=d.stage,k=b._getExternalColorParameters(b.symbol.material),h=b._getMaterialOpacity(),f=b._isPropertyDriven("opacity"),g=e[m.ModelContentType.MATERIAL];a.originalMaterialOpacities=Array(g.length);g.forEach(function(b,e){var c=b.getParameterValues();
b.setParameterValues(k);a.originalMaterialOpacities[e]=c.opacity;c.opacity*=h;c.transparent=1>c.opacity;b.setParameterValues({opacity:c.opacity,transparent:c.transparent||f});d.screenSizePerspectiveEnabled&&(c.screenSizePerspective=d.sharedResources.screenSizePerspectiveSettings,b.setParameterValues({screenSizePerspective:c.screenSizePerspective}))});H.forEach(function(a){for(var b=e[a],d=0;b&&d<b.length;d++)c.add(a,b[d])});b._resourceBoundingBox=C.computeBoundingBox(a);b._resourceSize=t.size(b._resourceBoundingBox);
b._pivotOffset=a.pivotOffset;b._symbolSize=r.computeSizeWithResourceSize(b._resourceSize,b.symbol);b._i3sModel=a;u.updateFastSymbolUpdatesState(b._fastUpdates,b._context.renderer,b._fastVisualVariableConvertOptions())&&g.forEach(function(a){return a.setParameterValues(b._fastUpdates.materialParameters)});b.resolve()}},function(){b._symbolLoaderPromise=null;b.isFulfilled()||b.reject()})},c.prototype._forEachMaterial=function(a){this._i3sModel?this._i3sModel.stageResources[m.ModelContentType.MATERIAL].forEach(a):
a(this._material)},c.prototype._getExternalColorParameters=function(a){var d={};return a&&a.colorMixMode&&(d.colorMixMode=a.colorMixMode),this._isPropertyDriven("color")?d.externalColor=w:a&&a.color?d.externalColor=z.toUnitRGBA(a.color):(d.externalColor=w,d.colorMixMode="ignore"),d},c.prototype.destroy=function(){this.isFulfilled()||this.reject();this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();var a=this._context.stage;if(this._i3sModel){var d=this._i3sModel.stageResources;H.forEach(function(b){for(var e=
d[b],c=0;e&&c<e.length;c++)a.remove(b,e[c].getId())})}else this._material&&a.remove(m.ModelContentType.MATERIAL,this._material.getId()),this._geometry&&a.remove(m.ModelContentType.GEOMETRY,this._geometry.getId())},c.prototype._getGeometry=function(a){a=a.geometry;return"polyline"===a.type?q.placePointOnPolyline(a):"polygon"===a.type?q.placePointOnPolygon(a):"extent"===a.type?a.center:"point"!==a.type?(this._logWarning("unsupported geometry type for object symbol: "+a.type),null):a},c.prototype.createGraphics3DGraphic=
function(a,d){var b=this._getGeometry(a);if(null===b)return null;var e="graphic"+a.uid,c=this.getGraphicElevationInfo(a);return this._createAs3DShape(a,b,d,c,e,a.uid)},c.prototype.layerPropertyChanged=function(a,d,b){var c=this;if("opacity"===a){var k=this._isPropertyDriven("opacity");if(this._i3sModel){var h=this._getMaterialOpacity();this._i3sModel.stageResources[m.ModelContentType.MATERIAL].forEach(function(a,b){b=c._i3sModel.originalMaterialOpacities[b]*h;a.setParameterValues({opacity:b,transparent:1>
b||k})})}else d=this._getMaterialOpacity(),this._material.setParameterValues({opacity:d,transparent:1>d||k});return!0}if("elevationInfo"===a){this._updateElevationInfo();for(var g in d){var l=d[g];if(a=b(l))l=this.getGraphicElevationInfo(l.graphic),a.needsElevationUpdates=q.needsElevationUpdates3D(l.mode),a.elevationInfo.set(l)}return!0}return!1},c.prototype.applyRendererDiff=function(a,d,b,c){var e=this,h;for(h in a.diff)switch(h){case "visualVariables":if(!u.updateFastSymbolUpdatesState(this._fastUpdates,
d,this._fastVisualVariableConvertOptions()))return!1;this._forEachMaterial(function(a){return a.setParameterValues(e._fastUpdates.materialParameters)});break;default:return!1}return!0},c.prototype._createAs3DShape=function(a,d,b,c,k,h){var e=this,l=null,g=null;(a=this._getFastUpdateAttrValues(a))&&(l=l||{},l.featureAttribute=a,g=function(a){return u.evaluateModelTransform(e._fastUpdates.materialParameters,l.featureAttribute,a)});!this._fastUpdates.enabled&&this._hasPerInstanceColor()&&(l=l||{},l.color=
r.mixinColorAndOpacity(b.color,b.opacity));a=this._context.layer.id;var f=x.identity();if(this._applyObjectRotation(b,f),this._applyObjectRotation(this.symbol,f),this._applyObjectScale(b,f),this._applyAnchor(f),this._i3sModel){b=this._i3sModel.stageResources[m.ModelContentType.GEOMETRY];for(var t=this._i3sModel.materialsByComponent,p=Array(b.length),n=0;n<f.length;n++)p[n]=f;k=q.createStageObjectForPoint.call(this,d,b,t,p,l,c,k,a,h,null,g)}else k=q.createStageObjectForPoint.call(this,d,[this._geometry],
[[this._material]],[f],l,c,k,a,h,null,g);if(null===k)return null;if(this._fastUpdates.enabled){var v=u.getMaterialParams(this._fastUpdates.visualVariables,this._fastVisualVariableConvertOptions());this._forEachMaterial(function(a){return a.setParameterValues(v)})}k.object.setCastShadow(!0);h=new B(this,k.object,null,null,null,J.perObjectElevationAligner,c,B.VisibilityModes.REMOVE_OBJECT);return h.alignedTerrainElevation=k.terrainElevation,h.needsElevationUpdates=q.needsElevationUpdates3D(c.mode),
q.extendPointGraphicElevationInfo(h,d,this._context.elevationProvider),h},c.prototype._applyObjectScale=function(a,d){this._fastUpdates.enabled&&this._fastUpdates.customTransformation||(a=this._isPropertyDriven("size")&&a.size?a.size:this._symbolSize,a=r.computeObjectScale(a,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters),1===a[0]&&1===a[1]&&1===a[2]||x.scale(d,a))},c.prototype._applyObjectRotation=function(a,d){return this._fastUpdates.enabled&&this._fastUpdates.customTransformation&&
a instanceof K?void 0:r.computeObjectRotation(a.heading,a.tilt,a.roll,d)},c.prototype._computeAnchor=function(){switch(this.symbol.anchor){case "center":return E.scale(t.center(this._resourceBoundingBox),-1);case "bottom":var a=t.center(this._resourceBoundingBox);return[-a[0],-a[1],-this._resourceBoundingBox[2]];default:return this._pivotOffset?E.scale(this._pivotOffset,-1,Array(3)):F}},c.prototype._applyAnchor=function(a){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var d=
this._computeAnchor();d&&x.translate(a,d)}},c.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")},c.prototype._supportsShaderVisualVariables=function(){return this._context.stage.has("angleInstancedArrays")?!0:!1},c.prototype._fastVisualVariableConvertOptions=function(){var a=this._resourceBoundingBox?t.size(this._resourceBoundingBox):v,d=this._resourceBoundingBox?this._computeAnchor():F,b=this._context.renderCoordsHelper.unitInMeters,
c=r.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,b);return{modelSize:a,symbolSize:this._symbolSize||v,unitInMeters:b,transformation:{anchor:d,scale:c,rotation:[this.symbol.tilt||0,this.symbol.roll||0,this.symbol.heading||0]}}},c}(n);return n.PRIMITIVE_BOUNDING_BOX=G,n});