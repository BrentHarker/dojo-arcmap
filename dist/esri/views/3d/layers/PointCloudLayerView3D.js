//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/HandleRegistry ../../../core/watchUtils ../../../core/promiseUtils ../../../core/screenUtils ../../../request ../../layers/LayerView ../support/projectionUtils ../support/orientedBoundingBox ./support/LayerViewUpdatingPercentage ../lib/glMatrix ./i3s/I3SBinaryReader ./i3s/I3SUtil ./i3s/PointCloudRendererUtil ./i3s/PointRenderer ./i3s/PagedNodeIndex ./i3s/LoDUtil ./i3s/LEPCC dojo/Deferred dojo/promise/all dojo/errors/CancelError ../webgl-engine/lib/RenderSlot".split(" "),
function(e,M,A,g,f,B,k,r,t,u,C,v,D,E,p,w,x,l,F,G,q,H,I,y,J,K){function z(e){var c=[];return e.forEach(function(a){return c.push(a)}),c}var L=p.vec4d.create();e=function(e){function c(){var a=null!==e&&e.apply(this,arguments)||this;return a.maximumPointCount=4E6,a._renderer=null,a._rendererAdded=!1,a._renderedNodes=new Set,a._updateViewNeeded=!0,a._idleUpdatesEnabled=!0,a._lodFactor=1,a._handles=new B,a._indexQueue=[],a._workQueue=[],a._idleQueue=[],a._indexPagesLoading=new Map,a._loadingNodes=new Map,
a._totalWork=0,a._index=null,a._nodeIdArray=[],a}return A(c,e),Object.defineProperty(c.prototype,"pointScale",{get:function(){var a=l.getSplatSizeAlgorithm(this.layer.renderer);return a&&null!=a.scaleFactor?a.scaleFactor:1},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"pointMinSize",{get:function(){var a=l.getSplatSizeAlgorithm(this.layer.renderer);return a&&null!=a.minSize?a.minSize:4},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"useRealWorldSymbolSizes",
{get:function(){var a=l.getFixedSizeAlgorithm(this.layer.renderer);return a&&null!=a.useRealWorldSymbolSizes?a.useRealWorldSymbolSizes:!1},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"pointSize",{get:function(){var a=l.getFixedSizeAlgorithm(this.layer.renderer);return a&&null!=a.size?a.size:0},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"inverseDensity",{get:function(){return this.layer.renderer?96/this.layer.renderer.pointsPerInch:5},enumerable:!0,configurable:!0}),
Object.defineProperty(c.prototype,"_clippingBox",{get:function(){var a=[];return v.extentToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?a:null},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"_elevationOffset",{get:function(){var a=this.layer.elevationInfo;return a&&"absolute-height"===a.mode?a.offset||0:0},enumerable:!0,configurable:!0}),c.prototype.initialize=function(){var a=this;x.checkPointCloudLayerValid(this.layer);x.checkPointCloudLayerCompatibleWithView(this.layer,
this.view);this._initRenderer();var b=this._initNodePages(),d={idleBegin:function(){return a._idleBegin()},idleEnd:function(){return a._idleEnd()},needsUpdate:function(){return!0},idleFrame:function(b){return a._idleFrame(b)}};b.then(function(){a._handles.add(k.init(a,"suspended",function(b){b?a.view.resourceController.deregisterIdleFrameWorker(a):a.view.resourceController.registerIdleFrameWorker(a,d)}))});this._handles.add(k.init(this,"_clippingBox",function(){return a._updateViewNeeded=!0}));this._handles.add(k.init(this,
"_elevationOffset",function(){return a._elevationOffsetChanged()}));this._handles.add(k.init(this.layer,"renderer",function(){return a._rendererChanged()}));this.addResolvingPromise(b)},c.prototype.destroy=function(){this.view.resourceController.deregisterIdleFrameWorker(this);this._handles.destroy();this._destroyRenderer()},c.prototype._initRenderer=function(){var a=this;this._renderer=new F;this._handles.add(k.init(this.layer,"id",function(b){a._renderer.layerId=b}));this._handles.add(k.init(this,
"_clippingBox",function(b){a._renderer.clippingBox=b}));this._handles.add(k.init(this,"_clippingBox",function(b){a._renderer.clippingBox=b}));this._handles.add(k.init(this,"suspended",function(b){a._setPointsVisible(!b)}));this._handles.add(k.init(this,"pointScale",function(b){a._renderer.scaleFactor=b}));this._handles.add(k.init(this,"pointMinSize",function(b){b=t.pt2px(b);a._renderer.minSizePx=b}));this._handles.add(k.init(this,"useRealWorldSymbolSizes",function(b){a._renderer.useRealWorldSymbolSizes=
b}));this._handles.add(k.init(this,"pointSize",function(b){var d=t.pt2px(b);a._renderer.size=b;a._renderer.sizePx=d}));this._handles.add(k.init(this,["inverseDensity","maximumPointCount"],function(){a._updateViewNeeded=!0}));this._handles.add(k.init(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",function(b){a._lodFactor=b;a._updateViewNeeded=!0}))},c.prototype._destroyRenderer=function(){this._setPointsVisible(!1)},c.prototype._setPointsVisible=function(a){a&&!this._rendererAdded?(this.view._stage.addExternalRenderer([K.OPAQUE_EXTERNAL],
this._renderer),this._rendererAdded=!0):!a&&this._rendererAdded&&(this.view._stage.removeExternalRenderer(this._renderer),this._rendererAdded=!1)},c.prototype._rendererChanged=function(){this._clearNodeState();this._renderer.useFixedSizes=l.rendererUsesFixedSizes(this.layer.renderer);this._updateViewNeeded=!0},c.prototype._elevationOffsetChanged=function(){var a=this;this._clearNodeState();this._initNodePages().then(function(){a._updateViewNeeded=!0})},c.prototype.displayNodes=function(a){this._cancelNodeLoading();
this._workQueue=q.nodeDiff(z(this._renderedNodes),a,this._index);q.sortFrontToBack(this._workQueue,this.view._stage.getCamera().viewForward,this._index);this._totalWork=this._computeWork();this._updateLoading()},c.prototype.cancelLoading=function(){this._cancelNodeLoading();this._cancelIndexLoading()},c.prototype._cancelNodeLoading=function(){var a=[];this._loadingNodes.forEach(function(b){return a.push(b)});this._loadingNodes.clear();for(var b=0;b<a.length;b++){var d=a[b];d.cancel()}this._workQueue=
[];for(var b=0,c=this._idleQueue;b<c.length;b++)d=c[b],d.cancel();this._idleQueue=[];this._totalWork=this._computeWork();this._updateLoading()},c.prototype._cancelIndexLoading=function(){this._indexQueue=[];this._indexPagesLoading.forEach(function(a){return a.cancel()});this._indexPagesLoading.clear();this._totalWork=this._computeWork();this._updateLoading()},c.prototype._clearNodeState=function(){var a=this;this._renderedNodes.forEach(function(b){return a._removeFromRenderer(b)});this._cancelNodeLoading()},
c.prototype._idleBegin=function(){this._idleUpdatesEnabled&&(this._updateViewNeeded=!1,this.updateViewWhenIdle())},c.prototype._idleEnd=function(){this.cancelLoading()},c.prototype._idleFrame=function(a){if(this._idleUpdatesEnabled){for(this._updateViewNeeded&&!a.done()&&(this._updateViewNeeded=!1,this.updateViewWhenIdle());0<this._indexQueue.length&&!a.done();)this._processIndexQueue();for(;0<this._workQueue.length&&this._canSchedule(this._workQueue[0])&&!a.done();)this._processWorkQueue();for(;0<
this._idleQueue.length&&!a.done();)this._idleQueue.shift().resolve()}},c.prototype._schedule=function(){var a=new I;return this._idleQueue.push(a),a.promise},c.prototype._processIndexQueue=function(){var a=this,b=this._indexQueue.shift();this._indexPagesLoading.set(b,this._loadNodePage(b));this._indexPagesLoading.get(b).then(function(d){a._index.addPage(b,d,a._elevationOffset);a._updateViewNeeded=!0}).always(function(){a._indexPagesLoading["delete"](b)})},c.prototype._canSchedule=function(a){if(8<=
this._loadingNodes.size)return!1;for(var b=0;b<a.remove.length;b++)if(!this._renderedNodes.has(a.remove[b]))return!1;return!0},c.prototype._processWorkQueue=function(){var a=this,b=this._workQueue.shift();if(0!==b.load.length){if(8<b.load.length&&1===b.remove.length)for(var d=q.splitWorkEntry(b,this._index),b=d[0],c=1;c<d.length;c++)this._workQueue.push(d[c]);y(b.load.map(function(b){return a._loadingNodes.has(b)||a._loadingNodes.set(b,a.loadNode(b)),a._loadingNodes.get(b)})).then(function(c){for(var d=
0;d<b.load.length;d++)a._addToRenderer(b.load[d],c[d]);for(d=0;d<b.remove.length;d++)a._removeFromRenderer(b.remove[d])}).always(function(){for(var d=0;d<b.load.length;d++)a._loadingNodes["delete"](b.load[d]);a._updateLoading()});this._updateLoading()}else for(c=0;c<b.remove.length;c++)this._removeFromRenderer(b.remove[c])},c.prototype._computeWork=function(){for(var a=0,b=0;b<this._workQueue.length;b++)a+=this._workQueue[b].load.length;return a+=this._loadingNodes.size,a+=(this._indexQueue.length+
this._indexPagesLoading.size)*this._index.pageSize,a+=this._updateViewNeeded?100:0},Object.defineProperty(c.prototype,"updating",{get:function(){return 0<this._computeWork()},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"updatingPercentageValue",{get:function(){var a=this._computeWork();return 100*Math.max(0,this._totalWork-a)/this._totalWork},enumerable:!0,configurable:!0}),c.prototype._updateLoading=function(){this.notifyChange("updating");this.notifyChange("updatingPercentageValue")},
c.prototype._initNodePages=function(){var a=this;return this._index=new G(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,this.layer.store.index.nodePerIndexBlock),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadNodePage(0).then(function(b){a._index.addPage(0,b,a._elevationOffset)})},c.prototype._loadNodePage=function(a){return this._requestJSON(this.baseUrl+"/nodepages/"+a*this._index.pageSize).then(function(a){return a.data.nodes})},
c.prototype.updateViewWhenIdle=function(){for(var a=this.inverseDensity/this._lodFactor,b=this.maximumPointCount*this._lodFactor,d=this._computeNodesForMinimumDensity(a),c=this._computePointCount(d),h=Math.sqrt(c/(.75*b));c>b;)a*=h,d=this._computeNodesForMinimumDensity(a),c=this._computePointCount(d),h=Math.sqrt(2);this.displayNodes(d)},c.prototype._computePointCount=function(a){for(var b=0,d=0;d<a.length;d++){var c=this._index.getNode(a[d]);c&&(b+=c.pointCount)}return b},c.prototype._computeNodesForMinimumDensity=
function(a){var b=this,c=this.view._stage.getCamera(),e=c.frustumPlanes,h=this._clippingBox,m=c.viewForward,f=p.vec3d.dot(m,c.eye),g=p.vec4d.set4(m[0],m[1],m[2],-f,L),k=c.perPixelRatio,l=a*a,n=this._nodeIdArray;return n.length=0,this._traverseVisible({frustumPlanes:e,clippingBox:h},{predicate:function(a,c,d){if(!d)return!1;if(0===c.childCount)return n.push(a),!1;d=b._index.getRenderObb(a);c=b._computeAveragePixelArea(d,c.effectiveArea,c.pointCount,g,k);return l>=c?(n.push(a),!1):!0},pageMiss:function(a,
c){n.push(a);0>b._indexQueue.indexOf(c)&&b._indexQueue.push(c)}}),n},c.prototype._computeAveragePixelArea=function(a,b,c,e,h){a=Math.max(1E-7,D.minimumDistancePlane(a,e));return b/(a*a)/(4*h*h)/c},c.prototype.loadNode=function(a){var b=this,c=this._index.getNode(a),e=l.getRendererInfo(this.layer),h=[];return this._schedule().then(function(){var d=null!=c.resourceId?c.resourceId:a,f=b.loadGeometry(d),g=b.loadAttribute(d,e.primaryAttribute),d=b.loadAttribute(d,e.modulationAttribute);return h=[f,g,d],
y(h)}).then(function(a){var d=a[1],h=a[2],m=b.readGeometry(b.layer.store.defaultGeometrySchema,a[0]),f=l.evaluateRenderer(e,d,h,m,c.pointCount);return b._schedule().then(function(){return{positions:m,rgb:f}})}).then(function(c){var d=c.positions;c=c.rgb;var e=p.vec3.create(b._index.getRenderCenter(a));b._applyElevationOffsetInPlace(d,b._elevationOffset);d=b._transformCoordinates(d,e);return{origin:d.origin,points:d.points,rgb:c}}).otherwise(function(a){if(a instanceof J)for(var b=0,c=h;b<c.length;b++)c[b].cancel();
return r.reject(a)})},c.prototype.readGeometry=function(a,b){if(null==a.encoding||""===a.encoding){a=w.createGeometryDataIndex(b,a,!1);b=w.createTypedView(b,a.vertexAttributes.position);var c=a.header.fields;a=[c.offsetX,c.offsetY,c.offsetZ];for(var c=[c.scaleX,c.scaleY,c.scaleZ],e=b.length/3,h=new Float64Array(3*e),f=0;e>f;f++)h[3*f]=b[3*f]*c[0]+a[0],h[3*f+1]=b[3*f+1]*c[1]+a[1],h[3*f+2]=b[3*f+2]*c[2]+a[2];return h}return"lepcc-xyz"===a.encoding?H.decodeXYZ(b).result:void 0},c.prototype.loadGeometry=
function(a){return this._requestBinary(this.baseUrl+"/nodes/"+a+"/geometries/0").then(function(a){return a.data})},c.prototype.loadAttribute=function(a,b){return b&&b.storageInfo?this._requestBinary(this.baseUrl+"/nodes/"+a+"/attributes/"+b.storageInfo.key).then(function(a){return a.data}):r.resolve(null)},c.prototype._requestJSON=function(a){return u(a,{query:{f:"json",token:this.layer.token},responseType:"json"})},c.prototype._requestBinary=function(a){return u(a,{query:{token:this.layer.token},
responseType:"array-buffer"})},c.prototype._removeFromRenderer=function(a){this._renderedNodes.has(a)&&(this._renderer.removeNode(""+a),this._renderedNodes["delete"](a))},c.prototype._addToRenderer=function(a,b){if(!this._renderedNodes.has(a)){this._renderedNodes.add(a);var c=this._index.getNode(a),e=this._index.getRenderObb(a);this._renderer.addNode({id:""+a,coordinates:b.points,origin:b.origin,rgb:b.rgb,splatSize:Math.sqrt(c.effectiveArea/c.pointCount),obb:e})}},c.prototype._transformCoordinates=
function(a,b){var c=a.length/3;if(!v.bufferToBuffer(a,this.layer.spatialReference,0,a,this.view.renderCoordsHelper.spatialReference,0,c))throw Error("Can't reproject");for(var e=new Float32Array(3*c),f=0;c>f;f++)e[3*f]=a[3*f]-b[0],e[3*f+1]=a[3*f+1]-b[1],e[3*f+2]=a[3*f+2]-b[2];return{points:e,origin:b}},c.prototype._applyElevationOffsetInPlace=function(a,b){var c=a.length/3;if(0!==b)for(var e=0;c>e;e++)a[3*e+2]+=b},c.prototype.getStats=function(){var a=this;return{"Rendered Nodes":this._renderedNodes.size,
"Rendered Points":z(this._renderedNodes).reduce(function(b,c){return b+a._index.getNode(c).pointCount},0),"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length}},c}(f.declared(C,E));return g([f.property()],e.prototype,"view",void 0),g([f.property()],e.prototype,"layer",void 0),g([f.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],e.prototype,"baseUrl",void 0),g([f.property({readOnly:!0,dependsOn:["layer.renderer"]})],e.prototype,"pointScale",
null),g([f.property({readOnly:!0,dependsOn:["layer.renderer"]})],e.prototype,"pointMinSize",null),g([f.property({readOnly:!0,dependsOn:["layer.renderer"]})],e.prototype,"useRealWorldSymbolSizes",null),g([f.property({readOnly:!0,dependsOn:["layer.renderer"]})],e.prototype,"pointSize",null),g([f.property({readOnly:!0,dependsOn:["layer.renderer"]})],e.prototype,"inverseDensity",null),g([f.property()],e.prototype,"maximumPointCount",void 0),g([f.property({readOnly:!0,dependsOn:["view.clippingArea"]})],
e.prototype,"_clippingBox",null),g([f.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],e.prototype,"_elevationOffset",null),g([f.property()],e.prototype,"updating",null),g([f.property()],e.prototype,"updatingPercentageValue",null),e=g([f.subclass("esri.views.3d.layers.PointCloudLayerView3D")],e)});