//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../layers/IntegratedMeshLayer ../../../core/arrayUtils ../../../core/watchUtils ../../../core/promiseUtils ../../../core/Logger ../../../core/Collection ../../../core/lang dojo/_base/lang dojox/color/_base dojo/has ../../layers/LayerView ../../../Graphic ../../../symbols/Symbol3D ../../../tasks/support/Query ./i3s/I3SUtil ./i3s/I3SBinaryReader ./i3s/I3SElevationProvider ./i3s/I3SProjectionUtil ./i3s/I3SQueryEngine ./i3s/Highlights ./i3s/FeatureChangeNotifier ./graphics/graphicUtils ./support/LayerViewUpdatingPercentage ../support/projectionUtils ../support/aaBoundingBox ../webgl-engine/Stage ../webgl-engine/lib/Layer ../webgl-engine/lib/Geometry ../webgl-engine/lib/GeometryData ../webgl-engine/lib/Object3D ../webgl-engine/lib/Texture ../webgl-engine/materials/Material ./support/attributeUtils ../webgl-engine/lib/Util ../webgl-engine/lib/base64Binary ../lib/glMatrix".split(" "),
function(x,wa,X,A,r,R,Y,B,C,Z,aa,ba,ca,da,ea,fa,E,ga,ha,F,ia,ja,M,ka,la,ma,S,na,N,D,oa,pa,qa,P,ra,J,sa,Q,q,xa,K){function T(n,e,a,b){var c,d=!1;e.encoding===F.DDS_ENCODING_STRING?c=J.DDS_ENCODING:d=!(q.isPowerOfTwo(n.width)&&q.isPowerOfTwo(n.height));n=e.usedByEngineMats.some(function(a){return a.getParams().atlasRegions})||e.atlas;a=(a||!n)&&!d;return{mipmap:a,wrapClamp:n||!e.wrap,disableAnisotropy:n&&a&&b,encoding:c,noUnpackFlip:!0}}var n=oa.ModelContentType,z=Z.getLogger("esri.layers.SceneService"),
U=[1,1,1,1],ta=[.8,.8,.8],ua=[.5,.5,.5];x=function(x){function e(){var a=null!==x&&x.apply(this,arguments)||this;return a._queryEngine=null,a._controllerCreated=!1,a._highlights=new la(a),a._hasColors=!1,a._hasTextures=!1,a._hasData=!1,a._definitionExpressionErrors=0,a._maxDefinitionExpressionErrors=20,a}return X(e,x),Object.defineProperty(e.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),
e.prototype.initialize=function(){var a=this;F.checkSceneLayerValid(this.layer);F.checkSceneLayerCompatibleWithView(this.layer,this.view);var b=this.layer.version,b=!ea("trident")||1<b.major||1===b.major&&3<b.minor;this.useCompressedTextures=this.view.has("s3tc")&&b;this._disableAtlasAnisotropy=(this._enableAtlasMipMaps=this.view.has("standardDerivatives"))&&!this.view.has("shaderTextureLOD");this._initGraphicsController();this.dbg=!1;this.maxGpuMemory=1E3;this.geoMemoryEstimate=this.texMemoryEstimate=
this.gpuMemoryEstimate=0;this._stage=this.view._stage;this._matId2Meta={};this._texId2Meta={};this._requestedTexImageIds={};this._nodeId2Meta={};this._colorOverride=null;for(var b=new Uint8Array(256),c=0;c<b.length;c++)b[c]=255;this._whiteTexture=new J(b,"white",{width:8,height:8});this._stage.add(n.TEXTURE,this._whiteTexture);this._addThisLayerToStage();this._elevationProvider=new ja(this,this._engineLayer);this._layerEventHandles=[B.init(this.layer,"renderer",function(b){return a._rendererChange(b)}),
B.watch(this,"fullOpacity",function(b){return a._opacityChange(b)}),B.init(this.layer,"objectIdFilter",function(){return a._filterChange()}),B.init(this,"_controller.parsedDefinitionExpression",function(){return a._filterChange()}),B.init(this.view,"clippingArea",function(){return a._clippingAreaChanged()}),B.init(this,"suspended",function(b){return a.setVisibility(!b)})];this.debugLODVis=this.debugNodeVis=!1},e.prototype.destroy=function(){this._stage.remove(n.TEXTURE,this._whiteTexture.getId());
this._removeThisLayerFromStage();this._layerEventHandles.forEach(function(a){a.remove()});this._stage=null;null!=this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2Meta=this._texId2Meta=this._matId2Meta=null},e.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},e.prototype.isUpdating=function(){return this._controllerCreated?!(!this._controller||!this._controller.updating):
!0},e.prototype.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a},e.prototype.memEstimateTextureRemoved=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a},e.prototype.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage()/1E6;this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a},e.prototype.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage()/1E6;this.gpuMemoryEstimate-=
a;this.geoMemoryEstimate-=a},e.prototype.isBundleAlreadyAddedToStage=function(a,b){return this._nodeId2Meta[a.id]&&this._nodeId2Meta[a.id].engineObjectsPerBundle&&null!=this._nodeId2Meta[a.id].engineObjectsPerBundle[b]},e.prototype._initGraphicsController=function(){var a=this,b={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:function(b,d){return a.isBundleAlreadyAddedToStage(b,d)},isOverMemory:function(){return a.isOverMemory()},removeNodeData:function(b){return a._removeNodeDataFromStage(b)},
removeFeatures:function(b,d){return a._removeFeatures(b,d)},getAddedFeatures:function(b){return a._getAddedFeatures(b)},getAddedNodeIDs:function(){return a._getAddedNodeIDs()},areAllBundlesLoaded:function(b){return a._areAllBundlesLoaded(b)},wholeNodeSwitchEnabled:!0};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:b,layerViewOptionalFunctions:{additionalStartNodeLoadingHandler:function(){return a._startNodeLoading()},additionalCancelNodeLoadingHandler:function(){return a.cancelNodeLoading()},
getTexturePrefetchFunctions:function(){return{_calcDesiredTextureLOD:function(b,d){return a._calcDesiredTextureLOD(b,d)},_imageIsPartOfTextureBundle:function(b){return a._imageIsPartOfTextureBundle(b)},_matId2Meta:a._matId2Meta,_texId2Meta:a._texId2Meta,useCompressedTextures:function(){return a.useCompressedTextures}}},_nodeDebugVisualizer:this._nodeDebugVisualizer,setPolygonOffset:function(b,d){return a._setPolygonOffset(b,d?1:0)},traversalOptions:{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1,
allowPartialOverlaps:!1},getLoadedAttributes:function(b){return a.getLoadedAttributes(b)},setAttributeData:function(b,d,f){return a.setAttributeData(b,d,f)}}}).then(function(b){a._controller=b;a._featureChangeNotifier=new ma.FeatureChangeNotifier(a,b);b.watch("rootNodeVisible",function(){a.notifyChange("suspended")})}).always(function(){a._controllerCreated=!0;a.notifyChange("updating")})},e.prototype.setMaxGpuMemory=function(a){this.maxGpuMemory=a},e.prototype.setVisibility=function(a){if(this._stage&&
this._engineLayer){var b=this._engineLayer.getId(),c=0<=this._stage.getViewContent().indexOf(b);!!a!==c&&(b=[b],(null!=this._nodeDebugVisualizer&&b.push(this._nodeDebugVisualizer.engineLayer.getId()),a)?(this._stage.addToViewContent(b),a=this._isIntegratedMesh()?"im":"scene",this.view.elevationProvider.register(a,this._elevationProvider),this._elevationProvider.visibilityChanged()):(this._stage.removeFromViewContent(b),this._elevationProvider.visibilityChanged(),this.view.elevationProvider.unregister(this._elevationProvider)))}},
e.prototype.getEngineLayer=function(){return this._engineLayer},e.prototype.getStats=function(){var a={nodesInIndex:0,knownFeatures:0,activeMaterials:0,"Total GPU Memory Estimate":this.gpuMemoryEstimate+"MB","Geometry Memory Estimate":this.geoMemoryEstimate+"MB","Texture Memory Estimate":this.texMemoryEstimate+"MB"};if(!this._controller)return a;for(var b=0,c=Object.keys(this._controller.nodeIndex);b<c.length;b++){var d=c[b];a.nodesInIndex++;d=this._controller.nodeIndex[d];null!=d.features&&(a.knownFeatures+=
d.features.length)}return a.activeMaterials=Object.keys(this._matId2Meta).length,a},e.prototype._addThisLayerToStage=function(){var a=this._stage;this._initTexture=new J(null,"i3sInitTexture");a.add(n.TEXTURE,this._initTexture);var b=this.layer.id;this._engineLayer=b=new pa(b,{},b);a.add(n.LAYER,b);null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose()},e.prototype._removeThisLayerFromStage=function(){if(this.cancelNodeLoading(),null!=this._engineLayer){var a=this._stage;if(a.remove(n.TEXTURE,
this._initTexture.getId()),null!=this._controller)for(var b in this._controller.nodeIndex)this._controller.nodeIndex.hasOwnProperty(b)&&(this._removeNodeDataFromStage(this._controller.nodeIndex[b]),delete this._controller.nodeIndex[b]);q.assert(q.objectEmpty(this._nodeId2Meta));q.assert(q.objectEmpty(this._matId2Meta));q.assert(q.objectEmpty(this._texId2Meta));a.remove(n.LAYER,this._engineLayer.getId());null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose();this._nodeDebugVisualizer=
void 0;this._matId2Meta={};this._texId2Meta={};this._requestedTexImageIds={};this._nodeId2Meta={};this._engineLayer=void 0;this.gpuMemoryEstimate=0}},e.prototype._startNodeLoading=function(){this._updateAllTextureLOD()},e.prototype.cancelNodeLoading=function(){null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.clear();this._requestedTexImageIds={}},e.prototype._isAllHidden=function(a){a=this._nodeId2Meta[a.id].engineObjects;for(var b=0;b<a.length;b++)if(!a[b].isAllHidden())return!1;return!0},
e.prototype.getLoadedAttributes=function(a){return(a=this._nodeId2Meta[a.id])&&1===a.engineObjects.length?a.engineObjects[0].getMetadata().loadedAttributes:void 0},e.prototype.setAttributeData=function(a,b,c){var d=this._nodeId2Meta[a.id];if(d&&1===d.engineObjects.length){var d=d.engineObjects[0],f=d.getMetadata();f.loadedAttributes=b;f.attributeData=c;this._setObjectSymbology(d);this._applyFilters(a);this._elevationProvider.visibilityChanged(d)}},e.prototype._createUnitTestData=function(a){var b=
this.view.navigation.targetCamera,b={viewParams:{eye:b.eye,center:b.center,up:b.up,viewMatrix:b.viewMatrix,projectionMatrix:b.projectionMatrix,fovX:b.fovX,viewport:b.viewport,perPixelRatio:b.perPixelRatio},visibleObjects:[]};a=a.getAll("objects");for(var c in a){var d=a[c];if(d.getParentLayer()===this._engineLayer){var f=d.getMetadata(),d=f.i3sNode,f=f.features.map(function(a){return a.id});f.sort();b.visibleObjects.push({featureIDs:f,nodeId:d})}}return JSON.stringify(b)},e.prototype.isOverMemory=
function(){if(this.gpuMemoryEstimate>this.maxGpuMemory&&this.gpuMemoryEstimate!==this.warnGpuMemoryEstimate){this.warnGpuMemoryEstimate=this.gpuMemoryEstimate;var a=function(a){return a.toLocaleString(void 0,{maximumFractionDigits:1})+" Mb"};z.warn("GPU Memory Limit exceeded!\nLimit: "+a(this.maxGpuMemory)+" Current: "+a(this.gpuMemoryEstimate)+"\n(Textures: "+a(this.texMemoryEstimate)+" Geometry: "+a(this.geoMemoryEstimate)+")")}return this.gpuMemoryEstimate>this.maxGpuMemory},e.prototype._getAddedFeatures=
function(a){if(null==this._nodeId2Meta[a])return null;var b=[];a=this._nodeId2Meta[a].engineObjects;for(var c=0;c<a.length;c++)b=b.concat(a[c].getMetadata().features);return b},e.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodeId2Meta)},e.prototype._calcEngineMaterialTransparencyParams=function(a,b,c){var d=this.fullOpacity,f=1-q.clamp(q.fallbackIfUndefined(b.transparency,0),0,1);a=1>f||1>d||a&&ba.endsWith(a.channels,"a")||!0===b.useVertexColorAlpha||c;return{opacity:f,layerOpacity:d,
transparent:a}},e.prototype._calcEngineMaterialDoubleSidedParams=function(a){return null!=a.doubleSided?a.doubleSided:!0},e.prototype._calcEngineMaterialCullFaceParams=function(a){return a.cullFace?a.cullFace:null!=a.doubleSided?a.doubleSided?"none":"back":"none"},e.prototype._createEngineMaterial=function(a,b,c,d,f,g){var k,h;null!=a&&(h=this._texId2Meta[b],k=h&&h.engineTex?h.engineTex.getId():this._initTexture.getId());var e,p,m=c.params,v=q.fallbackIfUndefined(m.diffuse,ta);null!=a&&(p=F.getAppropriateTextureEncoding(a.encoding,
this.useCompressedTextures),e=-1<p?a.encoding[p]:a.encoding);"standard"!==c.type&&z.warn("Unknown material type '"+c.type+"', must be 'standard'");void 0===m.reflectivity&&z.warn("Material parameter 'reflectivity' is missing.");c=this._isIntegratedMesh();k={ambient:this._colorOverride||v,diffuse:this._colorOverride||v,specular:q.fallbackIfUndefined(m.specular,ua),shininess:q.fallbackIfUndefined(m.shininess,64),atlasRegions:m.vertexRegions,textureId:k&&this._colorOverride?this._whiteTexture.getId():
k,vertexColors:this._hasVertexColors(),symbolColors:this._hasSymbolColors(),flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(m),cullFace:this._calcEngineMaterialCullFaceParams(m),writeStencil:c,receiveSSAO:!c,groundNormalShading:c};c||(v=this._calcEngineMaterialTransparencyParams(a,m),ca.mixin(k,v));k=new sa(k,d);if(k.metadata={i3sMatId:d,i3sTexId:b,i3sTex:a,i3sMatParams:m},null!=a){h?h.usedByEngineMats.push(k):(h={id:b,featureMBS:[],usedByEngineMats:[k],images:a.images,encoding:e,encodingIdx:p,
atlas:!0===a.atlas,wrap:"none"!==a.wrap[0]||"none"!==a.wrap[1]},this._texId2Meta[b]=h);for(a=0;a<f.length;a++)h.featureMBS.push(f[a].engineMBS);if(void 0!==g[b]){null==h.engineTex&&(f=g[b].data,a=T(f,h,this._enableAtlasMipMaps,this._disableAtlasAnisotropy),h.engineTex=new J(f,h.id,a),this._stage.add(n.TEXTURE,h.engineTex),h.desiredLOD=g[b].desiredLOD,h.curLOD=h.desiredLOD,this.memEstimateTextureAdded(h.engineTex));f=h.engineTex.getId();for(a=0;a<h.usedByEngineMats.length;a++)e=h.usedByEngineMats[a],
null==this._colorOverride&&e.setParameterValues({textureId:f}),e.metadata.originalTextureId=f;g[b].createdTextureForDomImage();delete g[b]}else this._updateTextureLOD(h)}return this._matId2Meta[d]||(this._matId2Meta[d]={}),this._matId2Meta[d][b]={engineMat:k,refCount:1},k},e.prototype._createVertexArrays=function(a,b){var c=a.params.vertexAttributes;a={};for(var d=0,f=Object.keys(c);d<f.length;d++){var g=f[d];if("classification"!==g){var k=c[g],e=ia.valueType2TypedArrayClassMap[k.valueType];q.assert(null!=
e,"unsupported vertex attribute value type: "+k.valueType);a[g]={data:new e(b,k.byteOffset,k.count*k.valuesPerElement),size:k.valuesPerElement}}}b=Array.isArray(c.position)?c.position.length/3:c.position.count;if(this._hasVertexColors()&&null==a[q.VertexAttrConstants.COLOR])for(c=new Uint8Array(4*b),a[q.VertexAttrConstants.COLOR]={data:c,size:4},d=0;d<c.length;d++)c[d]=255;this._hasSymbolColors()&&(c=new Uint8Array(4*b),a[q.VertexAttrConstants.SYMBOLCOLOR]={data:c,size:4});null==a[q.VertexAttrConstants.NORMAL]&&
(c=new Float32Array(3*b),a[q.VertexAttrConstants.NORMAL]={data:c,size:3});return a},e.prototype._hasNonWhiteColors=function(a){if("color"in a){a=a.color.data;for(var b=0;b<a.length;b++)if(255!==a[b])return!0}return!1},e.prototype._createEngineMats=function(a,b,c,d,f){for(var g=a.params.components.length,e=Array(g),h=0;g>h;h++){var l=a.params.components[h],p=l.materialID,m=c.materialDefinitions[p];null!=m.href&&(m=d[m.hrefConcat].materialDefinitions[p]);q.assert(void 0!==m,"geometry wants unknown material "+
p);var v=l.textureID||"none",n=void 0;"none"!==v&&((null==c.textureDefinitions||null==c.textureDefinitions[v])&&z.warn("textureDefinitions missing in shared resource"),n=c.textureDefinitions[v]);l=void 0;this._matId2Meta[p]&&this._matId2Meta[p][v]?(p=this._matId2Meta[p][v],l=p.engineMat,p.refCount++):l=this._createEngineMaterial(n,v,m,p,b,f);e[h]=l}return e},e.prototype._areAllBundlesLoaded=function(a){if(null==this._nodeId2Meta[a.id]||null==this._nodeId2Meta[a.id].engineObjectsPerBundle)return!1;
for(var b=0;b<a.featureData.length;b++)if(null==this._nodeId2Meta[a.id].engineObjectsPerBundle[b])return!1;return!0},e.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},e.prototype._findGraphicNodeAndIndex=function(a){a=Q.attributeLookup(a.attributes,this._getObjectIdField());for(var b=0,c=Object.keys(this._nodeId2Meta);b<c.length;b++)for(var d=c[b],f=this._nodeId2Meta[d].engineObjects,g=0;g<f.length;g++){var e=f[g].getMetadata().featureIds.indexOf(a);if(-1!==e)return{node:this._controller.nodeIndex[d],
nodeId:d,bundleNr:g,index:e}}return null},e.prototype._getGraphicIndices=function(a,b,c){a=this._nodeId2Meta[a.id].engineObjects;if(!a||!a[b])return[];b=a[b].getMetadata();a=[];for(var d=this._getObjectIdField(),f=0;f<c.length;f++){var e=Q.attributeLookup(c[f].attributes,d),e=b.featureIds.indexOf(e);-1!==e&&a.push(e)}return a},e.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(null!=a&&(a=this._boundingBoxCornerPoints(a.index,this._nodeId2Meta[a.nodeId].engineObjects[a.bundleNr],
new Float64Array(24)),N.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))){var b=D.create(D.NEGATIVE_INFINITY);return D.expandBuffer(b,a,0,8),C.resolve({boundingBox:b,screenSpaceObjects:[]})}return C.reject()},e.prototype.whenGraphicAttributes=function(a,b){var c=this;return F.whenGraphicAttributes(this.layer,[a],this._getObjectIdField(),b,function(){var b=c._findGraphicNodeAndIndex(a);return{node:b.node,indices:[b.index]}}).then(function(a){return a[0]})},e.prototype.getGraphicsFromStageObject=
function(a,b){if(this.layer instanceof R)return C.reject();var c=a.getMetadata();a=a.getFaceRangeIndexFromTriangleNr(b);return null!=a&&null!=c.featureIds&&a<c.featureIds.length?(c=this._createGraphic(a,c),C.resolve(c)):C.reject()},e.prototype._addBundle=function(a,b,c,d,f,e,k){if(!this._hasTextures&&null!=a.textureData&&0<a.textureData.length&&(this._hasTextures=!0),this._hasData=!0,!0===this.debugNodeVis&&null!=this._nodeDebugVisualizer){var g="grey";switch(a.level){case 1:g="red";break;case 2:g=
"green";break;case 3:g="blue";break;case 4:g="yellow";break;case 5:g="magenta";break;case 6:g="brown"}this._nodeDebugVisualizer.show(a,this._controller.crsIndex,g)}var g=this._stage,l={};l[n.OBJECT]={};l[n.GEOMETRY]={};l[n.MATERIAL]={};l[n.TEXTURE]={};var p=this._engineLayer,m=p.getId(),v=d[a.sharedResource.hrefConcat];if(null!=this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjectsPerBundle&&this._nodeId2Meta[a.id].engineObjectsPerBundle[k])return this._applyFilters(a),void(null!=f&&
f.done());if(!this.isOverMemory()){if(null==this._nodeId2Meta[a.id]&&(this._nodeId2Meta[a.id]={engineObjects:[],engineObjectsPerBundle:[]}),this._nodeId2Meta[a.id].engineObjectsPerBundle[k]=[],null==b)return void(null!=f&&f.done());for(var V=0,w=0;w<b.length;w++){var t=b[w],u=t.faceRanges,x=t.componentOffsets,W=t.geometries,L=t.featureIds,r=t.features,H=d[a.geometryData[k].hrefConcat];q.assert(H instanceof ArrayBuffer,"I3S: geometry data is not an ArrayBuffer");null==H._isReprojected&&(H._isReprojected=
{});for(var z=a.id+"|"+r[0].id.toString(),A=[],D=[],G=[],O=void 0,t=function(b){var c=W[b],f=y._createVertexArrays(c,H);!y._hasColors&&y._hasNonWhiteColors(f)&&(y._hasColors=!0);var g=new P(f,P.DefaultIndices,x||P.DefaultOffsets),k=y._createEngineMats(c,r,v,d,e),h=y._controller.crsIndex,m=y.view.renderSpatialReference;(O=M.reprojectPoints(y._controller.isMeshPyramid?M.ReprojectionTypes.PER_VERTEX:M.ReprojectionTypes.BOUNDINGBOX,f.position.data,a.mbs,H._isReprojected[c.id],h,y._controller.crsVertex,
m),H._isReprojected[c.id]=!0,y._controller.isMeshPyramid)&&F.processNormals({normals:g.vertexAttributes.normal.data,positions:g.vertexAttributes.position.data,normalInd:g.indices.normal,positionInd:g.indices.position},y.layer.normalReferenceFrame||"none",function(b,c){M.reprojectNormalsPerVertex(b,a.mbs,h,c,m)});f=O.localTrafo;null!=c.transformation&&(f=K.mat4d.create(c.transformation),K.mat4d.multiply(O.localTrafo,f,f));for(c=0;c<k.length;c++){var p=k[c];l[n.MATERIAL][p.getId()]=p}g=new qa(g,z+"_"+
b);y.memEstimateGeometryAdded(g.getData());l[n.GEOMETRY][g.getId()]=g;A[b]=g;D[b]=f;G[b]=k},y=this,B=0;B<W.length;++B)t(B);u={i3sNode:a.id,ceLayer:m,features:r,faceRanges:u,featureIds:L,attributeData:c?c.attributeData:null,loadedAttributes:c?c.loadedAttributes:null,layerId:this.layer.id};V+=null!=u.featureIds?u.featureIds.length:1;u=new ra({idHint:a.id,name:z,geometries:A,materials:G,transformations:D,castShadow:!0,metadata:u});L=K.mat4d.create();K.mat4d.identity(L);K.mat4d.multiply(L,O.globalTrafo,
L);u.setObjectTransformation(L);this._nodeId2Meta[a.id].engineObjectsPerBundle[k].push(u);this._nodeId2Meta[a.id].engineObjects.push(u);l[n.OBJECT][u.getId()]=u;this._setObjectSymbology(u);this._applyFilters(a);this._highlights.objectCreated(u);this._elevationProvider.objectCreated(u)}g.beginMod();b=l[n.OBJECT];for(var I in b)b.hasOwnProperty(I)&&p.addObject(b[I]);for(var C in l)if(l.hasOwnProperty(C)){I=l[C];for(var E in I)I.hasOwnProperty(E)&&null==g.get(C,E)&&g.add(C,I[E])}g.endMod();null!=f&&
f.done();this.notifyChange("hasTexturesOrVertexColors");this._featureChangeNotifier.notify(V,0)}},e.prototype._clippingAreaChanged=function(){var a=this,b=[];if(N.extentToBoundingBox(this.view.clippingArea,b,this.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null,this._updateFilters(),this._controller){var c=this._controller.nodeIndex;c&&Object.keys(this._nodeId2Meta).forEach(function(b){return a._applyFilters(c[b])});this._controller.updateClippingArea(this.view.clippingArea)}},
e.prototype._filterChange=function(){if(this._updateFilters(),this._controller){var a=this._controller.nodeIndex;if(a)for(var b=0,c=Object.keys(this._nodeId2Meta);b<c.length;b++)this._applyFilters(a[c[b]])}},e.prototype._updateFilters=function(){var a=this,b=[];if(this.layer.objectIdFilter){var c=new Float64Array(this.layer.objectIdFilter.ids),d="include"===this.layer.objectIdFilter.method;c.sort();b.push(function(b,f){return a._objectIdFilter(c,d,f)})}if(this._controller&&this._controller.parsedDefinitionExpression&&
this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var f=this._controller.parsedDefinitionExpression,g=this._controller.definitionExpressionFields;b.push(function(b,c){return a._sqlFilter(b,f,g,c)})}this._clippingArea&&b.push(function(b,c){return a._boundingboxFilter(b,a._clippingArea,c)});this._filters=b},e.prototype._sqlFilter=function(a,b,c,d){var f={},g=new E(null,null,f);g.layer=this.layer;var e=0,h=0,l=function(a){var k=a.getMetadata();a=k.featureIds;for(var l=k.attributeData,
k=c.every(function(a){return null!=l[a]}),m=0;m<a.length&&e<d.length;m++)if(d[e]===a[m]){var n=!0;if(k){for(var n=0,v=c;n<v.length;n++){var q=v[n];f[q]=F.getCachedAttributeValue(l[q],m)}n=p._evaluateClause(b,g)}n&&(d[h]=d[e],h++);e++}},p=this,m=0;for(a=this._nodeId2Meta[a.id].engineObjects;m<a.length;m++)l(a[m]);d.length=h},e.prototype._evaluateClause=function(a,b){try{return a.testFeature(b)}catch(c){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&z.error("Error while evaluating definitionExpression: "+
c),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&z.error("Further errors are ignored"),!1}},e.prototype._objectIdFilter=function(a,b,c){for(var d=0,f=0;d<c.length;)0<=Y.binaryIndexOf(a,c[d])===b&&(c[f]=c[d],f++),d++;c.length=f},e.prototype._boundingboxFilter=function(a,b,c){var d=[0,0,0,0];N.mbsToMbs(a.mbs,this._controller.crsIndex,d,this.view.renderSpatialReference);d=null!=b?F.intersectBoundingBoxWithMbs(b,d):2;if(2!==d){var f=0,g=0;for(a=
this._nodeId2Meta[a.id].engineObjects;g<a.length;g++){var e=a[g],h=e.getMetadata().featureIds;if(0!==d){var l=e.getObjectTransformation(),p=e.getGeometryRecords()[0].getShaderTransformation();if(K.mat4d.multiply(l,p),0===l[1]&&0===l[2]&&0===l[3]&&0===l[4]&&0===l[6]&&0===l[7]&&0===l[8]&&0===l[9]&&0===l[11]&&1===l[15])for(var p=(b[0]-l[12])/l[0],m=(b[1]-l[13])/l[5],n=(b[2]-l[14])/l[10],q=(b[3]-l[12])/l[0],w=(b[4]-l[13])/l[5],l=(b[5]-l[14])/l[10],t=e.getGeometryRecords()[0].geometry.getData(),u=t.getFaces()[0].indices.position,
t=t.getVertexAttr().position.data,x=e.getMetadata().faceRanges,r=void 0,z=void 0,A=void 0,H=void 0,B=void 0,C=void 0,e=0;e<x.length&&f<c.length;e+=1)if(c[f]===h[e]){for(var r=x[e],D=r[0],G=r[1],r=z=A=Number.MAX_VALUE,H=B=C=-Number.MAX_VALUE;G>=D;D+=1)for(var E=0;3>E;E+=1)var y=3*u[3*D+E],J=t[y],I=t[y+1],y=t[y+2],r=Math.min(J,r),z=Math.min(I,z),A=Math.min(y,A),H=Math.max(J,H),B=Math.max(I,B),C=Math.max(y,C);r>q||p>H||z>w||m>B||A>l||n>C?c.splice(f,1):f++}}else{for(e=p=0;e<h.length&&f+p<c.length;e+=
1)c[f+p]===h[e]&&p++;c.splice(f,p)}}}},e.prototype._applyFilters=function(a){if(this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjects){for(var b=this._nodeId2Meta[a.id].engineObjects,c=0;c<b.length;c++){var d=b[c];d.unhideAllComponents()}if(0!==this._filters.length){for(var c=[],f=0;f<b.length;f++)d=b[f],c=c.concat(d.getMetadata().featureIds);d=c.length;for(f=0;f<this._filters.length;f++)this._filters[f](a,c);if(c.length!==d)for(f=a=0;f<b.length;f++)for(var d=b[f],e=d.getGeometryRecords()[0],
k=d.getMetadata().featureIds,h=0;h<k.length;h+=1){var l=k[h];a>=c.length||c[a]!==l?d.setComponentVisibility(e,h,!1):a++}}}},e.prototype._hideFeatures=function(a,b){var c=0;for(a=this._nodeId2Meta[a.id].engineObjects;c<a.length;c++)for(var d=a[c],f=d.getGeometryRecords()[0],e=d.getMetadata().features,k=d.hasComponents(),h=0,l=b;h<l.length;h++)for(var p=l[h],m=0;m<e.length;m++)p===e[m].id&&(k?d.setComponentVisibility(f,m,!1):d.hideAllComponents())},e.prototype._removeFeatures=function(a,b){null!=this._nodeId2Meta[a.id]&&
(this._hideFeatures(a,b),!0===this._isAllHidden(a)&&this._removeNodeDataFromStage(a))},e.prototype._removeNodeDataFromStage=function(a){if(null!=this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjects){for(var b=this._stage,c=this._engineLayer,d=0,f=this._nodeId2Meta[a.id].engineObjects,e=0;e<f.length;++e){var k=f[e];this._highlights.objectDeleted(k);this._elevationProvider.objectDeleted(k);var h=k.getMetadata(),d=d+(null!=h.featureIds?h.featureIds.length:1);c.removeObject(k);for(var h=
k.getGeometryRecords(),l=0;l<h.length;l++){var p=h[l];this.memEstimateGeometryRemoved(p.geometry.getData());b.remove(n.GEOMETRY,p.geometry.getId());for(var m=0;m<p.materials.length;m++){var v=p.materials[m],r=v.getId(),w=v.metadata.i3sMatId,t=v.metadata.i3sTexId||"none",u=this._matId2Meta[w][t];q.assert(0<u.refCount);u.refCount--;0===u.refCount&&this._removeMaterial(r,t,w,v,b)}}b.remove(n.OBJECT,k.getId())}delete this._nodeId2Meta[a.id];this._featureChangeNotifier.notify(0,d)}},e.prototype._removeMaterial=
function(a,b,c,d,f){if(f.remove(n.MATERIAL,a),"none"!==b){a=this._texId2Meta[b];var e=a.usedByEngineMats;d=e.indexOf(d);if(q.assert(-1<d),e[d]=e[e.length-1],e.pop(),1>e.length)(d=a.engineTex)&&d!==this._initTexture&&(this.memEstimateTextureRemoved(d),f.remove(n.TEXTURE,a.engineTex.getId())),a.engineTex=void 0,a.desiredLOD=-1,a.curLOD=-1,delete this._texId2Meta[b]}delete this._matId2Meta[c][b];q.objectEmpty(this._matId2Meta[c])&&delete this._matId2Meta[c]},e.prototype._updateAllTextureLOD=function(){for(var a in this._texId2Meta)this._texId2Meta.hasOwnProperty(a)&&
this._updateTextureLOD(this._texId2Meta[a])},e.prototype._calcDesiredTextureLOD=function(a,b){for(var c=0,d=0;d<a.length;d++){var f=a[d],e=K.vec3.dist(f,this._controller.camPos),f=2*f[3]/e*this._controller.screenSizeFactor;f>c&&(c=f)}c/=9;for(a=b.length-1;0<a&&b[a].size<c;)a--;return a},e.prototype._updateTextureLOD=function(a){var b=this;a.desiredLOD=this._calcDesiredTextureLOD(a.featureMBS,a.images);if(a.curLOD!==a.desiredLOD&&(0>a.curLOD||!a.curLOD||0===a.desiredLOD||a.desiredLOD>a.curLOD||a.desiredLOD<
a.curLOD-1)){if(0===a.images.length)return;var c=a.images[a.desiredLOD],d=-1<a.encodingIdx?c.hrefConcat[a.encodingIdx]:c.hrefConcat;if(!this._requestedTexImageIds[c.id]){var f={metadata:{texMeta:a,image:c}};this._requestedTexImageIds[c.id]=!0;this._imageIsPartOfTextureBundle(c)?this._controller.streamDataSupplier.request(d,"binary",f).then(this._extractTextureImageFromBlob.bind(this)):this._controller.streamDataSupplier.request(d,"image",f).then(function(a,c,d,f){b._textureImageLoaded(a,c,f.image,
f.texMeta)})}}if(a.engineTex||(a.engineTex=this._initTexture,a.curLOD=-1),this.debugLODVis)for(c=da.fromHsv(a.desiredLOD/a.images.length*270,100,100).toRgb().map(function(a){return a/255}),d=0;d<a.usedByEngineMats.length;d++)a.usedByEngineMats[d].setParameterValues({ambient:c,diffuse:c})},e.prototype._extractTextureImageFromBlob=function(a,b,c,d){var f=d.texMeta;if(0>f.desiredLOD||d.image.size>f.images[f.desiredLOD].size)return void delete this._requestedTexImageIds[d.image.id];var e=this;q.assert("binary"===
c);var k="";try{var h=c=0;-1<f.encodingIdx?(c=d.image.byteOffset[f.encodingIdx],h=d.image.length[f.encodingIdx]):(c=d.image.byteOffset,h=d.image.length);var l=new Uint8Array(b,c,h),p=new Blob([l],{type:f.encoding}),k=window.URL.createObjectURL(p)}catch(v){k="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2P8zyD6n4ECwDhqAMNoGDCMhgEwDw2DdAAAdzkhQdS8dl8AAAAASUVORK5CYII\x3d",z.error("error loading texture "+a+" "+v)}var m=new Image;m.onerror=function(){window.URL.revokeObjectURL(k);
m.src="";m.onerror=void 0;m.onload=void 0};m.onload=function(){e._controller.queueAnimationFrameFunctionCall(e._textureImageLoaded,e,[a,m,d.image,d.texMeta,k],void 0,1);window.URL.revokeObjectURL(k);m.src="";m.onerror=void 0;m.onload=void 0};m.src=k},e.prototype._textureImageLoaded=function(a,b,c,d){if(delete this._requestedTexImageIds[c.id],!(0>d.desiredLOD)){a=d.images[d.desiredLOD];var f=d.images[d.curLOD];if((!this.isOverMemory()||!(null==f||c.size>f.size))&&(!f||c.size>f.size&&c.size<=a.size||
c.size<f.size&&c.size>=a.size)){(f=d.engineTex)&&f!==this._initTexture&&(this.memEstimateTextureRemoved(f),this._stage.remove(n.TEXTURE,d.engineTex.getId()));f=T(b,d,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);d.engineTex=new J(b,d.id,f);this._stage.add(n.TEXTURE,d.engineTex);d.curLOD=d.desiredLOD;this.memEstimateTextureAdded(d.engineTex);b=d.engineTex.getId();for(f=0;f<d.usedByEngineMats.length;f++){var e=d.usedByEngineMats[f];null==this._colorOverride&&e.setParameterValues({textureId:b});
e.metadata.originalTextureId=b}c===a||(d.curLOD=d.images.indexOf(c),q.assert(-1<d.curLOD),this._requestedTexImageIds[a.id])||(c={metadata:{texMeta:d,image:a}},this._requestedTexImageIds[a.id]=!0,this._controller.streamDataSupplier.request(a.hrefConcat,"binary",c).then(this._extractTextureImageFromBlob.bind(this)))}}},e.prototype._imageIsPartOfTextureBundle=function(a){return!this._controller.isMeshPyramid},e.prototype._setPolygonOffset=function(a,b){if(null!=this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjectsPerBundle){b=
{polygonOffset:b};for(var c=0;c<this._nodeId2Meta[a.id].engineObjectsPerBundle.length;c++)for(var d=this._nodeId2Meta[a.id].engineObjectsPerBundle[c],f=0;f<d.length;f++)for(var e=d[f].getGeometryRecords(),k=0;k<e.length;k++)for(var h=e[k].materials,l=0;l<h.length;l++)h[l].setParameterValues(b)}},e.prototype._rendererChange=function(a){(this._currentRenderer=a)&&(a.colorInfo||a.sizeInfo)&&z.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.")},
e.prototype._getRenderingInfo=function(a){var b=this._currentRenderer,c=b&&b.getSymbol(a);if(!(c instanceof ga))return null;var d,f,c={symbol:c};if(b&&b.visualVariables)for(a=b.getVisualVariableValues(a),b=0;b<a.length;b++){var e=a[b],k=e.variable.type;"color"===k?d=e.value:"opacity"===k&&(f=e.value)}return d&&(c.color=[d.r/255,d.g/255,d.b/255]),null!=f?c.opacity=f:d&&null!=d.a&&(c.opacity=d.a),c},e.prototype._getSymbolFillColor=function(a){var b=0;for(a=a.symbolLayers.items;b<a.length;b++){var c=
a[b];if("fill"===c.type&&(c=c.material,c=null!=c?c.color:null,null!=c))return[c.r/255,c.g/255,c.b/255,c.a]}return null},e.prototype._getSymbolFillColorMixMode=function(a){var b=0;for(a=a.symbolLayers.items;b<a.length;b++){var c=a[b];if("fill"===c.type&&(c=c.material,c=null!=c?c.colorMixMode:null,null!=c))return c}return null},e.prototype._hasSymbolColors=function(){return!this._isIntegratedMesh()},e.prototype._isIntegratedMesh=function(){return this.layer instanceof R},e.prototype._hasVertexColors=
function(){return null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color)},e.prototype._setObjectSymbology=function(a){if(this._hasSymbolColors()){for(var b=a.getMetadata(),c=b.faceRanges?b.faceRanges.length:1,d=new E(null,null,{}),f=d.attributes,e=this.layer.objectIdField,k=this._currentRenderer&&this._currentRenderer.requiredFields,h=a.geometryRecords[0].geometry.data.vertexAttributes[q.VertexAttrConstants.SYMBOLCOLOR].data,
l=!1,p=new Uint8Array(4),m=0;c>m;m++){if(null!=e&&null!=b.featureIds&&(f[e]=b.featureIds[m]),null!=k&&null!=b.attributeData)for(var n=0,r=k;n<r.length;n++){var w=r[n];b.attributeData[w]&&(f[w]=F.getCachedAttributeValue(b.attributeData[w],m))}var t=this._getRenderingInfo(d),n=null!=b.faceRanges?b.faceRanges[m]:null;if(t){var r=this._getSymbolFillColorMixMode(t.symbol),w=t.color,u=t.opacity;null==w||null==u?(t=this._getSymbolFillColor(t.symbol),w=S.overrideColor(w,u,t,t&&t[3],U)):w=S.overrideColor(w,
u,null,null,U);1>w[3]&&(l=!0);F.encodeSymbolColor(w,r,p)}else F.encodeSymbolColor(null,null,p);this._setFaceRangeColor(n,h,p)}a.geometryColorAttrsUpdated(0);a=a.getGeometryRecords();for(b=0;b<a.length;b++)for(c=a[b],d=0;d<c.materials.length;d++)f=c.materials[d],e=f.getParams().transparent,k=f.getParams().opacity,f.metadata.symbolIsTransparent=l,h=this._calcEngineMaterialTransparencyParams(f.metadata.i3sTex,f.metadata.i3sMatParams,f.metadata.symbolIsTransparent),e===h.transparent&&k===h.opacity||f.setParameterValues({transparent:h.transparent,
opacity:h.opacity})}},e.prototype._setFaceRangeColor=function(a,b,c){var d=12*a[1]+12;for(a=12*a[0];d>a;a+=4)b[a+0]=c[0],b[a+1]=c[1],b[a+2]=c[2],b[a+3]=c[3]},e.prototype._opacityChange=function(a){for(var b in this._matId2Meta)for(var c in this._matId2Meta[b]){a=this._matId2Meta[b][c].engineMat;var d=a.getParams(),e=this._calcEngineMaterialTransparencyParams(a.metadata.i3sTex,a.metadata.i3sMatParams,a.metadata.symbolIsTransparent);d.transparent===e.transparent&&d.layerOpacity===e.layerOpacity||a.setParameterValues(e)}},
e.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)},e.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)},e.prototype.queryFeatures=function(a){return this._ensureQueryEngine().queryFeatures(a)},e.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().queryObjectIds(a)},e.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},e.prototype._createQueryEngine=
function(){var a=this,b={id:0,index:0,object:null,bbCorners:new Float64Array(24)};return new ka({forAll:function(c,d){a._forAllFeatures(function(d,e,k){b.id=d;b.index=e;b.object=k;a._boundingBoxCornerPoints(b.index,b.object,b.bbCorners);c(b)},d)},createGraphic:function(b){return a._createGraphic(b.index,b.object.getMetadata())},requestFields:function(b,d,e){return F.whenGraphicAttributes(a.layer,d,a._getObjectIdField(),e,function(){var c=a._getGraphicIndices(b.node,b.bundleNr,d);return{node:b.node,
indices:c}})},createExtentBuilder:function(){return a._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},e.prototype._createExtentBuilder=function(){var a=this.view.renderSpatialReference,b=this.view.spatialReference,c=D.create(D.NEGATIVE_INFINITY),d=new Float64Array(24);return{add:function(e){N.bufferToBuffer(e.bbCorners,a,0,d,b,0,8)&&D.expandBuffer(c,d,0,8)},getExtent:function(){return D.toExtent(c,b)}}},e.prototype._forAllFeatures=function(a,b,c){for(var d=
0,e=Object.keys(this._nodeId2Meta);d<e.length;d++)for(var g=e[d],k=this._nodeId2Meta[g].engineObjects,h=0;h<k.length;h++)this._forAllFeaturesOfObject(k[h],a,c),b&&b({node:this._controller.nodeIndex[g],bundleNr:h})},e.prototype._forAllFeaturesOfObject=function(a,b,c){for(var d=a.getMetadata().featureIds,e=a.getGeometryRecords()[0],g=0;g<d.length;g++)(c||a.getComponentVisibility(e,g))&&b(d[g],g,a,e)},e.prototype._createGraphic=function(a,b){var c={};c[this._getObjectIdField()]=b.featureIds[a];for(var d=
0,e=Object.keys(b.attributeData);d<e.length;d++){var g=e[d];c[g]=F.getCachedAttributeValue(b.attributeData[g],a)}a=new E(null,null,c);return a.layer=this.layer,a},e.prototype._boundingBoxCornerPoints=function(a,b,c){a=b.geometries[0].getComponentAABB(a,va);for(var d=0;8>d;++d)G[0]=1&d?a[0]:a[3],G[1]=2&d?a[1]:a[4],G[2]=4&d?a[2]:a[5],K.mat4d.multiplyVec3(b.objectTransformation,G),c[3*d]=G[0],c[3*d+1]=G[1],c[3*d+2]=G[2];return c},e.prototype.highlight=function(a,b){var c=this,d=this._highlights;if(a instanceof
ha){b=d.acquireSet(b);var e=b.set,g=b.handle;return this.queryObjectIds(a).then(function(a){return d.setFeatureIds(e,a)}),g}if("number"==typeof a||a instanceof E)return this.highlight([a],b);if(a instanceof aa&&(a=a.toArray()),Array.isArray(a)&&0<a.length){if(a[0]instanceof E)return a=a.map(function(a){return Q.attributeLookup(a.attributes,c._getObjectIdField())}),g=d.acquireSet(b),b=g.set,g=g.handle,d.setFeatureIds(b,a),g;if("number"==typeof a[0])return g=d.acquireSet(b),b=g.set,g=g.handle,d.setFeatureIds(b,
a),g}return{remove:function(){}}},e}(r.declared(fa,na));A([r.property()],x.prototype,"layer",void 0);A([r.property()],x.prototype,"view",void 0);A([r.property()],x.prototype,"_controller",void 0);A([r.property({dependsOn:["_controller.updating"]})],x.prototype,"updating",void 0);A([r.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],x.prototype,"updatingPercentageValue",void 0);A([r.property({readOnly:!0})],x.prototype,"hasTexturesOrVertexColors",null);x=A([r.subclass("esri.views.3d.layers.SceneLayerView3D")],
x);var G=[0,0,0],va=[0,0,0,0,0,0];return x});