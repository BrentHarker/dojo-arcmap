//>>built
define(["../../../core/arrayUtils","../webgl-engine/lib/Util"],function(w,q){return function(n,x,y,p,z){var d=0,g={},f=[],e=[],h=[],c=[],k=0,l=0,m;for(m in p)f[d]=[],e[d]=0,c[d]={requests:0,size:0,duration:0,speed:0},h[d]=p[m],g[m]=d++,l+=p[m];var r=f.length,d=0;this.setWorkerQuota=function(a){q.assert(w.equals(Object.keys(this.typeWorkerAllication),Object.keys(a)));this.typeWorkerAllication=a;l=0;for(var b in a)h[g[b]]=a[b],l+=a[b]};this.setWorkerFunc=function(a){n=a};this.push=function(a){var b=
g[a.clientType];l>k?(e[b]++,k++,n(a,t)):f[b].push(a)};this._getStatsForType=function(a){a=g[a];return{quota:h[a],workers:e[a],queueSize:f[a].length,requestStats:c[a]}};this.removeTasks=function(a,b){for(var c=[],d=f[g[b]],e=0;e<d.length;e++){var h=d[e];-1<a.indexOf(h)||c.push(h)}f[g[b]]=c};this.workerCancelled=function(a){u(a);a._cancelledInQueue=!0};this.clear=function(){for(var a=0;a<f.length;a++)f[a]=[]};var u=function(a){var b=g[a.clientType];e[b]--;k--;c[b].requests++;c[b].size+=a.size||0;c[b].duration+=
a.duration||0;c[b].speed=0<c[b].duration?c[b].size/c[b].duration:0;q.assert(0<=e[b]);a=d;b=!1;do e[a]<h[a]&&v(a)&&(b=!0),a=(a+1)%r;while(!b&&a!=d);if(!b){do v(a)&&(b=!0),a=(a+1)%r;while(!b&&a!=d)}d=a},v=function(a){for(;0<f[a].length;)if(n(f[a].shift(),t))return e[a]++,k++,!0;return!1},t=function(a){a._cancelledInQueue||(x.apply(y,arguments),u(a))}}});