//>>built
define("../../../geometry/SpatialReference ../../../geometry/Geometry ../../../geometry/Point ../../../geometry/Extent ../../../geometry/support/webMercatorUtils ../../../core/Error ../../../core/promiseUtils ../../../Camera ../../../Viewpoint ../../../Graphic ../lib/glMatrix ./mathUtils ./projectionUtils ./cameraUtils ./aaBoundingBox ./aaBoundingRect ./intersectionUtils".split(" "),function(D,aa,y,ba,A,ca,E,F,G,da,x,R,t,k,q,S,ea){function H(a){return 360-R.cyclicalDeg.normalize(a)}function B(a){return R.cyclicalDeg.normalize(360-
a)}function T(a,b,c){if(!b)return null;var d,e=a.spatialReference||D.WGS84;if(b.camera){if(d=b.get("camera.position.spatialReference"),!A.canProject(d,e))return null;(b=b.camera.clone(),d.equals(e))||(a=A.project(b.position,e),b.position=a);return b}if(d=b.get("targetGeometry.spatialReference"),d&&!A.canProject(d,e))return null;var p=a.navigation.currentCamera;d=k.internalToExternal(a,p);var m={noReset:!1};if(null!=b.rotation&&(d.heading=H(b.rotation),m.noReset=!0),null!=c&&(d.tilt=c),b.targetGeometry instanceof
y){var h=b.targetGeometry;c=b.targetGeometry.clone();b=null!=b.scale?k.scaleToDistance(a,b.scale,h.latitude):p.distance;b=k.eyeHeadingTiltForCenterPointAtDistance(a,d.heading,d.tilt,c,b,m);a=t.vectorToPoint(b.eye,a.renderSpatialReference,e);return new F(a,b.heading,b.tilt,d.fov)}return k.fromExtent(a,b.targetGeometry.extent,d,m)}function K(a,b,c,d){var e=c.scale;return null==e&&null!=c.zoom&&(e=k.zoomToScale(a,c.zoom)),null==e&&null!=c.distance&&(b=b.center||b,e=k.distanceToScale(a,c.distance,b.latitude)),
null==e&&d&&(e="function"==typeof d?d():d),e}function U(a,b,c,d,e){if(!(b&&c.position||b&&c.direction||c.position&&c.direction))return!1;var p=a.spatialReference||D.WGS84,m=a.renderSpatialReference,f=c.direction;if(b&&c.position&&(f=null),c.position&&t.pointToVector(c.position,l,m),b&&t.pointToVector(b,n,m),f){var g=new y(c.position||b);g.x+=f[0];g.y+=f[1];2<f.length&&(g.z+=f[2]);t.pointToVector(g,v,m);h.subtract(v,c.position?l:n)}c.position&&f?(e.camera.position=new y(c.position),k.directionToHeadingTilt(a,
l,v,d.up,e.camera),h.add(l,v,n),a.navigation.getCenterIntersectTerrain(l,n,n),e.targetGeometry=t.vectorToPoint(n,m,p),e.scale=k.distanceToScale(a,h.dist(l,n),e.targetGeometry.latitude)):b&&f?(e.targetGeometry=new y(b),e.scale=K(a,e.targetGeometry,c,function(){return k.computeScale(a,d)}),b=k.scaleToDistance(a,e.scale,b.latitude),h.scale(v,b/h.length(v),l),h.add(l,n),e.camera.position=t.vectorToPoint(l,m,p),k.directionToHeadingTilt(a,l,v,d.up,e.camera)):(e.targetGeometry=new y(b),e.camera.position=
new y(c.position),h.subtract(n,l,v),k.directionToHeadingTilt(a,l,v,d.up,e.camera),e.scale=k.distanceToScale(a,h.dist(l,n),e.targetGeometry.latitude));return e.rotation=B(e.camera.heading),!0}function L(a,b){var c=!1;return null!=b.heading?(a.heading=b.heading,c=!0):null!=b.rotation&&(a.heading=H(b.rotation),c=!0),null!=b.tilt&&(a.tilt=b.tilt,c=!0),null!=b.fov&&(a.fov=b.fov),c}function I(a,b,c){var d=a.spatialReference||D.WGS84;return b=b||k.externalToInternal(a,c.camera),c.targetGeometry=t.vectorToPoint(b.center,
a.renderSpatialReference,d),c.scale=k.computeScale(a,b),c.rotation=B(c.camera.heading),c}function M(a,b,c){if(b){var d=[];if(!b.hasZ&&a.basemapTerrain){var e;(e=b.isInstanceOf(y)?b:b.centroid||b.center)?f[2]=a.basemapTerrain.getElevation(e)||0:f[2]=0}fa[b.declaredClass](b,function(a){d.push(a[0],a[1],a[2])},f);var p=d.length/3;if(0!==p&&(e=Array(d.length),t.bufferToBuffer(d,b.spatialReference,0,e,a.spatialReference,0,p)))for(b.hasZ&&(c.hasZ=!0),a=0;a<e.length;a+=3)b.hasZ?(f[0]=e[a+0],f[1]=e[a+1],
f[2]=e[a+2]):(f[0]=e[a+0],f[1]=e[a+1]),q.expand(c.boundingBox,f)}}function ga(a,b,c){return a.whenViewForGraphic(b).then(function(a){return a&&a.whenGraphicBounds?a.whenGraphicBounds(b):void 0}).then(function(a){var b=a.boundingBox;q.expand(c.boundingBox,b);a.screenSpaceObjects&&a.screenSpaceObjects.forEach(function(a){c.screenSpaceObjects.push(a)});isFinite(b[2])&&(c.hasZ=!0)}).otherwise(function(){M(a,b.geometry,c)})}function V(a,b,c){if(Array.isArray(b)&&2===b.length&&"number"==typeof b[0]&&"number"==
typeof b[1])r.x=b[0],r.y=b[1],r.z=void 0,r.spatialReference=D.WGS84,M(a,r,c);else{if(b&&b.forEach)return E.eachAlways(b.map(function(b){return V(a,b,c)}));if(b instanceof aa)M(a,b,c);else if(b instanceof da)return ga(a,b,c)}return E.resolve()}function ha(a,b,c,d){if(b.camera)return W(a,c,b.camera,d);d.scale=b.scale;d.rotation=b.rotation;d.targetGeometry=b.targetGeometry?b.targetGeometry.clone():null;d.camera=null;null!=c.heading?d.rotation=B(c.heading):null!=c.rotation&&(d.rotation=c.rotation);b=
K(a,d.targetGeometry,c);return null!=b&&(d.scale=b),d.camera=T(a,d,c.tilt),d}function W(a,b,c,d){d.camera=c.clone();d.camera.fov=a.camera.fov;b=a.spatialReference;c=d.camera.position.spatialReference;if(!A.canProject(c,b))return null;c.equals(b)||(b=A.project(d.camera.position,b),d.camera.position=b);return I(a,null,d)}function N(a,b,c,d){if(!c)return null;d.targetGeometry=c.clone();var e=a.navigation.getCameraIntersectTerrain();if(U(a,d.targetGeometry,b,e,d))return d;k.internalToExternal(a,e,d.camera);
var p={noReset:!1};return L(d.camera,b)&&(p.noReset=!0),d.scale=K(a,d.targetGeometry,b),null==d.scale&&(t.pointToVector(c,f,a.renderSpatialReference),ea.frustumPoint(e.frustumPlanes,f)?d.scale=k.distanceToScale(a,h.dist(e.eye,f),c.latitude):d.scale=k.computeScale(a,e)),k.fromCenterScale(a,d.targetGeometry,d.scale,d.camera,p,d.camera)?d:null}function ia(a,b,c,d){d.targetGeometry=c.clone();var e=a.navigation.getCameraIntersectTerrain();k.internalToExternal(a,e,d.camera);e={noReset:!1};return L(d.camera,
b)&&(e.noReset=!0),k.fromExtent(a,c,d.camera,e,d.camera)?d:null}function ja(a,b){if(!b||!a.spatialReference)return null;a={};if(null!=b.declaredClass||Array.isArray(b))a.target=b;else{for(var c in b)a[c]=b[c];b.center&&!a.target&&(a.target=b.center)}return a}function J(a){return a&&(a.rotation=B(a.camera.heading)),E.resolve(a)}var h=x.vec3d,O=x.mat3d,X=x.mat4d,l=h.create(),n=h.create(),v=h.create(),P={heading:0,tilt:0},f=h.create(),Y=X.create(),Q=O.create(),C=q.create(),ka=S.create(),r=new y;x=function(a,
b,c){for(var d=a.hasZ,e=0;e<a.rings.length;e++)for(var f=a.rings[e],m=0;m<f.length;m++)c[0]=f[m][0],c[1]=f[m][1],d&&(c[2]=f[m][2]),b(c)};var fa={"esri.geometry.Point":function(a,b,c){c[0]=a.x;c[1]=a.y;a.hasZ&&(c[2]=a.z);b(c)},"esri.geometry.Polygon":x,"esri.geometry.Circle":x,"esri.geometry.Polyline":function(a,b,c){for(var d=a.hasZ,e=0;e<a.paths.length;e++)for(var f=a.paths[e],m=0;m<f.length;m++)c[0]=f[m][0],c[1]=f[m][1],d&&(c[2]=f[m][2]),b(c)},"esri.geometry.Multipoint":function(a,b,c){var d=a.points;
a=a.hasZ;for(var e=0;e<d.length;e++)c[0]=d[e][0],c[1]=d[e][1],a&&(c[2]=d[e][2]),b(c)},"esri.geometry.Extent":function(a,b,c){a.hasZ?(b(h.set3(a.xmin,a.ymin,a.zmin,c)),b(h.set3(a.xmax,a.ymin,a.zmin,c)),b(h.set3(a.xmin,a.ymax,a.zmin,c)),b(h.set3(a.xmax,a.ymax,a.zmin,c)),b(h.set3(a.xmin,a.ymin,a.zmax,c)),b(h.set3(a.xmax,a.ymin,a.zmax,c)),b(h.set3(a.xmin,a.ymax,a.zmax,c)),b(h.set3(a.xmax,a.ymax,a.zmax,c))):(b(h.set3(a.xmin,a.ymin,c[2],c)),b(h.set3(a.xmax,a.ymin,c[2],c)),b(h.set3(a.xmin,a.ymax,c[2],c)),
b(h.set3(a.xmax,a.ymax,c[2],c)))}},Z={create:function(a,b){var c=ja(a,b);if(!c)return E.reject(new ca("viewpointutils-create:no-target","Missing target for creating viewpoint"));var d=new G({camera:new F({fov:a.camera.fov})}),e=null!=c.scale||null!=c.zoom||null!=c.distance;if(c.target instanceof G)return J(ha(a,c.target,c,d));if(c.target instanceof F)return J(W(a,c,c.target,d));if(c.target instanceof ba)return b=c.target.xmin===c.target.xmax||c.target.ymin===c.target.ymax,J(e||b?N(a,c,c.target.center,
d):ia(a,c,c.target,d));var p={boundingBox:q.create(q.NEGATIVE_INFINITY),spatialReference:a.spatialReference,hasZ:!1,screenSpaceObjects:[]};return V(a,c.target,p).then(function(){if(isFinite(p.boundingBox[0])){q.center(p.boundingBox,f);r.x=f[0];r.y=f[1];r.z=f[2];r.spatialReference=a.spatialReference;var b;isFinite(r.z)&&p.hasZ?b=q.isPoint(p.boundingBox):(r.z=void 0,b=S.isPoint(q.toRect(p.boundingBox,ka)));if(e||b)b=N(a,c,r,d);else{var l=r;b=p.boundingBox;var g;g=p.screenSpaceObjects;var w=Z.DEFAULT_FRAME_COVERAGE;
if(g.length){for(var u=Number.NEGATIVE_INFINITY,n=0;n<g.length;n++)var z=g[n].screenSpaceBoundingRect,u=Math.max(u,Math.abs(z[0]),Math.abs(z[1]),Math.abs(z[2]),Math.abs(z[3]));g=w-u/Math.min(a.width,a.height)*2}else g=w;w=g;d.targetGeometry=l.clone();g=a.navigation.getCameraIntersectTerrain();u=0;l.hasZ?u=l.z:a.basemapTerrain&&(u=a.basemapTerrain.getElevation(l));h.set3(l.x,l.y,u,f);t.computeLinearTransformation(a.spatialReference,f,Y,a.renderSpatialReference);X.toMat3(Y,Q);O.transpose(Q);q.set(C,
q.NEGATIVE_INFINITY);l=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(n=0;n<l.length;n++){var z=l[n],x=b[z[2]];isFinite(x)||(x=u);h.set3(b[z[0]],b[z[1]],x,f);t.vectorToVector(f,a.spatialReference,f,a.renderSpatialReference);q.expand(C,O.multiplyVec3(Q,f))}b=q.width(C);l=q.height(C);u=q.depth(C);n=1/Math.tan(g.fovY/2);b=Math.max(.5*Math.sqrt(b*b+u*u)*Math.max(n,1/Math.tan(g.fovX/2))+.5*l,.5*l*n+.5*Math.max(b,u))/w;k.internalToExternal(a,g,d.camera);g={noReset:!1};b=(L(d.camera,
c)&&(g.noReset=!0),d.scale=k.distanceToScale(a,b,d.targetGeometry.latitude),k.fromCenterScale(a,d.targetGeometry,d.scale,d.camera,g,d.camera)?d:null)}return b}b=a.navigation.getCameraIntersectTerrain();U(a,null,c,b,d)?b=d:c.position?(h.set(b.viewForward,v),k.directionToHeadingTilt(a,b.eye,v,b.up,P),d.camera.position=new y(c.position),b=d.camera,w=P.heading,g=c.heading,w=(null==g&&null!=c.rotation&&(g=H(c.rotation)),null==g&&w&&(g="function"==typeof w?w():w),g),b.heading=w,b=d.camera,g=P.tilt,g=null!=
c.tilt?c.tilt:null!=g?"function"==typeof g?g():g:void 0,b=(b.tilt=g,I(a,null,d))):(b=t.vectorToPoint(b.center,a.renderSpatialReference,r,a.spatialReference),b=N(a,c,b,d));return b}).then(function(a){return J(a)})},rotationToHeading:H,headingToRotation:B,toCamera:T,fromCamera:function(a,b,c){return c||(c=new G),c.camera=b.clone(),I(a,null,c)},fromInternalCamera:function(a,b,c){return c||(c=new G({camera:new F})),k.internalToExternal(a,b,c.camera),I(a,b,c)},DEFAULT_FRAME_COVERAGE:.66};return Z});