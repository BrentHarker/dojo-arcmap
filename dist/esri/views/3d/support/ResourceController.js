//>>built
define("../../../core/declare ../../../core/Scheduler ../../../core/HandleRegistry ../../../core/watchUtils ./StreamDataSupplier ./StreamDataLoader ./PreallocArray ../webgl-engine/lib/Util".split(" "),function(g,p,q,m,r,t,u,k){function e(a){this.budget=this.begin=0;this.performance=k.performance;this.enabled=!0;void 0!==a&&this.reset(a)}var l=k.assert,f={TERRAIN:"terrain",SCENE:"scene",SYMBOLOGY:"symbols"},h=new u(20);e.prototype.now=function(){return this.performance.now()};e.prototype.reset=function(a){this.begin=
this.now();this.budget=this.enabled?a:Number.MAX_VALUE};e.prototype.done=function(){return this.enabled&&this.elapsed()>=this.budget};e.prototype.remaining=function(){return Math.max(this.budget-this.elapsed(),0)};e.prototype.elapsed=function(){return this.now()-this.begin};g=g(null,{constructor:function(a,b){this._clients=[];this._frameWorker=null;this._budget=new e;this._idleFrameWorkers=[];this._idleFrameWorkerRobin=0;this._idleUpdatesStartFired=!1;this._targetReached=!0;this._lastTargetChangeTime=
k.performance.now();this.navigationTimeout=300;this.animatingFrameTimeBudget=10;this.idleFrameWorkerBudget=30;this.idleFrameTimeBudget=50;var c={},d;for(d in f)c[f[d]]=0;c[f.TERRAIN]=15;c[f.SCENE]=20;c[f.SYMBOLOGY]=5;this._maxGpuMemory=500;this.streamDataLoader=new t(c);this._cameraListeners=new q;this._cameraListeners.add([m.on(a,"navigation","currentViewReachedTarget",this._currentViewReachedTargetHandler.bind(this)),m.on(a,"navigation","targetViewChanged",this._targetViewChangedHandler.bind(this))]);
b||(b=p);this._frameTask=b.addFrameTask({update:this._frameUpdate.bind(this)});this._view=a;this.stats={frameUpdateTime:new n,idleUpdateTime:new n};this.frameUpdateNavigation=null},destroy:function(){this._frameTask.remove();this._frameTask=null;this._cameraListeners.remove();this.streamDataLoader.destroy();this.streamDataLoader=null},setEnableBudget:function(a){this._budget.enabled=!!a},registerClient:function(a,b,c){return this._clients.push({client:a,type:b}),"function"==typeof a.setMaxGpuMemory&&
a.setMaxGpuMemory(this._maxGpuMemory),new r(b,this.streamDataLoader,c)},deregisterClient:function(a){for(var b=0;b<this._clients.length;b++)if(this._clients[b].client===a)return this._clients[b]=this._clients[this._clients.length-1],void this._clients.pop();console.warn("deregistering an unregistered client.")},setMaxGpuMemory:function(a){this._maxGpuMemory=a;for(var b=0;b<this._clients.length;b++){var c=this._clients[b].client;"function"==typeof c.setMaxGpuMemory&&c.setMaxGpuMemory(a)}},registerIdleFrameWorker:function(a,
b){var c=this._idleFrameWorkers.some(function(b){return b.client===a});l(!c,"Can only register idle frame workers once per client/layer");l(!b.idleFrame||b.needsUpdate,"needsUpdate has to be specified if idleFrame is specified");this._idleFrameWorkers.push({client:a,callbacks:b});this._isIdle()&&this._idleUpdatesStartFired&&b.idleBegin&&b.idleBegin.call(a)},deregisterIdleFrameWorker:function(a){for(var b=this._idleFrameWorkers,c=0;c<b.length;c++){var d=b[c];if(d.client===a)return this._idleUpdatesStartFired&&
d.callbacks.idleEnd&&d.callbacks.idleEnd.call(a),b[c]=b[b.length-1],void b.pop()}},registerFrameWorker:function(a){l(!this._frameWorker,"Only one (non-idle) per-frame worker supported at the moment");this._frameWorker=a},deregisterFrameWorker:function(){this._frameWorker=null},_targetViewChangedHandler:function(a){this._lastTargetChangeTime=k.performance.now();this._targetReached=!1;this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._callWorkersNoScheduling("idleEnd"))},_currentViewReachedTargetHandler:function(a){this._targetReached=
!0},_frameUpdate:function(a){var b=this._isIdle()?this.idleFrameWorkerBudget:this.animatingFrameTimeBudget;this._budget.reset(b-a.spendInFrame);this._view.navigation&&this._view.navigation.step(a.deltaTime);this._view.inputManager&&this._view.inputManager._pinchNavigation&&this._view.inputManager._pinchNavigation.momentum.doFrameUpdate(a.deltaTime);this._frameWorker&&(this._frameWorker(this._budget),this.stats.frameUpdateTime.addSample(this._budget.elapsed()));this._isIdle()&&(this._idleUpdatesStartFired||
(this._callWorkersNoScheduling("idleBegin"),this._idleUpdatesStartFired=!0),this._budget.reset(this.idleFrameTimeBudget-this._budget.elapsed()),3<this._budget.remaining()&&(this._callWorkersStrictScheduling("idleFrame",this._budget),this.stats.idleUpdateTime.addSample(this._budget.elapsed())))},_isIdle:function(){return this._budget.now()-this._lastTargetChangeTime>this.navigationTimeout&&this._targetReached},_callWorkersNoScheduling:function(a){for(var b=this._idleFrameWorkers,c=0;c<b.length;c++){var d=
b[c];d.callbacks[a]&&d.callbacks[a].call(d.client)}},_callWorkersStrictScheduling:function(a,b){var c,d,e,f=this._idleFrameWorkers,g=f.length;h.clear();d=0;for(e=this._idleFrameWorkerRobin;g>d;d++)c=f[e++%g],c.callbacks.needsUpdate&&c.callbacks.needsUpdate.call(c.client)&&(0===h.length&&(this._idleFrameWorkerRobin=e),h.push(c));c=b.now();for(d=c+b.remaining();0<h.length&&d>c;)b.reset((d-c)/h.length),c=h.pop(),c.callbacks[a].call(c.client,b),c=b.now()}});g.ClientType=f;var n=function(){this.addSample=
function(a){this.min=Math.min(this.min,a);this.max=Math.max(this.max,a);this.total+=a;this.numSamples++};this.getAverage=function(){return this.total/this.numSamples};this.reset=function(){this.numSamples=this.total=0;this.min=Number.MAX_VALUE;this.max=-Number.MAX_VALUE};this.reset()};return g});