//>>built
define("dojo/_base/lang ../../../geometry/SpatialReference ../../../config ../../../geometry/Point ../../../geometry/support/webMercatorUtils ../../../Camera ../lib/glMatrix ./mathUtils ./earthUtils ./projectionUtils ./cameraUtilsPlanar ./cameraUtilsSpherical".split(" "),function(M,r,D,t,x,y,N,u,v,p,E,F){function w(a,b){return"global"===a.viewingMode?F[b]:E[b]}function G(a,b,c){var e=a.renderSpatialReference,d=n.set(b.viewForward,O),d=H(a,b.eye,d,b.up,P);a=a.spatialReference||r.WGS84;return p.vectorToVector(b.eye,
e,k,a)||(a=r.WGS84,p.vectorToVector(b.eye,e,k,a)),c?(c.position.x=k[0],c.position.y=k[1],c.position.z=k[2],c.position.spatialReference=a,c.heading=d.heading,c.tilt=d.tilt,c.fov=u.rad2deg(b.fov),c):new y(new t(k,a),d.heading,d.tilt,u.rad2deg(b.fov))}function I(a,b,c){var e=a.navigation.currentCamera,d=e.fovX,e=e.width/2;"global"===a.viewingMode&&null!=c&&(b*=Math.cos(u.deg2rad(c)));b/=a.renderCoordsHelper.unitInMeters;return e/(D.screenDPI*J/b)/Math.tan(d/2)}function K(a,b,c){var e=a.navigation.currentCamera;
b=D.screenDPI*J/(e.width/2/(b*Math.tan(e.fovX/2)));return"global"===a.viewingMode&&(b/=Math.cos(u.deg2rad(c))),b*=a.renderCoordsHelper.unitInMeters}function L(a,b,c,e,d,f){var g=a.renderSpatialReference;b=z(a,e.heading,e.tilt,b,c,d);return(a=p.vectorToPoint(b.eye,g,a.spatialReference||r.WGS84))?f?(f.position=a,f.heading=b.heading,f.tilt=b.tilt,f.fov=e.fov,f):new y(a,b.heading,b.tilt,e.fov):null}function H(a,b,c,e,d){return w(a,"directionToHeadingTilt")(b,c,e,d)}function z(a,b,c,e,d,f){var g=n.create(),
m=a.renderSpatialReference;if(e&&e instanceof t){var h=e;if(p.pointToVector(h,g,a.renderSpatialReference),null==h.z)"global"===a.viewingMode?a._pickRay([0,0,0],g):a._pickRay([g[0],g[1]-1,g[2]],g),null!=a.basemapTerrain&&(h=a.basemapTerrain.getElevation(h),null!=h&&a.renderCoordsHelper.setAltitude(h,g))}else e?n.set(e,g):n.set(a.navigation.currentCamera.center,g);e&&e instanceof t||(e=p.vectorToPoint(g,m,a.spatialReference||r.WGS84));d=Math.max(d,a.navigation.minPoiDist);m=c;c=d;if(!(h=f&&f.noReset))var l=
e,h=a.engineToScreen(a.navigation.currentCamera.center),q=a.toScreen(l),l=h.x-q.x,h=h.y-q.y,h=!(Math.sqrt(l*l+h*h)>Q*Math.max(a.width,a.height));h?(m=w(a,"eyeTiltToLookAtTilt")(g,c,m),m=a.navigation.constraints.tilt.apply(m,c),m=w(a,"lookAtTiltToEyeTilt")(g,c,m)):(b=0,m=a.navigation.constraints.tilt.min(c));c=m;b=w(a,"eyeForCenterWithHeadingTilt")(g,d,b,c);b.center=g;if(g=!(f&&f.noReset||"global"!==a.viewingMode))g=a.renderCoordsHelper.fromRenderCoords(b.eye,B,a.spatialReference)?a.basemapTerrain&&
(a.basemapTerrain.getElevation(B)||0)>B.z-1:!1;return g?(g=a.navigation.constraints.tilt.min(d),z(a,0,g,e,d,M.mixin({},f,{noReset:!0}))):b}var n=N.vec3d,J=39.37,Q=5,k=n.create(),A=n.create(),O=n.create(),P={heading:0,tilt:0},B=new t,C=new u.Cyclical(-2.0037508342788905E7,2.0037508342788905E7);return{externalToInternal:function(a,b){var c=a.renderSpatialReference,e=w(a,"headingTiltToDirectionUp"),d=n.create();return p.pointToVector(b.position,d,c)?(c=e(d,b.heading,b.tilt),n.add(c.direction,d),a=a.navigation.getCameraIntersectTerrain(d,
c.direction,c.up),a.fov=u.deg2rad(b.fov),a):null},internalToExternal:G,scaleToDistance:I,distanceToScale:K,fromExtent:function(a,b,c,e,d){e instanceof y&&(d=e,e={});var f,g="global"===a.viewingMode,m=a.renderSpatialReference,h=a.spatialReference||r.WGS84,l=r.WebMercator,q=b.spatialReference||l,n=0;null!=b.zmax&&null!=b.zmin&&(f=(b.zmax+b.zmin)/2,n=b.zmax-b.zmin);if(g){var g=new t(b.xmin,b.ymin,q),k=new t(b.xmax,b.ymax,q);if(g=x.project(g,l),k=x.project(k,l),null===g||null===k)return;b=new t(C.center(g.x,
k.x),(k.y+g.y)/2,l);null!=f&&(b.z=f);f=v.getGreatCircleSpanAt(b,g,k);l=f.lon;q=f.lat;C.diff(g.x,k.x)>C.range/2&&(l+=v.halfEarthCircumference);l=Math.min(l,v.halfEarthCircumference);q=Math.min(q,v.halfEarthCircumference)}else x.canProject(b,h)&&(b=x.project(b,h)),l=b.xmax-b.xmin,q=b.ymax-b.ymin,b=new t({x:b.xmin+.5*l,y:b.ymin+.5*q,z:f,spatialReference:h});f=a.navigation.currentCamera;c=z(a,c.heading,c.tilt,b,Math.max(1/Math.tan(f.fovX/2)*l*.5,1/Math.tan(f.fovY/2)*q*.5,1/Math.tan(f.fov/2)*n*.5)/1,e);
return(m=p.vectorToPoint(c.eye,m,h))?(d||(d=new y),d.position=m,d.heading=c.heading,d.tilt=c.tilt,d.fov=a.camera.fov,d):null},toExtent:function(a,b,c,e,d){var f,g=a.renderSpatialReference;if(b||(c||(c=a.navigation.currentCamera),b=G(a,c,d)),c)f=p.vectorToPoint(c.center,g,a.spatialReference||r.WGS84),d=c.distance;else{if(f=a.toMap(a.screenCenter),!f)return null;d=v.computeCarthesianDistance(b.position,f)}c||(c=a.navigation.currentCamera);b=2*d*Math.tan(c.fovX/2)*1;c=2*d*Math.tan(c.fovY/2)*1;return"global"===
a.viewingMode?F.toExtent(a,f,b,c,e):E.toExtent(a,f,b,c,e)},fromCenterScale:function(a,b,c,e,d,f){c=I(a,c,b.latitude);return L(a,b,c,e,d,f)},fromCenterDistance:L,directionToHeadingTilt:H,eyeHeadingTiltForCenterPointAtDistance:z,scaleToZoom:function(a,b){return(a=a.get("basemapTerrain.tilingScheme"))?a.levelAtScale(b):void 0},zoomToScale:function(a,b){return(a=a.get("basemapTerrain.tilingScheme"))?a.scaleAtLevel(b):void 0},computeScale:function(a,b,c){var e=a.renderSpatialReference;b||(b=a.navigation.currentCamera);
var d,f,g=r.WGS84;return b.center?(p.vectorToVector(b.center,e,A,g),d=A[1],f=b.distance):(d=b.position.latitude,p.pointToVector(b.position,k,e),p.pointToVector(c,A,e),f=n.dist(k,A)),K(a,f,d)}}});