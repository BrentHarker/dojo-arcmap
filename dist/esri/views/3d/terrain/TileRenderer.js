//>>built
define("require exports ../lib/glMatrix ../../webgl/FramebufferObject ../../webgl/VertexArrayObject ../../webgl/Texture ../../webgl/BufferObject ../../webgl/Util ../webgl-engine/lib/DefaultVertexAttributeLocations ../webgl-engine/lib/DefaultVertexBufferLayouts ../../vectorTiles/VectorTileDisplayObject ../../vectorTiles/tileRendererHelper3D ./TerrainConst".split(" "),function(F,G,x,y,z,q,A,u,B,C,D,E,r){var l=x.vec2d,v=Array(20),w=[0,0];return function(){function g(f,a,c,b,h){this._gridTex=null;this.tileSize=
256;this._context=f;this.tileSize=a;this._resourceCounter=b;this._setNeedsRender=h;f.extensions.textureFilterAnisotropic&&(this._maxAnisotropy=Math.min(8,f.parameters.maxMaxAnisotropy));a=new Float32Array(20);a[0]=-1;a[1]=-1;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=-1;a[7]=0;a[8]=1;a[9]=0;a[10]=-1;a[11]=1;a[12]=0;a[13]=0;a[14]=1;a[15]=1;a[16]=1;a[17]=0;a[18]=1;a[19]=1;this._vaoQuad=new z(f,B.Default3D,{geometry:C.Pos3Tex},{geometry:A.createVertex(f,35044,a)});this._blendLayersProgram=c.get("blendLayers")}
return g.prototype.dispose=function(){this._fbo&&(this._fbo.dispose(),this._fbo=null);this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null);this._gridTex&&(this._gridTex.dispose(),this._gridTex=null);this._blendLayersProgram&&(this._blendLayersProgram.dispose(),this._blendLayersProgram=null);this._context&&(this._context=null)},g.prototype.updateTileTexture=function(f){for(var a=r.LayerClass.MAP,c=f.layerInfo[a],b=0;b<c.length;b++)c[b].pendingUpdates&=~r.TileUpdateTypes.UPDATE_TEXTURE;if(f.renderData){for(var h,
k,d,e=f.renderData,t=0,g=!0,b=0;b<c.length;b++){h=c[b];var m=f.parentSurface.layerViewByIndex(b,a);if(v[b]=m.fullOpacity,(h.data||h.upsampleFromTile)&&(t++,!m.isTransparent)){g=!1;break}}b===c.length&&b--;0===t&&this._gridTex?(e.textureReference=this._gridTex,l.set2(0,0,e.texOffset),e.texScale=1):1!==t||g?(this._composeMapLayers(f,c,b,g,v),e.textureReference=null,l.set2(0,0,e.texOffset),e.texScale=1):(h=c[b],h.data?(k=h,l.set2(0,0,e.texOffset),e.texScale=1):(d=h.upsampleFromTile,k=d.tile.layerInfo[a][b],
l.set(d.offset,e.texOffset),e.texScale=d.scale),k&&(k.data instanceof HTMLImageElement&&(k.data=this._buildTexture(k.data)),e.textureReference=k.data));this._setNeedsRender()}},g.prototype.setGridImage=function(f){this._gridTex=this._buildTexture(f)},g.prototype._buildTexture=function(f){var a,c={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},b=this._context;if(f)try{a=new q(b,c,f)}catch(h){c.width=c.height=this.tileSize,
a=new q(b,c),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}else c.width=c.height=this.tileSize,a=new q(b,c);return b.bindTexture(a),a.generateMipmap(),a},g.prototype._drawVectorData=function(f,a,c,b,h,k,d,e){void 0===e&&(e=1);E(this._context,c,f,a.renderer,a.schemeHelper,c[0],b,h,0,k,d,e)},g.prototype._drawRasterData=function(f,a,c,b){void 0===b&&(b=1);var h=this._context,k=this._blendLayersProgram,d=this._vaoQuad;h.bindProgram(k);h.bindVAO(d);
u.assertCompatibleVertexAttributeLocations(d,k);h.bindTexture(f,0);k.setUniform1i("tex",0);k.setUniform1f("scale",a);k.setUniform2f("offset",c[0],c[1]);k.setUniform1f("opacity",b);h.drawArrays(5,0,u.vertexCount(d,"geometry"))},g.prototype._composeMapLayers=function(f,a,c,b,h){var k=r.LayerClass.MAP,d=this._context;f.renderData.texture||(f.renderData.texture=this._buildTexture());var e=f.renderData.texture,g=this._fbo;g&&g.width===e.descriptor.width&&g.height===e.descriptor.height||(g=y.create(d,{colorTarget:0,
depthStencilTarget:1,width:e.descriptor.width,height:e.descriptor.height}),this._fbo=g);var l=d.gl;d.bindFramebuffer(g);d.setViewport(0,0,this.tileSize,this.tileSize);d.setClearColor(0,0,0,0);d.setClearDepth(1);d.clear(l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT);d.setDepthTestEnabled(!1);d.setBlendFunctionSeparate(1,771,1,771);d.setBlendEquation(32774);d.setBlendingEnabled(!0);var m,p,n;for(b&&this._gridTex&&this._drawRasterData(this._gridTex,1,w);0<=c;c--)b=null,(m=a[c],m.data)?(b=m,p=w,n=1):m.upsampleFromTile&&
(n=m.upsampleFromTile,b=n.tile.layerInfo[k][c],p=n.offset,n=n.scale),b&&(((b.data instanceof HTMLImageElement||b.data instanceof HTMLCanvasElement)&&(b.data=this._buildTexture(b.data)),b.data instanceof D)?(g=f.parentSurface.layerViewByIndex(c,k),this._drawVectorData(b.data,g,f.lij,e.descriptor.width,e.descriptor.height,n,p,h[c])):this._drawRasterData(b.data,n,p,h[c]));d.bindTexture(e);l.copyTexImage2D(d.gl.TEXTURE_2D,0,e.descriptor.pixelFormat,0,0,e.descriptor.width,e.descriptor.height,0);e.generateMipmap();
d.bindFramebuffer(null);d.setBlendFunctionSeparate(770,771,1,771);d.setBlendingEnabled(!1);this._resourceCounter.incrementNumTileTexturesComposited()},g}()});