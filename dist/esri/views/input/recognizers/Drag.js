//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../InputHandler ./support ../../../core/now".split(" "),function(h,k,l,m,n,p){Object.defineProperty(k,"__esModule",{value:!0});h=function(h){function b(){var a=h.call(this,"recognizers.Drag",!1)||this;return a._startStateModifiers=new Set,a._activePointers=[],a._activePointerMap=new Map,a._isDragging=!1,a._drag=a.registerOutgoing("drag"),a.registerIncoming("pointer-drag",a._handlePointerDrag.bind(a)),a.registerIncoming("pointer-down",a._handlePointerDown.bind(a)),
a.registerIncoming("pointer-up",a._handlePointerUpAndPointerLost.bind(a)),a.registerIncoming("pointer-capture-lost",a._handlePointerUpAndPointerLost.bind(a)),a}return l(b,h),b.prototype._createPayload=function(a,d){return{action:a,pointers:this._activePointers.map(function(a){return a.data}),startState:this._startState,previousState:this._previousState,currentState:d}},b.prototype._fitCircleLSQ=function(){var a=this._activePointers.map(function(a){return a.data.currentEvent});return n.fitCircleLSQ(a)},
b.prototype._createDragState=function(){for(var a=this._fitCircleLSQ(),d=0,c=0,e=this._activePointers;c<e.length;c++){for(var b=e[c],f=this._pointerAngle(b,a),f=f-b.lastAngle;f>Math.PI;)f-=2*Math.PI;for(;f<-Math.PI;)f+=2*Math.PI;f=b.lastAngle+f;b.lastAngle=f;d+=f-b.initialAngle}return d/=this._activePointers.length,{angle:d,radius:a.radius,center:a.center,timestamp:p()}},b.prototype._updateMultiPointer=function(a){var d=a.startEvent["native"].pointerId,c=this._activePointerMap.get(d),b=!c;b?(c={data:null,
initialAngle:0,lastAngle:0},this._activePointers.push(c),this._activePointerMap.set(d,c),c.data={startEvent:a.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent},a=this._fitCircleLSQ(),c.initialAngle=this._pointerAngle(c,a),c.lastAngle=c.initialAngle):c.data={startEvent:c.data.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent};return b&&this._isDragging&&this._updateInitialAngles(),c},b.prototype._pointerAngle=function(a,d){a=a.data.currentEvent;return Math.atan2(a.y-
d.center.y,a.x-d.center.x)},b.prototype._updateInitialAngles=function(){for(var a=this._createDragState(),d=0,c=this._activePointers;d<c.length;d++){var b=c[d];b.initialAngle=this._pointerAngle(b,a)}},b.prototype._emitStart=function(a){this._updateInitialAngles();var b=this._createDragState();this._previousState=this._startState=b;this._startStateModifiers=a.modifiers;this._isDragging=!0;for(var c=0,e=this._activePointers;c<e.length;c++){var g=e[c];g.data={previousEvent:g.data.currentEvent,startEvent:g.data.currentEvent,
currentEvent:g.data.currentEvent}}this._drag.emit(this._createPayload("start",b),a.timestamp)},b.prototype._emitUpdate=function(a){a=this._createDragState();this._drag.emit(this._createPayload("update",a),void 0,this._startStateModifiers);this._previousState=a},b.prototype._emitEnd=function(){var a=this._createDragState();this._drag.emit(this._createPayload("end",a),void 0,this._startStateModifiers);this._startState=this._previousState=null;this._isDragging=!1},b.prototype._handlePointerDown=function(a){a=
a.data;this._isDragging&&this._emitEnd();this._updateMultiPointer({startEvent:a,previousEvent:a,currentEvent:a})},b.prototype._removeMultiPointer=function(a){var b=this,c=a["native"].pointerId,e=this._activePointerMap.get(c);if(e){var g=function(){b._activePointerMap["delete"](c);var a=b._activePointers.indexOf(e);b._activePointers.splice(a,1);b._isDragging&&b._updateInitialAngles()};this._isDragging?(this._updateMultiPointer({startEvent:e.data.startEvent,previousEvent:e.data.currentEvent,currentEvent:a}),
this._emitEnd(),g()):g()}},b.prototype._handlePointerUpAndPointerLost=function(a){this._removeMultiPointer(a.data)},b.prototype._handlePointerDrag=function(a){var b=a.data;switch(b.action){case "start":this._isDragging||this._emitStart(a);break;case "update":this._isDragging||this._emitStart(a),this._updateMultiPointer(b),this._emitUpdate(a)}},b}(m.InputHandler);k.Drag=h});