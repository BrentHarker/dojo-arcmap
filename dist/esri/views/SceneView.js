//>>built
define("../core/accessorSupport/watch dojo/_base/lang dojo/_base/kernel dojo/dom dojo/Deferred dojo/when ./View ./DOMContainer ./ViewAnimation ./animation/easing ../geometry/HeightModelInfo ../geometry/SpatialReference ../geometry/support/scaleUtils ../geometry/support/webMercatorUtils ../Camera ../Graphic ../geometry/Point ../geometry/Extent ../geometry/ScreenPoint ../Viewpoint ../core/Scheduler ../core/sniff ../core/watchUtils ../core/promiseUtils ../core/Error ../core/Logger ../core/HandleRegistry ../webscene/Environment ./support/screenshotUtils ./support/WebGLRequirements ./3d/environment/SceneViewEnvironment ./3d/environment/SceneViewEnvironmentManager ./3d/constraints/SceneViewConstraints ./3d/input/SceneInputManager ./3d/lib/glMatrix ./3d/support/cameraUtils ./3d/support/viewpointUtils ./3d/support/projectionUtils ./3d/webgl-engine/Stage ./3d/webgl-engine/lib/Selector ./3d/support/CombinedElevationProvider ./3d/support/HighlightOptions ./3d/support/RenderCoordsHelper ./3d/support/MapCoordsHelper ./3d/support/ResourceController ./3d/support/DisplayQualityProfile ./3d/support/QualitySettings ./3d/support/SharedSymbolResources ./3d/support/FocusTracker ./3d/support/debugFlags ./3d/terrain/TerrainSurface ./3d/terrain/terrainUtils ./3d/layers/graphics/Deconflictor ./3d/layers/GraphicsView3D ./3d/navigation/spherical/NavigationSpherical ./3d/navigation/planar/NavigationPlanar ./3d/support/Frustum ./ui/3d/DefaultUI3D".split(" "),
function(W,X,Y,Z,aa,ba,ca,da,q,ea,M,k,fa,v,E,ga,y,l,N,z,O,F,h,G,P,H,Q,ha,ia,ja,A,ka,R,la,ma,g,m,n,na,S,oa,B,T,pa,qa,I,U,J,K,ra,sa,w,ta,ua,va,wa,xa,ya){function t(a,b){return function(){return this._internallyReady?b.apply(this,arguments):this._get(a)}}function p(a,b){return function(c){return this._internallyReady?b.apply(this,arguments):(this._initialProps[a]=c,this._set(a,c),C[a]&&this.notifyChange("initialExtentRequired"),void 0)}}J=J["default"];var e=H.getLogger("esri.views.SceneView"),L=ma.vec3d,
r=L.create();H=new y(0,0,0);var D=new E(new y(0,0,0)),za={point:H,retval:null},x={heading:0,tilt:0},C={camera:["viewpoint"],viewpoint:["extent"],extent:["center","scale"],scale:["zoom"],center:[],zoom:[]},V=Object.keys(C);K=K["default"];return da.createSubclass([ca],{declaredClass:"esri.views.SceneView",properties:{animation:{type:q,value:null},basemapTerrain:{readOnly:!0,value:null},elevationProvider:{readOnly:!0,value:null},camera:{copy:function(a,b){a.position.x=b.position.x;a.position.y=b.position.y;
a.position.z=b.position.z;a.position.spatialReference=b.position.spatialReference;a.heading=b.heading;a.tilt=b.tilt},type:E},canvas:{readOnly:!0,value:null},center:{copy:function(a,b){return a?(a.x=b.x,a.y=b.y,a.z=b.z,a.spatialReference=b.spatialReference,a):b.clone()},type:y},clippingArea:{type:l,dependsOn:["map.clippingArea","map.clippingEnabled","viewingMode"],get:function(){if("global"===this.viewingMode)return null;if(this._userClippingArea)return this._userClippingArea;var a=this.get("map.clippingEnabled"),
b=this.get("map.clippingArea");return a&&b?b instanceof l?v.canProject(b.spatialReference,this.spatialReference)?(b=v.project(b,this.spatialReference),this._clippingArea&&b&&this._clippingArea.equals(b)?this._clippingArea:(this._clippingArea=b,b)):(e.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea):(this._clippingArea=null,null)},set:function(a){this.ready&&
"global"===this.viewingMode&&a?e.error("#clippingArea\x3d","Clipping area is only supported in local viewingMode"):(this._userClippingArea=a,this.notifyChange("clippingArea"))}},constraints:{type:R,value:null},dataExtent:{dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0,get:function(){function a(a){a&&(a=v.project(a,c))&&(d&&(a=a.intersection(d)),a&&b.push(a))}var b=[],c=this.spatialReference||k.WGS84,d=this.clippingArea;d&&(d=v.project(d,c));var f=this._get("basemapTerrain");
return(f&&f.spatialReference&&a(new l({xmin:f.extent[0],ymin:f.extent[1],zmin:0,xmax:f.extent[2],ymax:f.extent[3],zmax:0,spatialReference:f.spatialReference})),this.map&&this.map.allLayers.forEach(function(b){a(b.fullExtent)}),0<b.length)?(f=b.reduce(function(a,b){return a.union(b)}),f.hasZ?(f.zmin=Math.min(0,f.zmin),f.zmax=Math.max(0,f.zmax)):(f.zmin=0,f.zmax=0),f):new l({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:c})}},environment:{value:null,set:function(a){return a!==this._defaults.environment&&
(this._externallySet.environment=!0),a?void(a instanceof A?this._set("environment",a):a instanceof ha?this.environment.lighting=a.lighting:a.declaredClass?this._set("environment",a):this._set("environment",new A(a))):void this._set("environment",new A)}},environmentManager:{},extent:{copy:function(a,b){a.xmin=b.xmin;a.ymin=b.ymin;a.zmin=b.zmin;a.xmax=b.xmax;a.ymax=b.ymax;a.zmax=b.zmax;a.spatialReference=b.spatialReference},type:l},fullOpacity:1,groundExtent:{dependsOn:["basemapTerrain.extent"],readOnly:!0,
get:function(){var a=this._get("basemapTerrain");if(a&&a.spatialReference){var b=a.extent;return new l({xmin:b[0],ymin:b[1],xmax:b[2],ymax:b[3],spatialReference:a.spatialReference})}return new l({spatialReference:this.spatialReference||k.WGS84})}},initialExtentRequired:{dependsOn:["map.initialViewProperties.viewpoint"],get:function(){if(this.get("map.initialViewProperties.viewpoint"))return!1;for(var a=0;a<V.length;a++)if(this._initialProps&&void 0!==this._initialProps[V[a]])return!1;return!0}},heightModelInfo:{type:M,
dependsOn:["map.initialViewProperties.heightModelInfo","defaultsFromMap.heightModelInfo"]},interacting:{dependsOn:["navigation.interacting"],get:function(){return!(!this.navigation||!this.navigation.interacting)}},map:{value:null},mapCoordsHelper:{},screenSizePerspectiveEnabled:!0,navigation:{readOnly:!0,value:null},inputManager:{},qualityProfile:{set:function(a){I.isValidProfile(a)&&(I.apply(a,this),this._set("qualityProfile",a))}},qualitySettings:{type:U},ready:{dependsOn:["viewingMode"]},renderCoordsHelper:{},
resolution:{dependsOn:["scale","spatialReference"],readOnly:!0,get:function(){return null!=this.spatialReference?fa.getResolutionForScale(this.scale,this.spatialReference):0}},scale:{},spatialReference:{dependsOn:["map.initialViewProperties.spatialReference","defaultsFromMap.isSpatialReferenceDone"]},type:"3d",ui:{type:ya},updating:{},updatingPercentage:0,viewingMode:{dependsOn:["map.initialViewProperties.viewingMode","spatialReference"],get:function(){var a=this.get("map.initialViewProperties.viewingMode"),
b=this.spatialReference;return a||(a=!b||b.isWebMercator||b.isWGS84?"global":"local"),a},set:function(a){this._internallyReady?e.error("#viewingMode","viewingMode cannot be set once view is ready"):0<=["local","global"].indexOf(a)?this._override("viewingMode",a):void 0===a&&this._clearOverride("viewingMode")}},viewpoint:{copy:function(a,b){a.rotation=b.rotation;a.scale=b.scale;a.targetGeometry=b.targetGeometry;a.camera=b.camera},dependsOn:["camera"],type:z},zoom:{dependsOn:["scale"]},highlightOptions:{type:B}},
getDefaults:function(a){var b=this.inherited(arguments);return b.constraints||a.constraints||(this._defaults.constraints=new R,b.constraints=this._defaults.constraints),b.environment||a.environment||(this._defaults.environment=new A,b.environment=this._defaults.environment),b.popup.autoPanEnabled=!1,b.qualitySettings=new U,b.qualityProfile=I.getDefaultProfile(),b.highlightOptions=new B,b},constructor:function(){h.when(this,"ready",this._viewReadyHandler.bind(this));this._internallyReady=!1;this._initialProps=
{};this._initialDefaultSpatialReference=this._gotoTask=this._userHeightModelInfo=this._userClippingArea=null;this._initCoordinateSystem();this._frustum=new xa;this._clippingArea=this._constraints=this._animationStateWatcher=null;this.inputManager=new la({view:this});this._defaults={};this._externallySet={};this.resourceController=new qa(this);this.deconflictor=new ta(this);this._evaluateUpdating=this._evaluateUpdating.bind(this);this._layerViewsUpdatingHandles={};this._navigationHandles=new Q;this._stageHandles=
new Q;this._navigationPauseNotifications=!1;this._navigationHandles.add([h.on(this,"navigation","currentViewChanged",this._navigationCurrentViewChanged.bind(this),null,null,!0),h.on(this,"navigation","currentViewReachedTarget",this._navigationCurrentViewReachedTarget.bind(this),null,null,!0),h.on(this,"navigation","targetViewChanged",function(a){this._navigationPauseNotifications||this._navigationTargetViewChanged(a)}.bind(this),null,null,!0),h.on(this,"navigation","animationStarted",function(a){this._navigationPauseNotifications||
this._navigationAnimationStarted(a)}.bind(this),null,null,!0)]);this.watch("map",function(a){a&&a.load&&a.load()})},initialize:function(){this.environmentManager=new ka({view:this});this._updateUpdatingMonitorsHandle=this.allLayerViews.on("change",this._updateUpdatingMonitors.bind(this));this._updateUpdatingMonitors({added:this.allLayerViews.toArray(),removed:[],moved:[]});h.whenNot(this,"ready",this._viewUnreadyHandler.bind(this));h.init(this.qualitySettings,"gpuMemoryLimit",function(a){this.resourceController&&
this.resourceController.setMaxGpuMemory(a)}.bind(this))},destroy:function(){W.dispatchTarget(this);this.environmentManager.destroy();this._disposeGraphicsView();this._updateUpdatingMonitorsHandle.remove();this._updateUpdatingMonitorsHandle=null;this._navigationHandles.remove();this._navigationHandles=null;this._stageHandles.remove();this.inputManager&&(this.inputManager.destroy(),this.inputManager=null)},destroyLayerViews:function(){for(var a in this._layerViewsUpdatingHandles)this._layerViewsUpdatingHandles[a].remove();
this._layerViewsUpdatingHandles={};this._disposeSurface();this.inherited(arguments);this._stage&&(this._stage.dispose(),this._stage=null,this._stageHandles.remove());this._setCanvas(null);this.deconflictor.destroy();this.deconflictor=null;this.resourceController.destroy();this.resourceController=null},on:function(a,b,c){var d=this.inputManager.viewEvents.register(a,b,c);return d?d:this.inherited(arguments)},toMap:function(a,b,c){if(!this._internallyReady)return e.error("#toMap()","Scene view cannot be used before it is ready"),
null;a=this._normalizePointArgs(a,b,void 0,c);b=this._stage.pick([a.point.x,this.height-a.point.y]).getMinResult();return this._computeMapPointFromIntersectionResult(b,a.retval)},toScreen:function(a,b,c,d){if(!this._internallyReady)return e.error("#toScreen()","Scene view cannot be used before it is ready"),null;a=this._normalizePointArgs(a,b,c,d);return n.pointToVector(a.point,r,this.renderSpatialReference),this.engineToScreen(r,a.retval)},pixelSizeAt:function(a,b,c){if(!this._internallyReady)return e.error("#pixelSizeAt()",
"Scene view cannot be used before it is ready"),null;if("esri.geometry.ScreenPoint"===a.declaredClass){if(!this._stage.pick([a.x,this.height-a.y]).getMinResult().getIntersectionPoint(r))return 0}else a=this._normalizePointArgs(a,b,c,void 0),n.pointToVector(a.point,r,this.renderSpatialReference);return this.navigation.currentCamera.computePixelSizeAt(r)},hitTest:function(a,b){if(!this._internallyReady)return e.error("#hitTest()","Scene view cannot be used before it is ready"),null;var c;a=this._normalizePointArgs(a,
b,void 0,void 0);var d=[a.point.x,this.height-a.point.y],f=this._stage.pick(d,null,!0);a=f.getMinResult();var u=this._computeMapPointFromIntersectionResult(a);switch(a.targetType){case "None":c=null;break;case "StageObject":c=this._getGraphicFromStageObject(a.target,a.triangleNr);break;case "StagePoint":c=this._getGraphicFromStagePoint(a.target)}return ba(c).otherwise(function(){return null}).then(function(a){var b=[];(a||u)&&b.push({mapPoint:u,graphic:a});a={screenPoint:d,results:b};return ra.SCENEVIEW_HITTEST_RETURN_SELECTOR&&
(a.selector=f),a})},goTo:function(a,b){if(!this._internallyReady)return void e.error("#goTo()","Scene view cannot be used before it is ready");b=X.mixin({animate:!0},b);a=m.create(this,a,b);return this._gotoTask={},b.animate?this._gotoAnimated(a,b):this._gotoImmediate(a,b)},animateTo:function(a,b){return Y.deprecated(this.declaredClass+".animateTo is deprecated. Use .goTo instead.","","4.0"),this.goTo(a,b)},takeScreenshot:function(a){if(!this._internallyReady)return void e.error("#takeScreenshot()",
"Scene view cannot be used before it is ready");a=ia.adjustScreenshotSettings(a,this);var b=new aa;return this._stage.requestScreenCapture(a,function(a){O.schedule(function(){b.resolve(a)})}),b.promise},engineToScreen:function(a,b){var c=L.create();this._stage.getCamera().projectPoint(a,c);a=c[0];var d=this.height-c[1],c=c[2];return b?(b.x=a,b.y=d,b.z=c,b):new N({x:a,y:d,z:c})},getDefaultSpatialReference:function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||
this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null},getDefaultHeightModelInfo:function(){return this.get("map.initialViewProperties.heightModelInfo")||this.get("defaultsFromMap.heightModelInfo")||null},validate:function(){var a=ja.check();return F("safari")&&9>F("safari")&&(a=new P("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari \x3c 9)",{type:"safari",requiredVersion:9,detectedVersion:F("safari")})),a?G.reject(a):G.resolve()},
isSpatialReferenceSupported:function(a,b){var c=a.isGeographic,d=a.isWebMercator,f=a.isWGS84,u="local"===this.viewingMode,e=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(e){if(u&&c||!u&&!d&&!f)return!1}else if(c&&!f)return!1;if(b)if(w.isTiledLayer(b)){var g,c=w.getTileInfo(b);if(g=e?null==w.checkIfTileInfoSupportedForView(c,b.fullExtent,a,this.viewingMode):null==w.checkIfTileInfoSupportedForView(c,b.fullExtent,a,"local")||null==w.checkIfTileInfoSupportedForView(c,
b.fullExtent,a,"global"),!g)return!1}else if((f||d)&&!u)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=a),e||this.ready||(this.viewingMode="global"),!1;return!0},isHeightModelInfoRequired:function(){return!0},has:function(a){return this._stage.has(a)},flushDisplayModifications:function(){this._stage.processDirty()},getFrustum:function(){return this._frustum.dirty&&this._frustum.update(this.navigation.currentCamera),this._frustum},getDrawingOrder:function(a){return this.allLayerViews.findIndex(function(b){return b.layer&&
b.layer.uid===a})},getViewForGraphic:function(a){return a.layer?this.allLayerViews.find(function(b){return b.layer===a.layer}):this._graphicsView},whenViewForGraphic:function(a){return a.layer?this.whenLayerView(a.layer):G.resolve(this._graphicsView)},renderSpatialReference:null,_graphicsView:null,_surfaceReadyWatchHandle:null,_stageHandles:null,_navigationHandles:null,_gotoImmediate:function(a,b){var c=this._gotoTask;return a.then(function(a){c===this._gotoTask&&(this.viewpoint=a)}.bind(this))},
_gotoAnimated:function(a,b){!this.animation||"running"!==this.animation.state&&"waiting-for-target"!==this.animation.state?this.animation=new q({target:a}):this.animation.target=a;var c=this.animation;return c.state="waiting-for-target",a.then(function(d){if(c.target===a&&this.animation===c){c.target=d;c.state="running";d=m.toCamera(this,d);if(!d)throw e.error("#goTo()","Invalid target specified for animateTo"),new P("goto:invalid-camera","Invalid camera in conversion from viewpoint");if(this._cameraAlmostEquals(this.camera,
d))return void c.finish();d=g.externalToInternal(this,d);if(d.almostEquals(this.navigation.currentCamera,5E-4/this.renderCoordsHelper.unitInMeters))return void c.finish();this._navigationPauseNotifications=!0;this._setInternalCamera(d,this._animateOptions(b));c.state===q.State.STOPPED&&c.stop();this._navigationPauseNotifications=!1}}.bind(this)).otherwise(function(){c.target===a&&this.animation===c&&(this.animation=null,c.finish())}),c},_animateOptions:function(a){var b={animate:!0};return a&&null!=
a.speedFactor&&(b.speedFactor=a.speedFactor),a&&null!=a.duration&&(b.duration=a.duration/1E3),a&&null!=a.minDuration&&(b.minDuration=a.minDuration/1E3),a&&null!=a.maxDuration&&(b.maxDuration=a.maxDuration/1E3),a&&null!=a.easing&&("string"==typeof a.easing?b.easing=ea.named[a.easing]:b.easing=a.easing),b},_trackCanvasSize:function(){this.on("resize",function(a){if(this.canvas){this.canvas.width=a.width;this.canvas.height=a.height;var b=this._stage.getCamera();b.width=a.width;b.height=a.height;this._stage.setCamera(b);
this.navigation&&(this.navigation.windowSize=[a.width,a.height])}}.bind(this));this.canvas.width=this.width;this.canvas.height=this.height},_computeMapPointFromIntersectionResult:function(a,b){if(a.getIntersectionPoint(r)){b=this._computeMapPointFromVec3d(r,b);var c=this._get("basemapTerrain");"terrain"===a.intersector&&c&&(a=c.getElevation(b),null!==a&&(b.z=a));return b}return null},_computeMapPointFromVec3d:function(a,b){var c=this.spatialReference||k.WGS84;return n.vectorToVector(a,this.renderSpatialReference,
a,c)||(c=k.WGS84,n.vectorToVector(a,this.renderSpatialReference,a,c)),b?(b.x=a[0],b.y=a[1],b.z=a[2],b.spatialReference=c):b=new y(a,c),b},_getGraphicFromStageObject:function(a,b){var c=a.getMetadata();if(null!=c&&null!=c.layerId){if(c.layerId===this._graphicsView.mockLayerId)return this._graphicsView.getGraphicsFromStageObject(a,b);if(c=this.map.findLayerById(c.layerId))return this.whenLayerView(c).then(function(c){return c&&null!=c.getGraphicsFromStageObject&&!c.suspended?c.getGraphicsFromStageObject(a,
b):void 0})}return null},_getGraphicFromStagePoint:function(a){var b=this._computeMapPointFromVec3d(a.point),b=new ga(b);a=a.metadata.layerId;return null!=a&&(b.layer=this.map.findLayerById(a)),b},_viewingModeToManifold:function(a){return{local:"planar",global:"spherical"}[a]},_initBasemapTerrain:function(a){this._disposeBasemapTerrain();this._set("basemapTerrain",new sa(this,this._viewingModeToManifold(a)));this._set("elevationProvider",new oa(this));this.elevationProvider.register("ground",this.basemapTerrain);
this.navigation.elevationProvider=this.basemapTerrain},_initGlobe:function(a){this._initCoordinateSystem();this._initNavigation(a);this._stage.setViewParams({backgroundColor:[0,0,0,0],maxFarNearRatio:0,frustumCullingEnabled:!1});this._initBasemapTerrain(a);this._navigationCurrentViewChanged({camera:this.navigation.currentCamera})},_initCoordinateSystem:function(){if(this.spatialReference){var a=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(a)||(this.mapCoordsHelper=
new pa(this.map,a));var b=this.renderCoordsHelper?this.renderCoordsHelper.unitInMeters:1,c="global"===this.viewingMode,a=c?n.SphericalRenderSpatialReference:a;a!==this.renderSpatialReference&&(this.renderSpatialReference=a,(this.renderCoordsHelper=new (c?T.Spherical:T.Planar)(a),this._stage&&this._stage.setIntersectTolerance(S.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._constraints)&&this._constraints.scale(b/this.renderCoordsHelper.unitInMeters))}else this.renderSpatialReference=
this.renderCoordsHelper=this.mapCoordsHelper=null},_paddingEqualsArray:function(a){var b=this.padding;return b?b.top===a[0]&&b.right===a[1]&&b.bottom===a[2]&&b.left===a[3]:!0},_navigationCurrentViewChanged:function(a){this._frustum.dirty=!0;a=a.camera;var b=a.padding,c=this._get("basemapTerrain"),d=c.spatialReference;d&&(d=this.renderCoordsHelper.fromRenderCoords(a.eye,d),c=c.getElevation(d)||0,a.aboveGround=d.z>=c);this._paddingEqualsArray(b)||(c=this._padding,b={top:b[0],right:b[1],bottom:b[2],
left:b[3]},this._internallyReady?(this._padding=b,this.notifyChange("padding",c,b)):this.padding=b);this._stage.setCamera(a);this.notifyChange("center");this.notifyChange("extent");this.notifyChange("scale");b=this.camera;a=g.internalToExternal(this,a,D);b&&this._cameraAlmostEquals(b,a)||this.notifyChange("camera")},_cameraAlmostEquals:function(a,b){return 1E-5>Math.abs(a.tilt-b.tilt)&&1E-5>Math.abs(a.heading-b.heading)&&1E-5>Math.abs(a.fov-b.fov)&&a.position.equals(b.position)},_navigationAnimationStarted:function(a){a=
m.fromInternalCamera(this,this.navigation.targetCamera);this.animation?this.animation.target=a:this.animation=new q({target:a})},_navigationTargetViewChanged:function(a){if(this.animation&&"waiting-for-target"!==this.animation.state){a=a.camera;var b=this.spatialReference||k.WGS84,c=g.internalToExternal(this,a);a=new z({camera:c,targetGeometry:n.vectorToPoint(a.center,b,this.renderSpatialReference),scale:g.computeScale(this,a),rotation:m.headingToRotation(c.heading)});this.animation.target=a}},_navigationCurrentViewReachedTarget:function(a){if((a.interruptedAnimation||
a.finishedAnimation)&&(this._gotoTask=null),this.animation&&(a.interruptedAnimation||a.finishedAnimation)){this._animationStateWatcher&&(this._animationStateWatcher.remove(),this._animationStateWatcher=null);var b=this.animation;this.animation=null;a.finishedAnimation?b.finish():b.stop();this.notifyChange("animation")}},_setInternalCamera:function(a,b){return a&&(this.navigation.setCamera(a,b),this._externallySet.camera=!0),!!a},_setCamera:function(a,b){return this._setInternalCamera(g.externalToInternal(this,
a),b)},_evaluateUpdating:function(){var a=0,b=0,c=!1;this.allLayerViews.forEach(function(d){d.updating&&(c=!0,d=d.updatingPercentage,null!=d&&(++b,a+=d))});this._graphicsView&&this._graphicsView.updating&&(c=!0);c!==this.updating&&(this.updating=c);0!==b?a/=b:a=c?100:0;this.updatingPercentage!==a&&(this.updatingPercentage=a)},_updateUpdatingMonitors:function(a){for(var b=0;b<a.removed.length;b++){var c=a.removed[b],d=this._layerViewsUpdatingHandles[c.id];d&&(delete this._layerViewsUpdatingHandles[c.id],
c.destroyed||d.remove())}for(b=0;b<a.added.length;b++)c=a.added[b],c.destroyed||(d=c.watch(["updating","updatingPercentage"],this._evaluateUpdating),this._layerViewsUpdatingHandles[c.id]=d);this._evaluateUpdating()},_spatialReferenceSetter:function(a){this.inherited(arguments);this._initCoordinateSystem()},_setInitialView:function(a){if(a&&!this._externallySet.camera){var b=null;if(a instanceof z&&!a.camera&&a.targetGeometry instanceof l&&(b=m.rotationToHeading(a.rotation),a=a.targetGeometry),a instanceof
z)this.viewpoint=a;else if(a instanceof E)this.camera=a;else{var c=this._getDesiredHeadingTilt();null!=b&&(c.heading=b);m.create(this,{target:a,heading:c.heading,tilt:c.tilt}).then(function(a){this.navigation._dataExtentChanged();this.viewpoint=a}.bind(this))}}},_pickRay:function(a,b,c,d,f,e,g){return this._stage?this._stage.pickRay(a,b,c,d,f,e,g):null},_pickRayWithBeginPoint:function(a,b,c,d,f){return this._stage?this._stage.pickRayWithBeginPoint(a,b,c,d,f):null},_removeHandles:function(a){for(var b=
0;b<a.length;b++){var c=a[b];this[c]&&(this[c].remove(),this[c]=null)}},_setCanvas:function(a){a!==this._get("canvas")&&this._set("canvas",a)},_disposeSurface:function(){this._removeHandles(["_stageFrameTask","_updateDrawingOrderHandle","onViewExtentUpdateHandle","_mapLayersChangeHandle"]);this._disposeBasemapTerrain();this._setNavigation(null);this.environmentManager&&this.environmentManager.disposeRendering()},_disposeBasemapTerrain:function(){var a=this._get("basemapTerrain");a&&(a.destroy(),this._set("basemapTerrain",
null))},_disposeNavigation:function(){var a=this._get("navigation");a&&(a.destroy(),a.elevationProvider=null,this._set("navigation",null));this.focusTracker&&(this.focusTracker.destroy(),this.focusTracker=null)},_setNavigation:function(a){this._get("navigation")!==a&&(this._disposeNavigation(),a&&(a.windowSize=[this.width,this.height],a.userConstraints=this.constraints),this._set("navigation",a))},_initNavigation:function(a){a=a||this.viewingMode;var b={view:this};"global"===a?this._setNavigation(new va(b)):
this._setNavigation(new wa(b));this.focusTracker=new K(this)},_initSurface:function(){var a={};a.deactivatedWebGLExtensions=this.deactivatedWebGLExtensions;a.viewingMode=this.viewingMode;this.renderCanvas&&(a.canvas=this.renderCanvas);this._stage=new na(this.viewingMode,Z.byId(this.surface),a);this._stage.selectionState=!1;this._stageHandles.add(h.init(this.qualitySettings,"antialiasingEnabled",function(){this._stage.setRenderParams({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})}.bind(this)));
this._stageHandles.add(h.watch(this,this.highlightOptions.keys().map(function(a){return"highlightOptions."+a}),function(){this._stage.setRenderParams({defaultHighlightOptions:B.toEngineOptions(this.highlightOptions)})}.bind(this)));this._stageHandles.add(h.init(this,"highlightOptions",function(){this._stage.setRenderParams({defaultHighlightOptions:B.toEngineOptions(this.highlightOptions)})}.bind(this)));this.renderCoordsHelper&&this._stage.setIntersectTolerance(S.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters);
this._setCanvas(this._stage.getCanvas());this._stageFrameTask=O.addFrameTask(this._stage.getFrameTask());this._trackCanvasSize();this._initGlobe(this.viewingMode);this.sharedSymbolResources=new J({stage:this._stage,viewingMode:this.viewingMode,resourceController:this.resourceController,focusTracker:this.focusTracker})},_initGraphicsView:function(){this._surfaceReadyWatchHandle=h.whenTrueOnce(this,"basemapTerrain.ready",function(){this._graphicsView=new ua({view:this,graphics:this.graphics});this._surfaceReadyWatchHandle=
null;this._layerViewsUpdatingHandles[this._graphicsView.mockLayerId]=h.init(this._graphicsView,"updating",this._evaluateUpdating)}.bind(this))},_disposeGraphicsView:function(){if(this._surfaceReadyWatchHandle&&(this._surfaceReadyWatchHandle.remove(),this._surfaceReadyWatchHandle=null),this._graphicsView){var a=this._graphicsView.mockLayerId;this._layerViewsUpdatingHandles[a].remove();delete this._layerViewsUpdatingHandles[a];this._graphicsView.destroy();this._graphicsView=null}},_normalizePointArgs:function(a,
b,c,d,f){f=f||za;var e=f.point;return e.spatialReference=void 0,"object"==typeof a?(e.x=a.x,e.y=a.y,e.z=a.z,a.spatialReference&&(e.spatialReference=a.spatialReference),f.retval=b):(e.x=a,e.y=b,"number"!=typeof c&&void 0!==c?(e.z=void 0,f.retval=c):(e.z=c,f.retval=d)),e.spatialReference||(e.spatialReference=this.spatialReference||k.WGS84),f},_separateInitialProperties:function(){var a,b={},c={},d={},f=function(a){if(a=C[a])for(var b=0;b<a.length;b++)d[a[b]]=!0,f(a[b])};for(a in this._initialProps){var e=
this._initialProps[a];C[a]?(f(a),b[a]=e):c[a]=e}for(a in d)delete b[a];return{view:b,other:c}},_viewReadyHandler:function(a,b){if(!b){"global"===this.viewingMode&&(this._clippingArea=null);this._internallyReady=!0;this._initSurface();this._initGraphicsView();var c;a=this._separateInitialProperties();for(c in a.other)this.set(c,a.other[c]);for(c in a.view)this.set(c,a.view[c]);c=this.get("map.initialViewProperties.viewpoint");a=this.get("initialExtent");(c?this._setInitialView(c):a&&a.spatialReference.equals(this.spatialReference)?
this._setInitialView(a):"local"===this.viewingMode&&h.whenOnce(this.basemapTerrain,"ready",function(){this._setInitialView(this.groundExtent)}.bind(this)),this._externallySet.environment)||(c=this.get("map.initialViewProperties.environment"))&&(this.environment=c);this._initialProps={};this.notifyChange("initialExtentRequired");this._updateDrawingOrderHandle=this.allLayerViews.on("change",this._updateDrawingOrder.bind(this));this._updateDrawingOrder({added:this.allLayerViews.toArray(),removed:[],
moved:[]});this.environmentManager.updateReadyChange(!0)}},_viewUnreadyHandler:function(a,b){b&&(this._initialDefaultSpatialReference=null,this.environmentManager.updateReadyChange(!1),this._disposeGraphicsView(),this._internallyReady=!1,this._disposeSurface(),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this._stage&&(this._stage.dispose(),this._stage=null,this._stageHandles.remove()),this._setCanvas(null))},_getDesiredHeadingTilt:function(){if(this._externallySet.camera){var a=
this.camera;x.heading=a.heading;x.tilt=a.tilt}else x.heading=0,x.tilt=.5;return x},_cameraSetter:p("camera",function(a){this._setCamera(a,{animate:!1})||e.error("#camera\x3d","Invalid camera",a)}),_cameraGetter:t("camera",function(a){return g.internalToExternal(this,this.navigation.currentCamera,a)}),_externalExtent:function(){return this._cachedExtentDirty&&(g.toExtent(this,null,null,this._cachedExtent,D),this._cachedExtentDirty=!1),this._cachedExtent},_extentGetter:t("extent",function(a){return g.toExtent(this,
null,null,a,D)}),_extentSetter:p("extent",function(a){var b=g.fromExtent(this,a,this._getDesiredHeadingTilt(),D);b?this.camera=b:this._isIncompatibleSpatialReference(a.spatialReference)?e.error("#extent\x3d","Extent has an incompatible spatial reference (extent: "+a.spatialReference.wkid+", view: "+this.spatialReference.wkid+")",a):e.error("#extent\x3d","Invalid extent",a)}),_heightModelInfoGetter:function(){var a=this.getHeightModelInfoWithOverride();return a&&null==a.heightUnit&&(a=M.deriveUnitFromSR(a,
this.spatialReference)),a},_heightModelInfoSetter:function(a){this._internallyReady?e.error("#heightModelInfo","heightModelInfo cannot be set once view is ready"):this.setHeightModelInfoOverride(a)},_isIncompatibleSpatialReference:function(a){return a&&!a.equals(this.spatialReference)&&!v.canProject(a,this.spatialReference)},_scaleGetter:t("scale",function(){return null!=this.navigation?g.computeScale(this,this.navigation.currentCamera):0}),_scaleSetter:p("scale",function(a){var b=this._getDesiredHeadingTilt(),
c=this.navigation.currentCamera.center,d=L.create();n.vectorToVector(c,this.renderSpatialReference,d,k.WGS84);a=g.scaleToDistance(this,a,d[1]);b=g.eyeHeadingTiltForCenterPointAtDistance(this,b.heading,b.tilt,c,a);this._externallySet.camera=!0;this.navigation.setCameraFromEyeCenterAndUp(b.eye,b.center,b.up,{animate:!1})}),_zoomGetter:t("zoom",function(){return g.scaleToZoom(this,this.scale)}),_zoomSetter:p("zoom",function(a){this.scale=g.zoomToScale(this,a)}),_centerGetter:t("center",function(a){var b=
this.spatialReference||k.WGS84;return n.vectorToPoint(this.navigation.currentCamera.center,this.renderSpatialReference,a||b,b)}),_centerSetter:p("center",function(a){if(this._isIncompatibleSpatialReference(a&&a.spatialReference))return void e.error("#center\x3d","Center has an incompatible spatial reference (center: "+a.spatialReference.wkid+", view: "+this.spatialReference.wkid+")",a);var b=this._getDesiredHeadingTilt();(b=g.eyeHeadingTiltForCenterPointAtDistance(this,b.heading,b.tilt,a,this.navigation.currentCamera.distance))||
e.error("#center\x3d","Invalid center",a);this._externallySet.camera=!0;this.navigation.setCameraFromEyeCenterAndUp(b.eye,b.center,b.up,{animate:!1})}),_viewpointGetter:t("viewpoint",function(){return m.fromCamera(this,this.camera)}),_viewpointSetter:p("viewpoint",function(a){var b=m.toCamera(this,a);b?this._setCamera(b,{animate:!1}):e.error("#viewpoint\x3d","Invalid viewpoint",a)}),_screenCenterGetter:function(){var a=this.padding;return new N((this.size[0]-(a.left+a.right))/2+a.left,(this.size[1]-
(a.top+a.bottom))/2+a.top)},_updateDrawingOrder:function(){var a=this.allLayerViews.length-1;this.allLayerViews.forEach(function(b,c){null!=b.drawingOrder&&(b.drawingOrder=a-c)},this)},_paddingSetter:p("padding",function(a){this._set("padding",{top:a&&a.top||0,right:a&&a.right||0,bottom:a&&a.bottom||0,left:a&&a.left||0});this.navigation&&(this.navigation.padding=this._get("padding"))}),_constraintsSetter:p("constraints",function(a){this._set("constraints",a);a===this._defaults.constraints&&(this._defaults.constraints=
null,a.scale(1/this.renderCoordsHelper.unitInMeters));this.navigation.userConstraints=a}),_animationSetter:function(a){if(a!==this._get("animation")){if(!this._internallyReady)return void e.error("#animation\x3d","Scene view cannot be used before it is ready");this._animationStateWatcher&&(this._animationStateWatcher.remove(),this._animationStateWatcher=null);this._set("animation",a);a&&(this._animationStateWatcher=a.watch("state",function(a){(a===q.State.FINISHED||a===q.State.STOPPED)&&(this.animation=
null,a===q.State.FINISHED?this.navigation.setCurrentToTarget():this.navigation.setCamera(this.navigation.currentCamera,{animate:!1}))}.bind(this)))}},_mapSetter:function(a){a!==this._get("map")&&(this.navigation&&this.navigation._dataExtentChanged(),this._mapLayersChangeHandle&&this._mapLayersChangeHandle.remove(),a&&(this._mapLayersChangeHandle=a.allLayers.on("change",this.notifyChange.bind(this,"dataExtent"))),delete this._externallySet.camera,this.inherited(arguments))}})});