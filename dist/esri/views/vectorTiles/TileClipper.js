//>>built
define(["require","exports","./Geometry","./GeometryUtils"],function(u,x,h,v){Object.defineProperty(x,"__esModule",{value:!0});var w=function(){return function(e,a,b){this.ratio=e;this.x=a;this.y=b}}();u=function(){function e(a,b,c){this.dz=a;this.yPos=b;this.xPos=c}return e.prototype.setExtent=function(a){this.finalRatio=4096/a*(1<<this.dz);var b;b=64/this.finalRatio;a>>=this.dz;b>a&&(b=a);this.margin=b;this.xmin=a*this.xPos-b;this.ymin=a*this.yPos-b;this.xmax=this.xmin+a+2*b;this.ymax=this.ymin+
a+2*b},e.prototype.reset=function(a){this.type=a;this._prevIsIn=!1;this.lines=[];this.line=null},e.prototype.moveTo=function(a,b){this._pushLine();this._prevIsIn=this._isIn(a,b);this._moveTo(a,b,this._prevIsIn);this._prevPt=new h.Point(a,b);this._firstPt=new h.Point(a,b)},e.prototype.lineTo=function(a,b){var c,g,d,k,f,e,l,n,m=this._isIn(a,b);if(m)this._prevIsIn?this._lineTo(a,b,!0):(c=this._prevPt,g=new h.Point(a,b),d=this._intersect(g,c),this._lineTo(d.x,d.y,!0),this._lineTo(g.x,g.y,!0));else{if(this._prevIsIn)g=
this._prevPt,c=new h.Point(a,b),d=this._intersect(g,c),this._lineTo(d.x,d.y,!0);else if(d=this._prevPt,c=new h.Point(a,b),!(d.x<=this.xmin&&c.x<=this.xmin||d.x>=this.xmax&&c.x>=this.xmax||d.y<=this.ymin&&c.y<=this.ymin||d.y>=this.ymax&&c.y>=this.ymax))if(g=[],(d.x<this.xmin&&c.x>this.xmin||d.x>this.xmin&&c.x<this.xmin)&&(k=(this.xmin-d.x)/(c.x-d.x),n=d.y+k*(c.y-d.y),n<=this.ymin?e=!1:n>=this.ymax?e=!0:g.push(new w(k,this.xmin,n))),(d.x<this.xmax&&c.x>this.xmax||d.x>this.xmax&&c.x<this.xmax)&&(k=(this.xmax-
d.x)/(c.x-d.x),n=d.y+k*(c.y-d.y),n<=this.ymin?e=!1:n>=this.ymax?e=!0:g.push(new w(k,this.xmax,n))),(d.y<this.ymin&&c.y>this.ymin||d.y>this.ymin&&c.y<this.ymin)&&(k=(this.ymin-d.y)/(c.y-d.y),l=d.x+k*(c.x-d.x),l<=this.xmin?f=!1:l>=this.xmax?f=!0:g.push(new w(k,l,this.ymin))),(d.y<this.ymax&&c.y>this.ymax||d.y>this.ymax&&c.y<this.ymax)&&(k=(this.ymax-d.y)/(c.y-d.y),l=d.x+k*(c.x-d.x),l<=this.xmin?f=!1:l>=this.xmax?f=!0:g.push(new w(k,l,this.ymax))),0===g.length)f?e?this._lineTo(this.xmax,this.ymax,!0):
this._lineTo(this.xmax,this.ymin,!0):e?this._lineTo(this.xmin,this.ymax,!0):this._lineTo(this.xmin,this.ymin,!0);else if(1<g.length&&g[0].ratio>g[1].ratio)this._lineTo(g[1].x,g[1].y,!0),this._lineTo(g[0].x,g[0].y,!0);else for(k=0;k<g.length;k++)this._lineTo(g[k].x,g[k].y,!0);this._lineTo(c.x,c.y,!1)}this._prevIsIn=m;this._prevPt=new h.Point(a,b)},e.prototype.close=function(){var a,b;0<this.line.length&&(a=this._firstPt,b=this._prevPt,a.x===b.x&&a.y===b.y||this.lineTo(a.x,a.y),a=this.line,b=a.length,
4<=b&&(a[0].x===a[1].x&&a[0].x===a[b-2].x||a[0].y===a[1].y&&a[0].y===a[b-2].y)&&(a.pop(),a[0].x=a[b-2].x,a[0].y=a[b-2].y))},e.prototype.result=function(){return this._pushLine(),0===this.lines.length?null:(3===this.type&&y.simplify(this.margin*this.finalRatio,this.lines),this.lines)},e.prototype._isIn=function(a,b){return a>=this.xmin&&a<=this.xmax&&b>=this.ymin&&b<=this.ymax},e.prototype._intersect=function(a,b){var c,g;if(b.x>=this.xmin&&b.x<=this.xmax)g=b.y<=this.ymin?this.ymin:this.ymax,c=a.x+
(g-a.y)/(b.y-a.y)*(b.x-a.x);else if(b.y>=this.ymin&&b.y<=this.ymax)c=b.x<=this.xmin?this.xmin:this.xmax,g=a.y+(c-a.x)/(b.x-a.x)*(b.y-a.y);else{g=b.y<=this.ymin?this.ymin:this.ymax;c=b.x<=this.xmin?this.xmin:this.xmax;var d=(c-a.x)/(b.x-a.x),k=(g-a.y)/(b.y-a.y);k>d?g=a.y+d*(b.y-a.y):c=a.x+k*(b.x-a.x)}return new h.Point(c,g)},e.prototype._pushLine=function(){this.line&&(1===this.type?0<this.line.length&&this.lines.push(this.line):2===this.type?1<this.line.length&&this.lines.push(this.line):3===this.type&&
3<this.line.length&&this.lines.push(this.line));this.line=[]},e.prototype._moveTo=function(a,b,c){3!==this.type?c&&(a=Math.round((a-(this.xmin+this.margin))*this.finalRatio),b=Math.round((b-(this.ymin+this.margin))*this.finalRatio),this.line.push(new h.Point(a,b))):(c||(a<this.xmin&&(a=this.xmin),a>this.xmax&&(a=this.xmax),b<this.ymin&&(b=this.ymin),b>this.ymax&&(b=this.ymax)),a=Math.round((a-(this.xmin+this.margin))*this.finalRatio),b=Math.round((b-(this.ymin+this.margin))*this.finalRatio),this.line.push(new h.Point(a,
b)),this._is_h=!1,this._is_v=!1)},e.prototype._lineTo=function(a,b,c){var g,d;if(3!==this.type)c?(a=Math.round((a-(this.xmin+this.margin))*this.finalRatio),b=Math.round((b-(this.ymin+this.margin))*this.finalRatio),0<this.line.length&&(g=this.line[this.line.length-1],g.equals(a,b)))||this.line.push(new h.Point(a,b)):this.line&&0<this.line.length&&this._pushLine();else if(c||(a<this.xmin&&(a=this.xmin),a>this.xmax&&(a=this.xmax),b<this.ymin&&(b=this.ymin),b>this.ymax&&(b=this.ymax)),a=Math.round((a-
(this.xmin+this.margin))*this.finalRatio),b=Math.round((b-(this.ymin+this.margin))*this.finalRatio),this.line&&0<this.line.length){g=this.line[this.line.length-1];c=g.x===a;var k=g.y===b;c&&k||(this._is_h&&c?(g.x=a,g.y=b,d=this.line[this.line.length-2],this._is_h=d.x===a,this._is_v=d.y===b):this._is_v&&k?(g.x=a,g.y=b,d=this.line[this.line.length-2],this._is_h=d.x===a,this._is_v=d.y===b):(this.line.push(new h.Point(a,b)),this._is_h=c,this._is_v=k))}else this.line.push(new h.Point(a,b))},e}();x.TileClipper=
u;u=function(){function e(){}return e.prototype.setExtent=function(a){this._ratio=4096===a?1:4096/a},e.prototype.reset=function(a){this.type=a;this.lines=[];this.line=null},e.prototype.moveTo=function(a,b){this.line&&this.lines.push(this.line);this.line=[];var c=this._ratio;this.line.push(new h.Point(Math.round(a*c),Math.round(b*c)))},e.prototype.lineTo=function(a,b){var c=this._ratio;this.line.push(new h.Point(Math.round(a*c),Math.round(b*c)))},e.prototype.close=function(){var a=this.line;a&&!a[0].isEqual(a[a.length-
1])&&a.push(a[0])},e.prototype.result=function(){return this.line&&this.lines.push(this.line),0===this.lines.length?null:(3===this.type&&1!==this._ratio&&y.simplify(64,this.lines),this.lines)},e}();x.SimpleBuilder=u;var y=function(){function e(){}return e.simplify=function(a,b){if(b){var c=-a,g=4096+a,d=-a,k=4096+a;a=[];for(var f=[],z=b.length,l=0;z>l;++l){var n=b[l];if(n&&!(2>n.length))for(var m=n[0],t=void 0,h=n.length,p=1;h>p;++p)t=n[p],m.x===t.x&&(m.x<=c&&(m.y>t.y?(a.push(l),a.push(p),a.push(0),
a.push(-1)):(f.push(l),f.push(p),f.push(0),f.push(-1))),m.x>=g&&(m.y<t.y?(a.push(l),a.push(p),a.push(1),a.push(-1)):(f.push(l),f.push(p),f.push(1),f.push(-1)))),m.y===t.y&&(m.y<=d&&(m.x<t.x?(a.push(l),a.push(p),a.push(2),a.push(-1)):(f.push(l),f.push(p),f.push(2),f.push(-1))),m.y>=k&&(m.x>t.x?(a.push(l),a.push(p),a.push(3),a.push(-1)):(f.push(l),f.push(p),f.push(3),f.push(-1)))),m=t}0!==a.length&&0!==f.length&&(e.fillParent(b,f,a),e.fillParent(b,a,f),c=[],e.calcDeltas(c,f,a),e.calcDeltas(c,a,f),e.addDeltas(c,
b))}},e.fillParent=function(a,b,c){for(var g=c.length,d=b.length,k=0;d>k;k+=4){for(var f=b[k],e=b[k+1],l=b[k+2],n=a[f][e-1],f=a[f][e],e=8092,m=-1,h=0;g>h;h+=4)if(c[h+2]===l){var r=c[h],p=c[h+1],q=a[r][p-1],r=a[r][p];switch(l){case 0:case 1:v.between(n.y,q.y,r.y)&&v.between(f.y,q.y,r.y)&&(q=Math.abs(r.y-q.y),e>q&&(e=q,m=h));break;case 2:case 3:v.between(n.x,q.x,r.x)&&v.between(f.x,q.x,r.x)&&(q=Math.abs(r.x-q.x),e>q&&(e=q,m=h))}}b[k+3]=m}},e.calcDeltas=function(a,b,c){for(var g=b.length,d=0;g>d;d+=
4){var k=e.calcDelta(d,b,c,[]);a.push(b[d]);a.push(b[d+1]);a.push(b[d+2]);a.push(k)}},e.calcDelta=function(a,b,c,g){a=b[a+3];if(-1===a)return 0;var d=g.length;return 1<d&&g[d-2]===a?0:(g.push(a),e.calcDelta(a,c,b,g)+1)},e.addDeltas=function(a,b){for(var c=a.length,g=0,d=0;c>d;d+=4){var e=a[d+3];e>g&&(g=e)}for(d=0;c>d;d+=4){var f=b[a[d]],h=a[d+1],e=g-a[d+3];switch(a[d+2]){case 0:f[h-1].x-=e;f[h].x-=e;break;case 1:f[h-1].x+=e;f[h].x+=e;break;case 2:f[h-1].y-=e;f[h].y-=e;break;case 3:f[h-1].y+=e,f[h].y+=
e}}a=b.length;for(c=0;a>c;++c)f=b[c],!f||2>f.length||f[f.length-1].x!==f[0].x&&f[f.length-1].y!==f[0].y&&f.push(f[0])},e}()});