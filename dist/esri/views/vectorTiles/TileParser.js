//>>built
define("require exports dojo/promise/all ../../core/promiseUtils ../../core/executeAsync ../../core/pbf ./SourceLayerData ./Feature ./BackgroundBucket ./FillBucket ./LineBucket ./SymbolBucket ./TileClipper".split(" "),function(Q,R,J,D,E,w,K,L,M,N,O,P,m){return function(){function c(a,b,e){this._pbfTile=new w(new Uint8Array(a),new DataView(a));this._tile=b;this._connection=e;this._layers=b.getLayers();e=b.tileKey.split("/").map(parseFloat);var c=e[0];a=e[1];e=e[2];this._level=c;b.refKey&&(b=b.refKey.split("/").map(parseFloat)[0],
b=c-b,0<b&&(c=(1<<b)-1,this._tileClipper=new m.TileClipper(b,a&c,e&c)));this._tileClipper||(this._tileClipper=new m.SimpleBuilder)}return c.prototype.parse=function(){for(var a,b=this,c=this._parseTileData(this._pbfTile),m=this._layers,f=m.length,F=this._level,h=[],n={},G=new Set,f=f-1;0<=f;f--)if(a=m[f],!(a.minzoom&&F<a.minzoom||a.maxzoom&&F>=a.maxzoom||a.layout&&"none"===a.layout.visibility))if(0!==a.type){var t=a.sourceLayer,p=c[t];if(p){G.add(t);var g=this._createBucket(a);g&&(g.layerIndex=f,
g.layerExtent=p.extent,(p=n[t])||(p=n[t]=[]),p.push(g))}}else g=this._createBucket(a),h.push(g);var w=10*(this._level+1),q=[],x=[],u=[],H=[],y=this._tileClipper,z=new Set,A={},B=[];G.forEach(function(b){return B.push(b)});var v=0,r=0,C=B.length;return E(function(){if(6===b._tile.status)return!0;switch(v){case 0:if(C>r){var a=B[r++],e=c[a],k=n[a];if(k&&0!==k.length)for(a=e.getData();a.next(2);){var l=new L(a.getMessage(),e),d=l.values;if(d&&(d=d._minzoom)&&d>=w)continue;for(var f=0,I=k;f<I.length;f++)d=
I[f],d.pushFeature(l)}}else{e=b._tile;for(a in n)for(k=n[a],l=0;l<k.length;l++)d=k[l],d.hasFeatures()&&(3===d.layer.type?(q.push(d),e.addBucket(d)):d.layer.refLayerId?u.push(d):(x.push(d),H[d.layer.id]=d));v=1;r=0;C=q.length}break;case 1:C>r?q[r++].getResources(y,z,A):v=2}return 2===v},50).then(function(){if(6===b._tile.status)return[];var a,c=[],e=b._tile.getWorkerTileHandler();0<z.size&&(a=e.fetchSprites(z,b._connection),c.push(a));var f,d;for(d in A)a=A[d],0<a.size&&(f=e.fetchGlyphs(b._tile.tileKey,
d,a,b._connection),c.push(f));return J(c).then(function(a){if(6===b._tile.status)return[];var c=0,d=0,e=x.length;return E(function(){if(6===b._tile.status)return!0;switch(c){case 0:if(e>d){var a=x[d++];a.processFeatures(y,b._tile);h.push(a)}else c=1,d=0,e=u.length;break;case 1:for(var f=0;f<u.length;f++){var a=u[f],g=H[a.layer.refLayerId];g&&(g.assignBufferInfo(a),h.push(a))}c=2;d=0;e=q.length;break;case 2:e>d?(a=q[d++],a.processFeatures(y,b._tile),h.push(a)):c=3}return 3===c},50).then(function(){return h.sort(function(a,
b){return a.layerIndex-b.layerIndex}),h})}).otherwise(function(a){return D.reject(Error(a))})}).otherwise(function(a){return D.reject(Error(a))})},c.prototype._parseTileData=function(a){for(var b={};a.next();)switch(a.tag()){case 3:var c=new K(a.getMessage());b[c.name]=c;break;default:a.skip()}return b},c.prototype._createBucket=function(a){switch(a.type){case 0:return this._createBackgroundBucket(a);case 1:return this._createFillBucket(a);case 2:return this._createLineBucket(a);case 3:return this._createSymbolBucket(a)}},
c.prototype._createBackgroundBucket=function(a){return new M(a,this._level)},c.prototype._createFillBucket=function(a){var b=this._tile;return new N(a,this._level,b.polygonVertexBuffer,b.polygonIndexBuffer,b.polygonOutlineVertexBuffer,b.polygonOutlineIndexBuffer)},c.prototype._createLineBucket=function(a){var b=this._tile;return new O(a,this._level,b.lineVertexBuffer,b.lineIndexBuffer)},c.prototype._createSymbolBucket=function(a){var b=this._tile;return new P(a,this._level,b.markerVertexBuffer,b.markerIndexBuffer,
b.textVertexBuffer,b.textIndexBuffer,b.placementEngine,b.getWorkerTileHandler())},c}()});