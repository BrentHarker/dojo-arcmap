//>>built
define("require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ./Bucket ./Geometry ./style/StyleLayer ./Placement ./GeometryUtils ./TextShaping dojox/string/BidiEngine".split(" "),function(D,N,G,O,H,B,E,F,v,I,J){function K(v,k){return v.iconMosaicItem&&k.iconMosaicItem?v.iconMosaicItem.page===k.iconMosaicItem.page?0:v.iconMosaicItem.page<k.iconMosaicItem.page?-1:1:v.iconMosaicItem&&!k.iconMosaicItem?1:!v.iconMosaicItem&&k.iconMosaicItem?-1:0}var L=function(){return function(){}}(),
M=function(){return function(v,k,a,d){this.line=k;this.shaping=v;this.iconMosaicItem=a;this.anchor=d}}();D=(function(){return function(){}}(),function(D){function k(a,d,g,c,b,e,f,h){a=D.call(this,a,d)||this;return a._markerRatio=1,a._markerMap=new Map,a._glyphMap=new Map,a._glyphBufferDataStorage=new Map,a._markerVertexBuffer=g,a._markerIndexBuffer=c,a._textVertexBuffer=b,a._textIndexBuffer=e,a._placementEngine=f,a._workerTileHandler=h,a}return G(k,D),Object.defineProperty(k.prototype,"markerPageMap",
{get:function(){return this._markerMap},enumerable:!0,configurable:!0}),Object.defineProperty(k.prototype,"glyphsPageMap",{get:function(){return this._glyphMap},enumerable:!0,configurable:!0}),Object.defineProperty(k.prototype,"textIndexStart",{get:function(){return this._textTriangleElementsStart},enumerable:!0,configurable:!0}),Object.defineProperty(k.prototype,"textIndexCount",{get:function(){return this._textTriangleElementsNum},enumerable:!0,configurable:!0}),Object.defineProperty(k.prototype,
"sdfMarker",{get:function(){return!1},enumerable:!0,configurable:!0}),k.prototype.copy=function(a,d,g,c,b){b=new k(this.layer,this.zoom,a,d,g,c,b,this._workerTileHandler);return b.layerIndex=this.layerIndex,b.layerExtent=this.layerExtent,b._markerVertexStart=a.index,b._markerTriangleElementsStart=d.index,b._textVertexStart=g.index,b._textTriangleElementsStart=c.index,b._markerTriangleElementsNum=0,b._textTriangleElementsNum=0,b._symbolInstances=this._symbolInstances,b._workerTileHandler=this._workerTileHandler,
b._font=this._font,b._textLayout=this._textLayout,b._markerLayout=this._markerLayout,b._isLinePlacement=this._isLinePlacement,b._avoidEdges=this._avoidEdges,b},k.prototype.getResources=function(a,d,g){var c=this.layer,b=this.zoom;a&&a.setExtent(this.layerExtent);for(var e=c.getLayoutValue("icon-image",b),f=c.getLayoutValue("text-field",b),h=c.getLayoutValue("text-font",b),c=c.getLayoutValue("text-transform",b),b=[],w=0,u=this._features;w<u.length;w++){var q=u[w],r=q.getGeometry(a);if(r&&0!==r.length){var l=
void 0;e&&(l=this._replaceKeys(e,q.values),l&&d.add(l));var m=void 0,t=!1;if(f){switch(m=this._replaceKeys(f,q.values),c){case 2:m=m.toLowerCase();break;case 1:m=m.toUpperCase()}k._bidiEngine.hasBidiChar(m)&&(t=void 0,t="rtl"===k._bidiEngine.checkContextual(m)?"IDNNN":"ICNNN",m=k._bidiEngine.bidiTransform(m,t,"VLYSN"),t=!0);q=m.length;if(0<q){var n=g[h];n||(n=g[h]=new Set);for(var p=0;q>p;p++){var v=m.charCodeAt(p);n.add(v)}}}if(l||m)q=new L,q.sprite=l,q.label=m,q.rtl=t,q.geometry=r,b.push(q)}}this._symbolFeatures=
b},k.prototype.processFeatures=function(a,d){a&&a.setExtent(this.layerExtent);var g,c=this.layer,b=this.zoom;d=this._isLinePlacement=1===c.getLayoutValue("symbol-placement",b);a=this._avoidEdges=c.getLayoutValue("symbol-avoid-edges",b)&&!d;var e=8*c.getLayoutValue("symbol-spacing",b),f=c.getLayoutValue("icon-image",b),h=c.getLayoutValue("text-field",b),w=this._workerTileHandler;f&&(this._markerLayout=new E.IconLayout(c,b,d),g=w.getSpriteItems());var u,q;if(h){var r=this._textLayout=new E.TextLayout(c,
b,d);u=void 0;r.font&&r.font.length&&(u=r.font[0],this._font=u);q=.5;switch(r.anchor){case 5:case 1:case 7:q=0;break;case 6:case 2:case 8:q=1}c=.5;switch(r.anchor){case 5:case 3:case 6:c=0;break;case 7:case 4:case 8:c=1}b=.5;switch(r.justify){case 0:b=0;break;case 2:b=1}var f=24*r.letterSpacing,h=d?0:24*r.maxWidth,l=24*r.lineHeight,r=[24*r.offset[0],24*r.offset[1]];u=w.getGlyphItems(u);q=new I(u,h,l,f,r,q,c,b)}this._markerVertexStart=this._markerVertexBuffer.index;this._markerTriangleElementsStart=
this._markerIndexBuffer.index;this._textVertexStart=this._textVertexBuffer.index;this._textTriangleElementsStart=this._textIndexBuffer.index;this._textTriangleElementsNum=this._markerTriangleElementsNum=0;this._markerMap.clear();this._glyphMap.clear();this._symbolInstances=w=[];c=this._textLayout;b=1;c&&c.size&&(b=c.size/24);f=c?c.maxAngle*v.C_DEG_TO_RAD:0;h=c?8*c.size:0;l=0;for(r=this._symbolFeatures;l<r.length;l++){var m=r[l],t=void 0;m.sprite&&(t=g[m.sprite]);var n=void 0,p=m.label,C=0;if(p&&(n=
q.getShaping(p,m.rtl),n&&0<n.length)){for(var C=1E30,p=-1E30,y=0,x=n;y<x.length;y++)var z=x[y],C=Math.min(C,z.x),p=Math.max(p,z.x);C=(p-C+48)*b*8}p=0;for(m=m.geometry;p<m.length;p++)for(y=m[p],z=void 0,d?(n&&0<n.length&&c&&c.size&&k._smoothVertices(y,8*c.size*(2+Math.min(2,4*Math.abs(c.offset[1])))),z=k._findAnchors(y,e,C)):z=[new F.Anchor(y[0].x,y[0].y)],x=0;x<z.length;x++){var A=z[x];0>A.x||4096<A.x||0>A.y||4096<A.y||d&&0<C&&0===c.rotationAlignment&&!k._honorsTextMaxAngle(y,A,C,f,h)||w.push(new M(n,
y,t,A))}}w.sort(K);for(g=0;g<w.length;g++)this._processFeature(w[g],u,a);this._addPlacedGlyphs()},k.prototype.updateSymbols=function(){this._markerVertexStart=this._markerVertexBuffer.index;this._markerTriangleElementsStart=this._markerIndexBuffer.index;this._textVertexStart=this._textVertexBuffer.index;this._textTriangleElementsStart=this._textIndexBuffer.index;this._textTriangleElementsNum=this._markerTriangleElementsNum=0;this._markerMap.clear();this._glyphMap.clear();for(var a=this._workerTileHandler.getGlyphItems(this._font),
d=this._avoidEdges,g=0,c=this._symbolInstances;g<c.length;g++)this._processFeature(c[g],a,d);this._addPlacedGlyphs()},k.prototype._replaceKeys=function(a,d){return a.replace(/{([^{}]+)}/g,function(a,c){return c in d?d[c]:""})},k.prototype._processFeature=function(a,d,g){var c=a.line,b=a.iconMosaicItem,e=a.shaping,f=a.anchor,h=(a=this._markerLayout)&&!!b,w=!0,u=1;h&&(u=a.size/(1/this._markerRatio)*8,w=a.optional||!b);var q=this._textLayout,r=q&&e&&0<e.length,l=1,m=l,t=!0;r&&(l=q.size/24,m=8*l,t=q.optional||
!e||0===e.length);var n,l=new B.Point(0,-17);if(h){if(n=this._placementEngine.getIconPlacement(f,b,u,c,a,g),n.footprint.minzoom===v.C_INFINITY&&!w)return;f.minzoom>n.footprint.minzoom&&(n.footprint.minzoom=f.minzoom)}var p;if(r&&(p=this._placementEngine.getTextPlacement(f,l,e,d,m,c,q,g))){if(p.footprint.minzoom===v.C_INFINITY&&!t)return;f.minzoom>p.footprint.minzoom&&(p.footprint.minzoom=f.minzoom)}if(!t&&!w||!w&&p&&p.footprint.minzoom!==v.C_INFINITY||!t&&n&&n.footprint.minzoom!==v.C_INFINITY)d=Math.max(n.footprint.minzoom,
p.footprint.minzoom),n.footprint.minzoom=d,p.footprint.minzoom=d;p&&p.footprint.minzoom!==v.C_INFINITY&&(q.ignorePlacement||this._placementEngine.add(p),this._storePlacedGlyphs(p.shapes,p.footprint.minzoom,this.zoom));n&&n.footprint.minzoom!==v.C_INFINITY&&(a.ignorePlacement||this._placementEngine.add(n),this._addPlacedIcons(n.shapes,n.footprint.minzoom,this.zoom,b.page))},k.prototype._addPlacedIcons=function(a,d,g,c){d=Math.max(g+v.log2(d),0);for(var b=this._markerVertexBuffer,e=this._markerIndexBuffer,
f=0;f<a.length;f++){var h=a[f],w=Math.max(g+v.log2(h.minzoom),d),u=Math.min(g+v.log2(h.maxzoom),25);if(!(w>=u)){var q=h.tl,r=h.tr,l=h.bl,m=h.br,t=h.mosaicRect,n=-h.labelAngle,h=h.anchor,p=b.index,k=t.x,y=t.y,x=k+t.width,t=y+t.height;b.add(h.x,h.y,q.x,q.y,k,y,n,w,u,d);b.add(h.x,h.y,r.x,r.y,x,y,n,w,u,d);b.add(h.x,h.y,l.x,l.y,k,t,n,w,u,d);b.add(h.x,h.y,m.x,m.y,x,t,n,w,u,d);e.add(p+0,p+1,p+2);e.add(p+1,p+2,p+3);this._markerMap.has(c)?this._markerMap.get(c)[1]+=6:this._markerMap.set(c,[this._markerTriangleElementsStart+
this._markerTriangleElementsNum/3,6]);this._markerTriangleElementsNum+=6}}},k.prototype._addPlacedGlyphs=function(){var a=this,d=this._textVertexBuffer,g=this._textIndexBuffer;this._glyphBufferDataStorage.forEach(function(c,b){for(var e=0;e<c.length;e++){var f=c[e],h=d.index;d.add(f.glyphAnchor[0],f.glyphAnchor[1],f.tl[0],f.tl[1],f.xmin,f.ymin,f.labelAngle,f.minLod,f.maxLod,f.placementLod);d.add(f.glyphAnchor[0],f.glyphAnchor[1],f.tr[0],f.tr[1],f.xmax,f.ymin,f.labelAngle,f.minLod,f.maxLod,f.placementLod);
d.add(f.glyphAnchor[0],f.glyphAnchor[1],f.bl[0],f.bl[1],f.xmin,f.ymax,f.labelAngle,f.minLod,f.maxLod,f.placementLod);d.add(f.glyphAnchor[0],f.glyphAnchor[1],f.br[0],f.br[1],f.xmax,f.ymax,f.labelAngle,f.minLod,f.maxLod,f.placementLod);g.add(h+0,h+1,h+2);g.add(h+1,h+2,h+3);a._glyphMap.has(b)?a._glyphMap.get(b)[1]+=6:a._glyphMap.set(b,[a._textTriangleElementsStart+a._textTriangleElementsNum/3,6]);a._textTriangleElementsNum+=6}});this._glyphBufferDataStorage.clear()},k.prototype._storePlacedGlyphs=function(a,
d,g){d=Math.max(g+v.log2(d),0);for(var c=0;c<a.length;c++){var b=a[c],e=Math.max(g+v.log2(b.minzoom),d),f=Math.min(g+v.log2(b.maxzoom),25);if(!(e>=f)){var h=b.tl,w=b.tr,k=b.bl,q=b.br,r=-b.labelAngle,l=b.anchor,m=b.mosaicRect;this._glyphBufferDataStorage.has(b.page)||this._glyphBufferDataStorage.set(b.page,[]);this._glyphBufferDataStorage.get(b.page).push({glyphAnchor:[l.x,l.y],tl:[h.x,h.y],tr:[w.x,w.y],bl:[k.x,k.y],br:[q.x,q.y],xmin:m.x,ymin:m.y,xmax:m.x+m.width,ymax:m.y+m.height,labelAngle:r,minLod:e,
maxLod:f,placementLod:d})}}},k._findAnchors=function(a,d,g){d+=g;for(var c=0,b=a.length-1,e=0;b>e;e++)c+=B.Point.distance(a[e],a[e+1]);e=g||d;if(e*=.5,e>=c)return[];g=e/c;d=c/Math.max(Math.round(c/d),1);for(var c=0,b=-d/2,f=[],h=a.length-1,e=0;h>e;e++){for(var k=a[e],u=a[e+1],q=u.x-k.x,r=u.y-k.y,l=Math.sqrt(q*q+r*r),m=void 0;c+l>b+d;){var b=b+d,t=(b-c)/l,n=v.interpolate(k.x,u.x,t),t=v.interpolate(k.y,u.y,t);void 0===m&&(m=Math.atan2(r,q));f.push(new F.Anchor(n,t,m,e,g))}c+=l}return f},k.deviation=
function(a,d,g){return Math.atan2((d.x-a.x)*(g.y-d.y)-(d.y-a.y)*(g.x-d.x),(d.x-a.x)*(g.x-d.x)+(d.y-a.y)*(g.y-d.y))},k._honorsTextMaxAngle=function(a,d,g,c,b){var e=0;g/=2;for(var f=new B.Point(d.x,d.y),h=d.segment+1;e>-g;){if(--h,0>h)return!1;e-=B.Point.distance(a[h],f);f=a[h]}e+=B.Point.distance(a[h],a[h+1]);d=[];for(var f=0,k=a.length;g>e;){var u=a[h],q=void 0;do{if(++h,h===k)return!1;q=a[h]}while(q.isEqual(u));var r=h,l=void 0;do{if(++r,r===k)return!1;l=a[r]}while(l.isEqual(q));u=this.deviation(u,
q,l);d.push({deviation:u,distToAnchor:e});for(f+=u;e-d[0].distToAnchor>b;)f-=d.shift().deviation;if(Math.abs(f)>c)return!1;e+=B.Point.distance(q,l)}return!0},k._smoothVertices=function(a,d){if(!(0>=d)){var g=a.length;if(!(3>g)){var c=[],b=0;c.push(0);for(var e=1;g>e;e++)b+=B.Point.distance(a[e],a[e-1]),c.push(b);d=Math.min(d,.2*b);b=[];b.push(a[0].x);b.push(a[0].y);var f=a[g-1].x,h=a[g-1].y,e=B.Point.sub(a[0],a[1]);e.normalize();a[0].x+=d*e.x;a[0].y+=d*e.y;e.assignSub(a[g-1],a[g-2]);e.normalize();
a[g-1].x+=d*e.x;a[g-1].y+=d*e.y;for(e=1;g>e;e++)c[e]+=d;c[g-1]+=d;for(var k=.5*d,e=1;g-1>e;e++){for(var u=0,q=0,r=0,l=e-1;0<=l&&!(c[l+1]<c[e]-k);l--){var m=k+c[l+1]-c[e],t=c[l+1]-c[l],n=c[e]-c[l]<k?1:m/t;if(1E-6>Math.abs(n))break;var p=n*n,v=n*m-.5*p*t,y=n*t/d,x=a[l+1],z=a[l].x-x.x,A=a[l].y-x.y,u=u+y/v*(x.x*n*m+.5*p*(m*z-t*x.x)-p*n*t*z/3),q=q+y/v*(x.y*n*m+.5*p*(m*A-t*x.y)-p*n*t*A/3),r=r+y}for(l=e+1;g>l&&!(c[l-1]>c[e]+k);l++){m=k-c[l-1]+c[e];t=c[l]-c[l-1];n=c[l]-c[e]<k?1:m/t;if(1E-6>Math.abs(n))break;
p=n*n;v=n*m-.5*p*t;y=n*t/d;x=a[l-1];z=a[l].x-x.x;A=a[l].y-x.y;u+=y/v*(x.x*n*m+.5*p*(m*z-t*x.x)-p*n*t*z/3);q+=y/v*(x.y*n*m+.5*p*(m*A-t*x.y)-p*n*t*A/3);r+=y}b.push(u/r);b.push(q/r)}b.push(f);b.push(h);for(l=e=0;g>e;e++)a[e].x=b[l++],a[e].y=b[l++]}}},k}(H));return D._bidiEngine=new J,D});