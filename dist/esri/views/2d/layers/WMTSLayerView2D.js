//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/ObjectPool ../../../core/HandleRegistry ./LayerView2D ../engine/Bitmap ../engine/BitmapSource ../engine/BitmapContainer ../engine/Canvas2DContainer ../engine/Tiled ../../../geometry/support/webMercatorUtils ../tiling/TileStrategy ../tiling/TileKey ../tiling/TileInfoView ../tiling/TileQueue".split(" "),function(f,D,l,m,g,n,p,q,r,t,u,v,w,x,y,z,A,
B){var h=function(d){function b(a){a=d.call(this,a)||this;return a.key=new z(0,0,0,0),a}return l(b,d),b.prototype.acquire=function(a){},b.prototype.release=function(){this.key.set(0,0,0,0)},b}(w(r));h.pool=new n(h,!0);var C=[102113,102100,3857,3785,900913];f=function(d){function b(){var a=null!==d&&d.apply(this,arguments)||this;return a._handles=new p,a._tileStrategy=null,a._tileInfoView=null,a._fetchQueue=null,a._tileRequests=new Map,a.container=new v,a.layer=null,a}return l(b,d),b.prototype.hitTest=
function(a,e){return null},b.prototype.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=a.state;this._tileStrategy.update(a);this._fetchQueue.resume();this.notifyChange("updating")},b.prototype.attach=function(){var a,e=this,c=this.layer.activeLayer,b=this.layer.findSublayerById(c.id).clone();c.tileMatrixSetId?a=b.tileMatrixSets.find(function(a){return a.id===c.tileMatrixSetId}):(a=this._getTileMatrixSetBySpatialReference(b),c.tileMatrixSetId=a.id);var k=a.tileInfo.spatialReference,
b=c.fullExtent||b.fullExtent&&b.fullExtent;102100===k.wkid||102113===k.wkid?b=x.geographicToWebMercator(b):4326!==k.wkid&&(b=a.fullExtent);this._tileContainer=new u;this.container.addChild(this._tileContainer);this._tileInfoView=new A(a.tileInfo,b);this._fetchQueue=new B({tileInfoView:this._tileInfoView,process:function(a){return e.fetchTile(a)}});this._tileStrategy=new y({cachePolicy:"keep",acquireTile:function(a){return e.acquireTile(a)},releaseTile:function(a){return e.releaseTile(a)},tileInfoView:this._tileInfoView});
this._handles.add(c.watch("styleId",function(a){e.refresh()}));this._handles.add(this.layer.watch("activeLayer",function(a){if(!a.tileMatrixSetId){var b=e._getTileMatrixSetBySpatialReference(e.layer.activeLayer);a.tileMatrixSetId=b.id}e.refresh()}))},b.prototype.detach=function(){this._handles.removeAll();this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeChild(this._tileContainer);this._fetchQueue=this._tileStrategy=this._tileInfoView=this._tileContainer=null},b.prototype.moveStart=
function(){this.requestUpdate()},b.prototype.viewChange=function(){this.requestUpdate()},b.prototype.moveEnd=function(){this.requestUpdate()},b.prototype.refresh=function(){var a=this;this._fetchQueue.reset();this._tileStrategy.tiles.forEach(function(b){if(b.source){b.source=null;var c=a._fetchQueue.push(b.key).then(function(a){b.source=a;b.requestRender()});a._tileRequests.set(b,c)}})},b.prototype.getTileBounds=function(a,b){return this._tileStrategy.tileInfoView.getTileBounds(a,b)},b.prototype.getTileCoords=
function(a,b){return this._tileStrategy.tileInfoView.getTileCoords(a,b)},b.prototype.getTileResolution=function(a){return this._tileStrategy.tileInfoView.getTileResolution(a)},b.prototype.acquireTile=function(a){var b=this,c=h.pool.acquire();c.key.set(a);this._tileInfoView.getTileCoords(c.coords,c.key);c.resolution=this._tileInfoView.getTileResolution(c.key);a=this._tileInfoView.tileInfo.size;c.width=a[0];c.height=a[1];a=this._fetchQueue.push(c.key).then(function(a){c.source=a;c.once("attach",function(){return b.requestUpdate()});
b._tileContainer.addChild(c)});return this._tileRequests.set(c,a),this.requestUpdate(),c},b.prototype.releaseTile=function(a){var b=this._tileRequests.get(a);b.isFulfilled()||b.cancel();this._tileRequests["delete"](a);this._tileContainer.removeChild(a);this.requestUpdate()},b.prototype.fetchTile=function(a){var b=this;return this.layer.fetchTile(a.level,a.row,a.col).then(function(c){c=t.pool.acquire(c);return c.coords=b.getTileCoords(c.coords,a),c.resolution=b.getTileResolution(a),c})},b.prototype._getTileMatrixSetBySpatialReference=
function(a){var b=this.view.spatialReference,c=b.wkid,d=a.tileMatrixSets.find(function(a){return a.tileInfo.spatialReference.wkid===c});return!d&&b.isWebMercator&&(d=a.tileMatrixSets.find(function(a){return-1<C.indexOf(a.tileInfo.spatialReference.wkid)})),d},b}(g.declared(q));return m([g.property({dependsOn:["updateRequested","attached"]})],f.prototype,"updating",void 0),f=m([g.subclass("esri.views.2d.layers.WMTSLayerView2D")],f)});