//>>built
define("require ../core/promiseUtils dojo/_base/array dojo/on dojo/Deferred dojo/promise/all ../layers/support/layerUtils ../geometry/support/scaleUtils ../geometry/Extent ../tasks/support/Query ../layers/GroupLayer ../core/Accessor".split(" "),function(H,x,l,D,z,I,E,F,J,K,G,L){var A;return L.createSubclass({declaredClass:"esri.views.PopupManager",properties:{map:{dependsOn:["view.map"],readOnly:!0}},constructor:function(){this._featureLayersCache={}},destroy:function(){this._featureLayersCache={};
this.view=null},_clickHandle:null,_featureLayersCache:null,enabled:!1,_enabledSetter:function(b){this._clickHandle&&(b?this._clickHandle.resume():this._clickHandle.pause());this._set("enabled",b)},_mapGetter:function(){return this.get("view.map")||null},view:null,_viewSetter:function(b){this._clickHandle&&(this._clickHandle.remove(),this._clickHandle=null);b&&(this._clickHandle=D.pausable(b,"click",this._clickHandler.bind(this)),this.enabled||this._clickHandle.pause());this._set("view",b)},getMapLayer:function(b){var a;
if(b&&(a=b.findLayerById())&&(b=a.id,this._featureLayersCache[b])){var d=b.lastIndexOf("_");-1<d&&(b=b.substring(0,d),a=this.map.findLayerById(b))}return a},_closePopup:function(){var b=this.get("view.popup");b&&(b.clear(),b.close())},_showPopup:function(b,a){function d(a){return e.allLayerViews.find(function(y){return y.layer===a})}function f(a){if(null==a)return!1;var b=d(a);return null==b?!1:a.loaded&&!b.suspended&&(a.popupEnabled&&a.popupTemplate||"graphics"===a.type||b.getPopupData)}function B(a){return(a=
d(a))&&a.hasDraped}var e=this.view,u=e.popup,r=this,p=[],c="3d"===e.type;if(l.forEach(this.map.layers.toArray(),function(a){a.isInstanceOf(G)?l.forEach(a.layers.toArray(),function(a){!f(a)||c&&!B(a)||p.push(a)}):!f(a)||c&&!B(a)||p.push(a)}),0<e.graphics.length&&p.push(e.graphics),!a||a.popupTemplate||f(a.layer)||(a=null),!p.length&&!a)return void r._closePopup();var g=[],q=!!a,v=r._calculateClickTolerance(p),k=b.mapPoint;if(!k)return void r._closePopup();var w=1;e.state&&(w=e.state.resolution);var h=
e.basemapTerrain;h&&h.overlayManager&&(w=h.overlayManager.overlayPixelSizeInMapUnits(k));v*=w;h&&!h.spatialReference.equals(e.spatialReference)&&(v*=F.getUnitValueForSR(h.spatialReference)/F.getUnitValueForSR(e.spatialReference));var h=k.clone().offset(-v,-v),k=k.clone().offset(v,v),n=new J(Math.min(h.x,k.x),Math.min(h.y,k.y),Math.max(h.x,k.x),Math.max(h.y,k.y),e.spatialReference),k=function(c){var f;if("imagery"===c.type){f=new K;f.geometry=b.mapPoint;var g=d(c),e={rasterAttributeTableFieldPrefix:"Raster.",
returnDomainValues:!0};e.layerView=g;f=c.queryVisibleRasters(f,e).then(function(a){return q=q||0<a.length,a})}else if("csv"===c.type||!r._featureLayersCache[c.id]&&"function"!=typeof c.queryFeatures){if("map-image"===c.type)return g=d(c),g.getPopupData(n);var h,k=[];"esri.core.Collection\x3cesri.Graphic\x3e"===c.declaredClass?(e=c,h=!0):"graphics"===c.type?(e=c.graphics,h=!0):(g=d(c),e=g&&g.loadedGraphics,h=!1);e&&(k=e.filter(function(a){return a&&(!h||a.popupTemplate)&&a.visible&&n.intersects(a.geometry)}).toArray());
0<k.length&&(q=!0,f="scene"===c.type?r._fetchSceneAttributes(c,k):x.resolve(k))}else g=c.createQuery(),g.geometry=n,f=c.queryFeatures(g).then(function(b){b=b.features;if(a&&a.layer===c&&c.objectIdField){var d=c.objectIdField,f=a.attributes[d];b=b.filter(function(a){return a.attributes[d]!==f})}return q=q||0<b.length,b});return f};if(c&&!a||!c)var g=p.map(k).filter(function(a){return!!a}),t=function(a){return a.reduce(function(a,c){return a.concat(c.items?t(c.items):c)},[])},g=t(g);a&&(a.layer&&"scene"===
a.layer.type?g.unshift(this._fetchSceneAttributes(a.layer,[a])):a.getEffectivePopupTemplate()&&(k=new z,g.unshift(k.resolve([a]))));return l.some(g,function(a){return!a.isFulfilled()})||q?void(g.length&&u.open({promises:g,location:b.mapPoint})):void r._closePopup()},_fetchSceneAttributes:function(b,a){return this.view.whenLayerView(b).then(function(d){var f=this._getOutFields(b.popupTemplate),l=a.map(function(a){return d.whenGraphicAttributes(a,f).otherwise(function(){return a})});return x.eachAlways(l)}.bind(this)).then(function(a){return a.map(function(a){return a.value})})},
_getSubLayerFeatureLayers:function(b,a){var d=a||new z,f=[];a=b.length;var B=Math.floor(this.view.extent.width/this.view.width),e=this.view.scale,u=!1,r=this,p=0;a:for(;a>p;p++){var c=b[p],g=c.dynamicLayerInfos||c.layerInfos;if(g){var q=null;c._params&&(c._params.layers||c._params.dynamicLayers)&&(q=c.visibleLayers);for(var q=E._getVisibleLayers(g,q),v=E._getLayersForScale(e,g),k=g.length,w=0;k>w;w++){var h=g[w],n=h.id,t=c.popupTemplates[n];if(!h.subLayerIds&&t&&t.popupTemplate&&-1<l.indexOf(q,n)&&
-1<l.indexOf(v,n)){if(!A){u=!0;break a}var y=c.id+"_"+n,m=this._featureLayersCache[y];m&&m.loadError||(m||((m=t.layerUrl)||(m=h.source?this._getLayerUrl(c.url,"/dynamicLayer"):this._getLayerUrl(c.url,n)),m=new A(m,{id:y,drawMode:!1,mode:A.MODE_SELECTION,outFields:this._getOutFields(t.popupTemplate),resourceInfo:t.resourceInfo,source:h.source}),this._featureLayersCache[y]=m),m.setDefinitionExpression(c.layerDefinitions&&c.layerDefinitions[n]),m.setGDBVersion(c.gdbVersion),m.popupTemplate=t.popupTemplate,
m.setMaxAllowableOffset(B),m.setUseMapTime(!!c.useMapTime),c.layerDrawingOptions&&c.layerDrawingOptions[n]&&c.layerDrawingOptions[n].renderer&&m.setRenderer(c.layerDrawingOptions[n].renderer),f.push(m))}}}}if(u){var x=new z;H(["../layers/FeatureLayer"],function(a){A=a;x.resolve()});x.then(function(){r._getSubLayerFeatureLayers(b,d)})}else{var C=[];l.forEach(f,function(a){if(!a.loaded){var c=new z;D.once(a,"load, error",function(){c.resolve()});C.push(c.promise)}});C.length?I(C).then(function(){f=
l.filter(f,function(a){return!a.loadError&&a.isVisibleAtScale(e)});d.resolve(f)}):(f=l.filter(f,function(a){return a.isVisibleAtScale(e)}),d.resolve(f))}return d.promise},_getLayerUrl:function(b,a){var d=b.indexOf("?");return-1===d?b+"/"+a:b.substring(0,d)+"/"+a+b.substring(d)},_getOutFields:function(b){var a;return"esri.PopupTemplate"===b.declaredClass&&b.fieldInfos?(a=[],l.forEach(b.fieldInfos,function(b){var d=b.fieldName&&b.fieldName.toLowerCase();d&&"shape"!==d&&0!==d.indexOf("relationships/")&&
a.push(b.fieldName)})):a=["*"],a},_calculateClickTolerance:function(b){var a=6;return l.forEach(b,function(b){if(b=b.renderer)"simple"===b.type?((b=b.symbol)&&b.xoffset&&(a=Math.max(a,Math.abs(b.xoffset))),b&&b.yoffset&&(a=Math.max(a,Math.abs(b.yoffset)))):"uniqueValue"!==b.type&&"classBreaks"!==b.type||l.forEach(b.uniqueValueInfos||b.classBreakInfos,function(b){(b=b.symbol)&&b.xoffset&&(a=Math.max(a,Math.abs(b.xoffset)));b&&b.yoffset&&(a=Math.max(a,Math.abs(b.yoffset)))})}),a},_clickHandler:function(b){function a(a){return d.allLayerViews.find(function(b){return b.layer===
a})}var d=this.view,f=d.popup,l=d.map,e=b.screenPoint,u=this;if(0===b.button&&f&&d.ready){var r="3d"===d.type,p=l.allLayers.some(function(b){if(b.isInstanceOf(G))b=!1;else{var c;null==b?c=!1:(c=a(b),c=null==c?!1:b.loaded&&!c.suspended&&(b.popupEnabled&&b.popupTemplate||"graphics"===b.type||c.getPopupData));!(c=!c)&&(c=r)&&(b=a(b),c=!(b&&b.hasDraped));b=c?!1:!0}return b});return null!=e?void this.view.hitTest(e.x,e.y).then(function(a){p||0<a.results.length?u._showPopup(b,0<a.results.length?a.results[0].graphic:
null):u._closePopup()}):void u._showPopup(b)}}})});