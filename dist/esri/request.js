//>>built
define("require dojo/_base/config dojo/Deferred dojo/_base/lang dojo/_base/url dojo/request dojo/io-query dojo/when ./kernel ./config ./core/global ./core/sniff ./core/lang ./core/urlUtils ./core/deferredUtils ./core/promiseUtils dojo/has!host-browser?dojo/io/script dojo/has!host-webworker?./core/workers/request".split(" "),function(S,y,D,l,H,z,A,T,m,U,V,k,B,n,W,I,X,J){function Y(a){var c=A.objectToQuery(a.content);if(c&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+c),2E3<a.url.length)return I.reject(l.mixin(Error(),
{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));var b=new Image;a.allowImageDataAccess&&(a.withCredentials?b.crossOrigin="use-credentials":b.crossOrigin="anonymous");var f=!1,d=new D(function(a){f=!0;b.onload=b.onerror=b.onabort=null;b.src=""}),c=function(a){b.onload=b.onerror=b.onabort=null;f||d.reject(a)};return b.onload=function(){b.onload=b.onerror=b.onabort=null;f||d.resolve(this)},b.onerror=c,b.onabort=c,b.alt="",b.src=a.url,d.promise}function F(a){return a=
new H(a),(a.host+(a.port?":"+a.port:"")).toLowerCase()}function K(a,c){var b=!!a.useProxy,f=a.method||"auto",d=B.isDefined(a.crossOrigin)?a.crossOrigin:h.useCors;a=l.mixin({},a);a._ssl&&(a.url=a.url.replace(/^http:/i,"https:"));var E=a.content,q=a.url;a.load=function(a){var b;return a&&(a.error?(b=l.mixin(Error(),a.error),b.log=!!y.isDebug):"error"===a.status&&(b=l.mixin(Error(),a),b.log=!!y.isDebug),b&&!B.isDefined(b.httpCode)&&(b.httpCode=b.code)),b||a};a.error=function(a,b){return b&&b.xhr&&b.xhr.abort(),
a instanceof Error||(a=l.mixin(Error(),a)),a.log=!!y.isDebug,a};a._token&&(a.content=a.content||{},a.content.token=a._token);var g,v=0;q&&(g=A.objectToQuery(E),v=g.length+q.length+1,k("esri-url-encodes-apostrophe")&&(v=g.replace(/'/g,"%27").length+q.length+1));a.timeout=B.isDefined(a.timeout)?a.timeout:h.timeout;a.handleAs=a.handleAs||"json";try{var p,t,C=d&&n.canUseXhr(a.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(a.url),w=n.hasSameOrigin(a.urlObj,n.appUrl)||C,u="post"===f||!!a.body||
v>h.maxUrlLength,L=!w&&-1!==a.handleAs.indexOf("json")&&a.callbackParamName&&!a.body,r=!!n.getProxyRule(a.url)||h.forceProxy||b||("image"!==a.handleAs||a.allowImageDataAccess)&&(!L||u)&&!w;if((k("host-browser")||k("host-webworker"))&&r)if(p=n.getProxyUrl(q,d),t=p.path,p._xo&&(C=!0),!u&&t.length+1+v>h.maxUrlLength&&(u=!0),a.url=t+"?"+q,u)a.content=l.mixin(p.query||{},E);else{var M=A.objectToQuery(l.mixin(p.query||{},E));M&&(a.url+=(-1===q.indexOf("?")?"?":"\x26")+M);a.content=null}if((k("host-browser")||
k("host-webworker"))&&L&&!u)return!B.isDefined(a.isAsync)&&4>k("ff")&&(a.isAsync=!0),X.get(x?x(a):a);var e=a.headers;if(!k("host-browser")&&!k("host-webworker")||e&&e.hasOwnProperty("X-Requested-With")||(e=a.headers=e||{},e["X-Requested-With"]=null),k("host-browser")&&c){var N=a.content&&a.content.token;N&&c.set("token",N);a.contentType=!1}if(C&&!a.hasOwnProperty("withCredentials")&&"with-credentials"===h.useCors){var b=r?t:q,G=n.getCorsConfig(b);if(G&&G.hasOwnProperty("withCredentials"))G.withCredentials&&
(a.withCredentials=!0);else if(m.id){var O=m.id.findServerInfo(b);O&&O.webTierAuth&&(a.withCredentials=!0)}}return a=x?x(a):a,"image"===a.handleAs?Y(a):u?(a.body?(a.data=c||a.body,a.query=a.content):a.data=a.content,delete a.body,delete a.content,!r&&k("safari")&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+"_ts\x3d"+(new Date).getTime()+aa++),z.post(a.url,a)):(a.query=a.content,delete a.content,z.get(a.url,a))}catch(Z){return c=new D,c.reject(a.error(Z)),c}}function P(a){var c=h.corsStatus,b=n.getCorsConfig(a,
!0);return-1<b&&h.corsEnabledServers.splice(b,1),c[F(a)]=1,b}function Q(a){var c=h.corsStatus;try{var b=F(a.url);if(h.corsDetection&&h.useCors&&k("esri-cors")&&a.url&&-1!==a.url.toLowerCase().indexOf("/rest/services")&&!n.hasSameOrigin(a.urlObj,n.appUrl)&&!n.canUseXhr(a.urlObj)){if(c[b])return c[b];var f=new D;c[b]=f.promise;var d=a.url.substring(0,a.url.toLowerCase().indexOf("/rest/")+6)+"info";return z.get(d,{query:{f:"json"},handleAs:"json",headers:{"X-Requested-With":null},timeout:1E3*h.corsDetectionTimeout}).then(function(c){c?
(n.canUseXhr(a.url)||h.corsEnabledServers.push(b),f.resolve()):f.reject()},function(a){f.reject()}),f.promise}}catch(E){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}}function w(a,c,b,f){function d(a){if(a._pendingDfd=K(b,t),!a._pendingDfd){a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;var c=Error("Deferred object is missing");return c.log=!!y.isDebug,a.reject(c),void(a._pendingDfd=null)}var d=!!a._pendingDfd.response;(a._pendingDfd.response||a._pendingDfd).then(function(a){if(!d||
!a.data)return a;var b=a.getHeader("Content-Type");if(b&&(b=b.toLowerCase(),-1===b.indexOf("text/plain")&&-1===b.indexOf("application/json")))return a;b=a.data;if(b instanceof ArrayBuffer&&750>=b.byteLength)b=new Blob([b]);else if(!(b instanceof Blob&&750>=b.size))return a;var c=new D,e=new FileReader;return e.readAsText(b),e.onloadend=function(){if(!e.error)try{var b=JSON.parse(e.result);b.error&&(Object.isExtensible(a)||(a=l.mixin({},a)),a._jsonData=b)}catch(da){}c.resolve(a)},c.promise}).then(function(b){var c=
d?b.data:b,r=d?b.getHeader.bind(b):ba,e=null;if(a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs,c)if(b=d&&b._jsonData||c,b.error?(e=l.mixin(Error(),b.error),e.log=!!y.isDebug):"error"===b.status&&(e=l.mixin(Error(),b),e.log=!!y.isDebug),e&&!B.isDefined(e.httpCode)&&(e.httpCode=e.code),e)throw e;a.resolve({data:c,url:f.url,requestOptions:f.requestOptions,getHeader:r});a._pendingDfd=null}).otherwise(function(c){var r,d,e;if(c&&(r=c.code,d=c.subcode,e=c.messageCode,e=e&&e.toUpperCase()),c&&403==r&&(4==
d||c.message&&-1<c.message.toLowerCase().indexOf("ssl")&&-1===c.message.toLowerCase().indexOf("permission"))){if(!b._ssl)return b._ssl=b._sslFromServer=!0,void w(a,!0,b,f)}else if(c&&415==c.status){if(P(b.url),!b._err415)return b._err415=1,void w(a,!0,b,f)}else if(m.id&&m.id._errorCodes&&-1!==m.id._errorCodes.indexOf(r)&&!m.id._isPublic(b.url)&&!q&&(403!=r||R&&-1===R.indexOf(e)&&(!B.isDefined(d)||2==d&&b._token)))return void ca(a,b,f,c);a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;a.reject(c);a._pendingDfd=
null})}var g=b.body,q=b.disableIdentityLookup,x=b._preLookup,v=!1;if(k("esri-workers")&&!1!==h.useWorkers)if(!0===b.useWorkers||!0===h.useWorkers)v=!0;else if(b.workerOptions){var p=b.workerOptions;(p.callback||p.worker&&p.worker.worker instanceof Worker)&&(v=!0)}var t=null;((p=g instanceof FormData)||g&&g.elements)&&(t=p?g:new FormData(g));var C=!!(-1!==b.url.toLowerCase().indexOf("token\x3d")||b.content&&b.content.token||t&&t.get("token"));if(!c){a.then(function(a){if((/\/sharing\/rest\/accounts\/self/i.test(b.url)||
/\/sharing\/rest\/portals\/self/i.test(b.url))&&!C&&!b._token&&a.user&&a.user.username){var c=h.corsEnabledServers,d=n.getCorsConfig(b.url,!0),e={host:F(b.url),withCredentials:!0};if(-1===d)c.push(e);else{var f=c[d];"object"==typeof f?f.withCredentials=!0:c.splice(d,1,e)}}if(c=b._credential){var g;(d=(d=m.id.findServerInfo(c.server))&&d.owningSystemUrl)&&(d=d.replace(/\/?$/,"/sharing"),g=m.id.findCredential(d,c.userId),g&&-1===m.id._getIdenticalSvcIdx(d,g)&&g.resources.splice(0,0,d))}return a}).always(function(a){delete b._credential;
a&&(a.ssl=!!b._ssl)});var A=b.load,u=b.error;A&&a.then(function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return A.call(c&&c.args,b,c)});u&&a.then(null,function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return u.call(c&&c.args,b,c)})}!m.id||C||b._token||m.id._isPublic(b.url)||q&&!x||(c=m.id.findCredential(b.url))&&(b._token=c.token,b._ssl=c.ssl);return v?b.workerOptions&&b.workerOptions.worker?(z=b.workerOptions.worker,d(a)):S(["./workers/RequestClient"],function(c){if(b.workerOptions){var f=b.workerOptions;
z=c.getClient(f.callback,f.cbFunction)}else z=c.getClient();d(a)}):d(a),a.promise}function ca(a,c,b,f){a._pendingDfd=m.id.getCredential(c.url,{token:c._token,error:f});a._pendingDfd.then(function(d){c._token=d.token;c._credential=d;c._ssl=c._sslFromServer||d.ssl;w(a,!0,c,b)}).otherwise(function(b){a.reject(b);a._pendingDfd=null})}function g(a,c){if(J&&V.invokeStaticMessage)return J.execute(a,c);"string"!=typeof a&&console.error("esri/request: the first parameter should be a url string");var b=l.mixin({},
c),f={url:a,requestOptions:l.mixin({},c)};if(b.content=b.query,delete b.query,b.preventCache=!!b.cacheBust,delete b.cacheBust,b.handleAs=b.responseType,delete b.responseType,"array-buffer"===b.handleAs&&(b.handleAs="arraybuffer"),"image"===b.handleAs){if(k("host-webworker")||k("host-node"))return I.reject(l.mixin(Error(),{message:"The responseType 'image' is not supported in Web Workers or Node environment."}));b.preventCache&&(b.content=b.content||{},b.content["request.preventCache"]=Date.now());
b.method="auto"}b.url=n.normalize(a);b.urlObj=new H(b.url);var d=W.makeDeferredCancellingPending();return T(Q(b)).always(function(){w(d,!1,b,f)}),d.promise}var x,h=U.request,R=["COM_0056","COM_0057"],aa=0,ba=function(){return null};return g._makeRequest=K,g._processRequest=w,g._disableCors=P,g._detectCors=Q,g.setRequestPreCallback=function(a){x=a},g});